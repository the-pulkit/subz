<!--
Copyright 2015 Google Inc. All rights reserved.

Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at

      http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed
under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
CONDITIONS OF ANY KIND, either express or implied. See the License for the
specific language governing permissions and limitations under the License.
-->
<link rel="import" href="../../components/polymer/polymer.html">

<link rel="import" href="../../components/core-a11y-keys/core-a11y-keys.html">
<link rel="import" href="../santa-tracker-router.html">
<link rel="import" href="../preloader/preload-overlay.html">
<link rel="import" href="../calendar/calendar-nav.html">
<link rel="import" href="../lazy-pages.html">

<link rel="import" href="dependencies.html">

<!--
Santa Track app.

@element santa-app
-->
<polymer-element name="santa-app" tabindex="0">
<template>
  <!-- keyboard handler -->
  <core-a11y-keys target="{{}}" keys="esc" on-keys-pressed="{{keyHandler}}"></core-a11y-keys>

  <!-- Route controller -->
  <santa-tracker-router route="{{route}}" sceneParams="{{sceneParams}}" autoHash></santa-tracker-router>

  <!-- Preloading scene overlay -->
  <preload-overlay id="preloader" value="{{selectedScene.preloadProgress || 0}}"
                   active?="{{selectedScene && !selectedScene.loaded}}"></preload-overlay>

  <lazy-pages id="lazypages" selected="{{route}}" selectedItem="{{selectedScene}}" valueattr="route"
              santaApp="{{}}" preloader="{{$.preloader}}">

    <template if="{{mode != 'cast'}}">
      <calendar-nav route="calendar" alwaysActive
                    houses="{{houses}}" santaApp="{{}}" mode="{{mode}}"></calendar-nav>
    </template>

    <village-scene route="village"
        path="scenes/village/village-scene_[[language]].html"
        mode="{{mode}}" hidden></village-scene>

    <airport-scene route="airport"
        path="scenes/airport/airport-scene_[[language]].html"
        hidden></airport-scene>

    <boatload-scene route="boatload"
        path="scenes/boatload/boatload-scene_[[language]].html"
        loadingBgColor="#8fd7f7"
        loadingSrc="scenes/boatload/img/loading.svg" hidden></boatload-scene>

    <briefing-scene route="briefing"
        path="scenes/briefing/briefing-scene_[[language]].html"
        hidden></briefing-scene>

    <callfromsanta-scene route="callfromsanta"
        path="scenes/callfromsanta/callfromsanta-scene_en.html"
        loadingBgColor="'rgb(129,208,0)" hidden></callfromsanta-scene>

    <citylights-scene route="citylights"
        path="scenes/citylights/citylights-scene_[[language]].html"
        loadingBgColor="#8FD7F7"
        loadingSrc="scenes/citylights/img/loading.svg" hidden></citylights-scene>

    <codelab-scene route="codelab"
        path="scenes/codelab/codelab-scene_[[language]].html"
        loadingBgColor="#3F4EA1"
        loadingSrc="scenes/codelab/img/loading.svg" hidden></codelab-scene>

    <commandcentre-scene route="commandcentre"
        path="scenes/commandcentre/commandcentre-scene_en.html"
        loadingBgColor="rgb(129,208,0)" hidden></commandcentre-scene>

    <factory-scene route="factory"
        path="scenes/factory/factory-scene_[[language]].html"
        loadingBgColor="rgb(129,208,0)" hidden></factory-scene>

    <glider-scene route="glider"
        path="scenes/glider/glider-scene_[[language]].html"
        loadingBgColor="#8d23a9"
        loadingSrc="scenes/glider/img/loading.svg" hidden></glider-scene>

    <gumball-scene route="gumball"
        path="scenes/gumball/gumball-scene_[[language]].html"
        loadingBgColor="#8d23a9"
        loadingSrc="scenes/gumball/img/loading.svg" hidden></gumball-scene>

    <jamband-scene route="jamband"
        path="scenes/jamband/jamband-scene_[[language]].html"
        loadingBgColor="#fdbe27"
        loadingSrc="scenes/jamband/img/loading.svg" hidden></jamband-scene>

    <jetpack-scene route="jetpack"
        path="scenes/jetpack/jetpack-scene_[[language]].html"
        loadingBgColor="#8fd7f7"
        loadingSrc="scenes/jetpack/img/loading.svg" hidden></jetpack-scene>

    <latlong-scene route="latlong"
        path="scenes/latlong/latlong-scene_[[language]].html"
        loadingBgColor="#ffcc00"
        loadingSrc="scenes/latlong/img/loading.svg" hidden></latlong-scene>

    <matching-scene route="matching"
        path="scenes/matching/matching-scene_[[language]].html"
        loadingBgColor="#b27644"
        loadingSrc="scenes/matching/img/loading.svg" hidden></matching-scene>

    <mercator-scene route="mercator"
        path="scenes/mercator/mercator-scene_[[language]].html"
        loadingBgColor="#fbbf2c"
        loadingSrc="scenes/mercator/img/loading.svg" hidden></mercator-scene>

    <playground-scene route="playground"
        path="scenes/playground/playground-scene_[[language]].html"
        loadingBgColor="rgb(251, 191, 44)" hidden></playground-scene>

    <postcard-scene route="postcard"
        path="scenes/postcard/postcard-scene_en.html"
        loadingBgColor="rgb(244, 123, 32)"
        loadingSrc="scenes/postcard/img/loading.gif" hidden></postcard-scene>

    <presentdrop-scene route="presentdrop"
        path="scenes/presentdrop/presentdrop-scene_[[language]].html"
        loadingBgColor="#8fd7f7"
        loadingSrc="scenes/presentdrop/img/loading.svg" hidden></presentdrop-scene>

    <racer-scene route="racer"
        path="scenes/racer/racer-scene_[[language]].html"
        loadingBgColor="#8fd7f7"
        loadingSrc="scenes/racer/img/loading.svg" hidden></racer-scene>

    <runner-scene route="runner"
        path="scenes/runner/runner-scene_[[language]].html" hidden></runner-scene>

    <santaselfie-scene route="santaselfie"
        path="scenes/santaselfie/santaselfie-scene_[[language]].html"
        loadingBgColor="#83D7F5"
        loadingSrc="scenes/santaselfie/img/loading.svg" hidden></santaselfie-scene>

    <seasonofgiving-scene route="seasonofgiving"
        path="scenes/seasonofgiving/seasonofgiving-scene_[[language]].html"
        loadingSrc="scenes/seasonofgiving/img/loading.svg" hidden></seasonofgiving-scene>

    <streetview-scene route="streetview"
        path="scenes/streetview/streetview-scene_[[language]].html"
        loadingBgColor="rgb(129,208,0)" hidden></streetview-scene>

    <trivia-scene route="trivia"
        path="scenes/trivia/trivia-scene_[[language]].html" hidden></trivia-scene>

    <workshop-scene route="workshop"
        path="scenes/workshop/workshop-scene.html"
        hidden></workshop-scene>

    <windtunnel-scene route="windtunnel"
        path="scenes/windtunnel/windtunnel-scene_[[language]].html" hidden
        loadingBgColor="rgb(129,208,0)"></windtunnel-scene>

    <rollercoaster-scene route="rollercoaster"
        path="scenes/rollercoaster/rollercoaster-scene.html" hidden></rollercoaster-scene>

    <undersea-scene route="undersea"
        path="scenes/undersea/undersea-scene_[[language]].html" hidden></undersea-scene>

    <blimp-scene route="blimp"
        path="scenes/blimp/blimp-scene_[[language]].html" hidden></blimp-scene>

    <island-scene route="island"
        path="scenes/island/island-scene_[[language]].html" hidden></island-scene>

    <icecave-scene route="icecave"
        path="scenes/icecave/icecave-scene_[[language]].html" hidden></icecave-scene>

    <traditions-scene route="traditions"
        path="scenes/traditions/traditions-scene_[[language]].html"
        loadingBgColor="rgb(255,224,0)"
        loadingSrc="scenes/traditions/img/loading{{hdpi ? '_2x' : ''}}.gif"
        mode="{{mode}}" hidden></traditions-scene>

    <translations-scene route="translations"
        path="scenes/translations/translations-scene_[[language]].html"
        loadingBgColor="#8FD7F7"
        loadingSrc="scenes/translations/img/loading.png" hidden></translations-scene>

    <tracker-scene id="tracker" route="tracker"
        path="scenes/tracker/tracker-scene_[[language]].html" mode="{{mode}}"
        hidden></tracker-scene>

    <!-- NOTE: when these scenes are visited and then left, they are removed and
         appended to the end of lazy-pages. This is fine as long as VIDEO_ROUTES
         isn't modified (if it is, prevSelectedRouteChanged will need to be
         modified). -->
    <template repeat="{{ videoRoute in VIDEO_ROUTES }}">
      <video-scene route="{{videoRoute}}"
        path="scenes/videoscene/video-scene_[[language]].html"
        hidden></video-scene>
    </template>

    <about-scene route="about"
        path="scenes/about/about-scene_[[language]].html"
        hidden></about-scene>

  </lazy-pages>
</template>
<script>
(function() {

var DEFAULT_ROUTE_ = 'village';
var TRACKER_ROUTE_ = 'tracker';
var VALID_ROUTES_ = [];

// Routes/scenes which should always be accessible, no matter what the day.
// These scenes are also not removed from the lazy-page switching.
var PERMANENT_ROUTES_ = ['village', 'calendar', 'about'];

var VIDEO_ROUTES_ = [
  'trailer', 'carpool', 'liftoff', 'jingle', 'satellite', 'temptation',
  'office', 'tired', 'com-room', 'reload', 'slacking-off'
];

// Routes/scenes unlocked with the tracker (including all video routes)
var TRACKER_ROUTES_ = ['blimp', 'island', 'undersea', 'icecave', 'runner',
    'latlong', 'glider', 'trivia'].concat(VIDEO_ROUTES_);

// Check if date1 is the same date as date2.
function isSameDay_(date1, date2) {
  return date1.getMonth() == date2.getMonth() &&
         date1.getDate() == date2.getDate() &&
         date1.getYear() == date2.getYear();
}

Polymer(Polymer.mixin({

  /**
   * When Santa's flight is finished.
   *
   * @property countDownEndDate
   * @type number
   * @default null
   */
  countDownEndDate: null,

  /**
   * When Santa's flight is finished.
   *
   * @property FLIGHT_FINISHED
   * @type number
   * @default null
   * @const
   */
  FLIGHT_FINISHED: null,

  /**
   * The house meta data shared across scenes.
   *
   * @property houses
   * @type array
   * @default []
   */
  houses: [],

  /**
   * If the browser is hdpi.
   * @property
   * @type boolean
   * @default false
   */
  hdpi: 'devicePixelRatio' in window && devicePixelRatio > 1.5 || false,

  /**
   * The current language locale.
   *
   * @property language
   * @type string
   * @default 'en'
   */
  language: document.documentElement.lang || 'en',

  /**
   * The currently open scene.
   *
   * @property selectedScene
   * @type Element
   * @default null
   */
  selectedScene: null,

  /**
   * The previously selected scene route.
   *
   * @attribute prevSelectedRoute
   * @type string
   * @default null
   */
  prevSelectedRoute: null,

  /**
   * Current URL route.
   *
   * @attribute route
   * @type string
   * @default null
   */
  route: null,

  /**
   * Analytics service.
   *
   * @property analyticsService
   * @type Analytics
   * @default null
   */
  analyticsService: null,

  /**
   * Page/Scene visibility manager.
   *
   * @property visibilityService
   * @type VisiblityManager
   * @default null
   */
  visibilityService: null,

  /**
   * The mode of the scene. Possible values are: 'cast' or 'embed'.
   *
   * @property mode
   * @type string
   * @default ''
   */
  mode: '',

  /**
   * True when Santa's schedule has been checked for the first time.
   *
   * @property scheduleChecked
   * @type bool
   * @default false
   */
  scheduleChecked: false,

  /**
   * True when the tracker intro scene has been shown.
   *
   * @property hasTrackerIntroShown_
   * @type bool
   * @default false
   */
  hasTrackerIntroShown_: false,

  /**
   * Full list of tracker destinations as they've come in.
   *
   * @property destinations
   * @type array
   * @default []
   */
  destinations: [],

  /**
   * Full list of timeline feed items.
   *
   * @property timeline
   * @type array
   * @default []
   */
  timeline: [],

  /**
   * List of video routes.
   *
   * @property VIDEO_ROUTES
   * @type array
   * @default []
   */
  VIDEO_ROUTES: VIDEO_ROUTES_,

  /**
   * A reference to the streetview house in houses.js, for restoration after
   * postFlight.
   *
   * @property streetviewHouse
   * @type object
   * @default null
   */
  streetviewHouse: null,

  publish: {
    /**
     * True when the countdown is complete.
     *
     * @attribute postCountdown
     * @type bool
     * @default false
     */
    postCountdown: {value: false, reflect: true},

    /**
     * True when Santa's flight is complete.
     *
     * @attribute postFlight
     * @type bool
     * @default false
     */
    postFlight: {value: false, reflect: true},
  },

  eventDelegates: {
    'iframe-focus-change': 'onIframeFocusChange',
    'analytics-track-event': 'trackEvent',
    'analytics-track-perf': 'trackPerf',
    'analytics-time-start': 'timeStart',
    'analytics-time-end': 'timeEnd',
    'analytics-track-social': 'trackSocial',
    'analytics-track-game-start': 'trackGameStart',
    'analytics-track-game-quit': 'trackGameQuit',
    'analytics-track-game-over': 'trackGameOver',
    'tracker-action': 'onTrackerAction',
    'countdown-timer-finish': 'onCountdownFinish',
    'tracker-end': 'onTrackerEnd'
  },

  ready: function() {
    // silence the noisy things
    if (!window.DEV) {
      console.log = function(){};
    }

    this.analyticsService = new Analytics();
    this.visibilityService = new VisibilityManager(this);
    this.visibilityService.addOnPauseListener(this.onPause.bind(this));
    this.visibilityService.addOnResumeListener(this.onResume.bind(this));

    this.houses = window.HOUSES;
    this.config = window.SANTA_CONFIG;
    delete window.HOUSES; // cleanup
    delete window.SANTA_CONFIG; // cleanup

    this.countDownEndDate = this.config.COUNTDOWN_END_DATE;
    this.FLIGHT_FINISHED = this.config.FLIGHT_FINISHED;

    var apiClient = getUrlParameter('api_client') || 'web';
    if (!apiClient.match(/^[a-zA-Z_]*$/)) {
      apiClient = 'web';
    }

    var loadSound = true;

    switch (apiClient) {
      case 'web_chromecast':
        this.mode = 'cast';
        this.initChromecast();
        loadSound = false;

        break;
      case 'web_embed':
        this.mode = 'embed';
        loadSound = false;
        break;
      default:
        break;
    }

    if (loadSound) {
      var sc = new SoundController(this.soundsLoaded.bind(this));
      this.addEventListener('sound-preload', sc.loadSounds.bind(sc));
      this.addEventListener('sound-ambient', sc.playAmbientSounds.bind(sc));
      this.addEventListener('sound-trigger', sc.playSound.bind(sc));
    }

    // Initialize routes.
    VALID_ROUTES_ = this.$.lazypages.items.map(function(el) {
      // Note: can't use .route b/c some scene elements won't be upgraded yet.
      return el.getAttribute('route');
    });

    this.santaService = new SantaService(apiClient, this.language);
    this.santaService.sync(this.checkSchedule_.bind(this));

    this.santaService.addListener('destinations_changed', function(destinations) {
      this.destinations = destinations || [];
    }.bind(this));

    this.santaService.addListener('timeline_changed', function(timeline) {
      this.timeline = timeline || [];
    }.bind(this));

    this.santaService.addListener('kill', function justKillMe() {
      this.analyticsService.trackEvent('API', 'killed');
      // redirect after analytics has been processed
      this.analyticsService.executeFunction(function errorRedirect() {
        window.location = 'https://santatracker.google.com' +
            location.pathname.replace(/[^\/]*$/, '') + 'error.html';
      });
    }.bind(this));

    this.prepareHouses_();

    this.checkSchedule_();
    if (!this.route) {
      this.route = this.postCountdown ? TRACKER_ROUTE_ : DEFAULT_ROUTE_;
    }
  },

  /**
   * Catch-all place to do some kind of initialization of houses.
   */
  prepareHouses_: function() {
    var castMode = this.mode === 'cast';
    var ios = navigator.userAgent.match(/iPhone|iPod|iPad/i);
    var spanglish = /^e(n|s)/.test(this.language);

    for (var i = this.houses.length - 1; i >= 0; i--) {
      var house = this.houses[i];

      // if on chromecast, disable any houses not suitable for cast
      house.disabled = (castMode && !house.cast) || house.disabled;

      switch (house.module) {
        case 'app':
          // Disable Google Play house on iOS devices
          house.disabled = ios || house.disabled;
          break;
        case 'streetview':
          // remove streetview where callfromsanta supported (en|en-GB|es|es-419)
          // Save the object for postFlight (when callfromsanta will be disabled)
          if (spanglish && !this.postFlight) {
            this.streetviewHouse = this.houses.splice(i, 1)[0];
          }
          break;
        case 'callfromsanta':
          // remove callfromsanta where not supported (leaving streetview) or
          // after Santa's flight has concluded.
          if (!spanglish || this.postFlight) {
            this.houses.splice(i, 1);
          }
          break;
      }
    }
  },

  languageChanged: function() {
    this.santaService.lang_ = this.language;
  },

  selectedSceneChanged: function(oldVal, newVal) {
    if (oldVal) {
      this.prevSelectedRoute = oldVal.route;
    }
    // If there are scene params in the URL, let the selected scene know.
    if (Object.keys(this.sceneParams).length) {
      this.selectedScene.sceneParams = this.sceneParams;
    }
  },

  prevSelectedRouteChanged: function() {
    // Only remove certain elements from the DOM.
    var dontRemoveEl = PERMANENT_ROUTES_.indexOf(this.prevSelectedRoute) != -1;
    if (dontRemoveEl) {
      return;
    }

    var prevSelectedScene = null;
    for (var i = 0, scene; scene = this.$.lazypages.items[i]; ++i) {
      if (scene.route == this.prevSelectedRoute) {
        prevSelectedScene = scene;
        break;
      }
    }

    // Remove previous scene if it shouldn't always be active.
    if (!prevSelectedScene.alwaysActive) {
      prevSelectedScene.parentNode.removeChild(prevSelectedScene);

      // Re-construct removed scene and add it back to lazy-pages.
      var el = document.createElement(prevSelectedScene.localName);
      el.route = prevSelectedScene.route;
      el.path = prevSelectedScene.path;
      el.mode = this.mode;
      el.hidden = true;
      el.santaApp = this;
      el.loaded = true;

      this.$.lazypages.appendChild(el);
    }
  },

  routeChanged: function() {
    // Check if the new route needs a special-case redirect or if it is valid.
    // If this changes the route, routeChanged() will be called again, repeating
    // until this.route passes through validateRoute() successfully.
    var requestedRoute = this.route;
    switch (requestedRoute) {
      case 'tourist':
        // tourist and trailer are synonymous
        this.route = 'trailer';
        break;
      case 'gumballs':
        this.route = 'gumball';
        break;
      default:
        this.validateRoute();
    }

    if (requestedRoute === this.route) {
      // Route is valid. Send to analytics and load the scene.
      this.trackPageview('/' + this.route);
    } else if (requestedRoute !== '') {
      // The requested route was changed.
      var currentRoute = null;
      if (this.selectedScene.pageUrl) {
        currentRoute = this.selectedScene.pageUrl + '#' +
            this.selectedScene.route;
      }
      this.fire('analytics-track-event', { category: 'Routing',
          action: 'Invalid Route Source', label: currentRoute});
      this.fire('analytics-track-event', { category: 'Routing',
          action: 'Invalid Route', label: '/' + requestedRoute});
    }
  },

  validateRoute: function() {
    if (this.scheduleChecked) {
      var valid = (VALID_ROUTES_.indexOf(this.route) != -1 &&
                   this.sceneIsUnlocked(this.route)) ||
                   (this.postCountdown && this.route == TRACKER_ROUTE_);
      if (!valid) {
        this.route = this.postCountdown ? TRACKER_ROUTE_ : DEFAULT_ROUTE_;
      }
    }
  },

  onPause: function() {
    this.fire('sound-ambient', 'global_blur');
    this.fire('sound-ambient', 'global_pause');
    if (this.selectedScene && this.selectedScene.fire) {
      this.selectedScene.fire('scene-pause', true);
    }
  },

  onResume: function() {
    this.fire('sound-ambient', 'global_focus');
    this.fire('sound-ambient', 'global_unpause');
    if (this.selectedScene && this.selectedScene.fire) {
      this.selectedScene.fire('scene-pause', false);
    }
  },

  soundsLoaded: function(soundsName) {
    // TODO(bckenny): selectedScene.fire check may be unecessary as it's not
    // clear if it's possible for selectedScene to not be upgraded by this point
    if (this.selectedScene && this.selectedScene.fire) {
      this.selectedScene.fire('sounds-loaded', soundsName);
    }
  },

  trackPageview: function(path) {
    this.analyticsService.trackPageView(path);
  },

  trackEvent: function(e, detail, sender) {
    this.analyticsService.trackEvent(
        detail.category, detail.action, detail.label, detail.value);
  },

  trackPerf: function(e, detail, sender) {
    this.analyticsService.trackPerf(
        detail.category, detail.variable, detail.time, detail.label, detail.maxTime);
  },

  timeStart: function(e, detail, sender) {
    this.analyticsService.timeStart(
        detail.category, detail.variable, detail.time);
  },

  timeEnd: function(e, detail, sender) {
    this.analyticsService.timeEnd(
        detail.category, detail.variable, detail.time, detail.label, detail.maxTime);
  },

  trackSocial: function(e, detail, sender) {
    this.analyticsService.trackSocial(
        detail.network, detail.action, detail.target);
  },

  trackGameStart: function(e, detail, sender) {
    this.analyticsService.trackGameStart(detail.gameId || detail.gameid);
  },

  trackGameQuit: function(e, detail, sender) {
    this.analyticsService.trackGameQuit(detail.gameId || detail.gameid,
        detail.level, detail.timePlayed);
  },

  trackGameOver: function(e, detail, sender) {
    this.analyticsService.trackGameOver(
        detail.gameId || detail.gameid, detail.score, detail.level,
        detail.timePlayed);
  },

  onIframeFocusChange: function(e, detail, sender) {
    if (detail === 'blur') {
      this.visibilityService.pauseIframe();
    } else if (detail === 'focus') {
      this.visibilityService.resumeIframe();
    }
  },

  /**
   * When the flight finishes, check if any houses in the village need to be
   * shutoff, kicking out of invalid routes if necessary.
   */
  postFlightChanged: function() {
    for (var i = 0; i < this.houses.length; i++) {
      // In regions where callfromsanta was supported, replace it with the
      // streetviewHouse used in other regions
      if (this.houses[i].module === 'callfromsanta') {
        if (this.streetviewHouse) {
          this.houses[i] = this.streetviewHouse;
        } else {
          this.houses[i].disabled = true;
        }
      }

      // lock more houses here, if needed
    }

    // allowed routes may have changed, so check again
    this.checkSchedule_();
  },

  postCountdownChanged: function() {
    document.body.classList.add('posttakeoff');
  },

  /**
   * @param number index
   */
  unlockHouse: function(idx) {
    var house = this.houses[idx];
    if (!house) {
      return;
    }

    // house is melted unless it's disabled
    house.iced = house.disabled;
  },

  unlockAllHouses: function() {
    for (var i = 0, house; house = this.houses[i]; ++i) {
      this.unlockHouse(i);
      house.today = false;
      house.tomorrow = false;
    }
  },

  lockAllHouses: function() {
    for (var i = 0, house; house = this.houses[i]; ++i) {
      house.iced = true;
      house.today = false;
      house.tomorrow = false;
    }
  },

  sceneIsUnlocked: function(moduleName) {
    for (var i = 0, house; house = this.houses[i]; ++i) {
      if (house.module === moduleName) {
        return !house.disabled && (this.santaService.now() > house.launchDate);
      }
    }

    // Certain scenes don't have associated houses. Whitelist them.
    if (PERMANENT_ROUTES_.indexOf(moduleName) != -1) {
      return true;
    }

    if (this.postCountdown && TRACKER_ROUTES_.indexOf(moduleName) != -1) {
      return true;
    }

    return false;
  },

  /**
   * Unlocks the correct houses based on the day (index).
   * @private
   */
  checkSchedule_: function() {
    if (window.DEV) {
      console.info('dev, unlocking all houses');
      this.unlockAllHouses();
      return;
    }

    var todayDate = this.santaService.dateNow();
    var tomorrowDate = new Date(todayDate);
    tomorrowDate.setDate(todayDate.getDate() + 1);

    // Set post countdown/post flight flags based on current time.
    this.postFlight = todayDate >= this.FLIGHT_FINISHED;
    this.postCountdown = todayDate > this.countDownEndDate && !this.postFlight;

    switch(todayDate.getMonth()) {
      case 11: // DECEMBER
        // Update house status based on today's date.
        for (var i = 0; i < this.houses.length; i++) {
          var house = this.houses[i];

          if (house.launchDate <= todayDate) {
            this.unlockHouse(i);
            house.today = isSameDay_(house.launchDate, todayDate);
            house.tomorrow = false;
          } else {
            house.iced = true;
            house.today = false;
            house.tomorrow = isSameDay_(house.launchDate, tomorrowDate);
          }
        }
        break;
      case 0: // JAN
        // All houses in Jan are unlocked. Full experience baby!
        this.unlockAllHouses();
        break;
      default:
        // noop
        this.lockAllHouses();
    }

    this.scheduleChecked = true;
    this.validateRoute();

    // Check again at the next hour tick.
    var timeTillHour = (60 - todayDate.getMinutes()) * 60 * 1000;
    this.scheduleTimeout_ = this.async(this.checkSchedule_, null, timeTillHour);
  },

  keyHandler: function(e, detail, sender) {
    switch(e.detail.key) {
      case 'esc':
        this.route = this.postCountdown ? TRACKER_ROUTE_ : DEFAULT_ROUTE_;
        break;
    }
  },

  onTrackerAction: function(e, detail, sender) {
    // Note: needs to go qS() because DOM is not guaranteed to exist if on cast.
    var calendar = this.$.lazypages.querySelector('calendar-nav');
    if (!calendar) {
      return; // cast mode
    }
    if (detail.type == 'tracker-toggle') {
      calendar.trackerActive = detail.active;
    } else if (detail.type == 'city-toggle') {
      calendar.cityFeedActive = detail.active;
    }
  },

  onCountdownFinish: function(e, detail, sender) {
    // Redirect village -> tracker when the countdown finishes. This allows
    // users to go back to the village.
    if (!this.postCountdown) {
      this.checkSchedule_();
      if (this.postCountdown && this.route === DEFAULT_ROUTE_) {
        this.route = TRACKER_ROUTE_;
      }
    }
  },

  onTrackerEnd: function(e, detail, sender) {
    this.checkSchedule_();
  }

}, chromecastMixin));

})();
</script>
</polymer-element>
