(function(z,p){z.Klang=p();"function"===typeof define&&define.amd?define(function(){return z.Klang}):"object"===typeof exports&&(module.exports=z.Klang)})(window,function(){if(-1!=navigator.userAgent.indexOf("MSIE")){var z;null!=/MSIE ([0-9]{1,}[.0-9]{0,})/.exec(navigator.userAgent)&&(z=parseInt(RegExp.$1));9>z&&(Object.oldDefineProperty=Object.defineProperty,Object.defineProperty=function(){})}(function(){function d(d){d&&!d.setTargetValueAtTime&&(d.setTargetValueAtTime=d.setTargetAtTime)}var p=
window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext;if(p){var u=p.prototype,y=new p;u.hasOwnProperty("createGain")||(u.createGain=u.createGainNode);u.hasOwnProperty("internal_createBiquadFilter")||(u.internal_createBiquadFilter=u.createBiquadFilter,u.createBiquadFilter=function(){var p=this.internal_createBiquadFilter();d(p.frequency);d(p.detune);d(p.Q);d(p.gain);for(var u="LOWPASS HIGHPASS BANDPASS LOWSHELF HIGHSHELF PEAKING NOTCH ALLPASS".split(" "),y=0;y<
u.length;++y){var z=u[y],B=z.toLowerCase();!p.hasOwnProperty(z)||Object.isFrozen&&Object.isFrozen(p)||(p[z]=B)}return p});u.hasOwnProperty("createDelay")||(u.createDelay=u.createDelayNode);var B=y.createBufferSource().constructor.prototype;if(void 0===B.start&&void 0!==B.noteOn||void 0===B.stop&&void 0!==B.noteOff){var z=u.createBufferSource;u.createBufferSource=function(){var d=z.call(this);d.start=d.start||d.noteOn;d.stop=d.stop||d.noteOff;return d}}if("function"===typeof y.createOscillator&&(y=
y.createOscillator().constructor.prototype,void 0===y.start&&void 0!==y.noteOn||void 0===y.stop&&void 0!==y.noteOff)){var C=u.createOscillator;u.createOscillator=function(){var d=C.call(this);d.start=d.start||function(){d.noteOn&&(1<arguments.length?d.noteGrainOn.apply(d,arguments):d.noteOn.apply(d,arguments))};d.stop=d.stop||d.noteOff;return d}}void 0===u.createGain&&void 0!==u.createGainNode&&(u.createGain=u.createGainNode);void 0===u.createDelay&&void 0!==u.createDelayNode&&(u.createDelay=u.createDelayNode);
void 0===u.createScriptProcessor&&void 0!==u.createJavaScriptNode&&(u.createScriptProcessor=u.createJavaScriptNode);(window.AudioParam=window.AudioParam||window.webkitAudioParam)?(p=window.AudioParam.prototype,p.setTargetAtTime=p.setTargetAtTime||p.setTargetValueAtTime):p.prototype.internal_createGain||(p.prototype.internal_createGain=p.prototype.createGain,p.prototype.createGain=function(){var p=this.internal_createGain();d(p.gain);return p})}})();var p=this.__extends||function(d,p){function u(){this.constructor=
d}u.prototype=p.prototype;d.prototype=new u},D;(function(d){function z(c){for(var n=[],h=0;h<arguments.length-1;h++)n[h]=arguments[h+1];if(g.isInited)try{"webaudio"===d.version?d.context&&g.instance.triggerEvent(c,n):"audiotag"===d.version&&d.audioTagHandler&&d.audioTagHandler.triggerEvent(c,n)}catch(e){d.err("Klang exception: unable to trigger event: '"+c+"': "+e.name+": "+e.message)}}function u(){if(A){for(var c in A)A.hasOwnProperty(c)&&d.triggerEvent.apply(d,A[c]);A=null}}function y(d,n){for(var h=
d.toString();h.length<n;)h="0"+h;return h}function B(c){void 0==c&&(c=d.context.currentTime);c=Math.round(1E3*c);var n=Math.floor(c/1E3%60),h=Math.floor(c/6E4%60);return y(Math.floor(c/36E5%24),2)+":"+y(h,2)+":"+y(n,2)+"."+y(c%1E3,3)}(function(d){d.browser=function(){var d=navigator.userAgent,c,e=d.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];if(/trident/i.test(e[1]))return c=/\brv[ :]+(\d+)/g.exec(d)||[],{name:"IE",version:c[1]||"unknown"};if("Chrome"===e[1]&&(c=d.match(/\bOPR\/(\d+)/),
null!==c))return{name:"Opera",version:c[1]};e=e[2]?[e[1],e[2]]:[navigator.appName,navigator.appVersion,"-?"];null!==(c=d.match(/version\/(\d+)/i))&&e.splice(1,1,c[1]);return{name:e[0],version:e[1]}}()})(d.detector||(d.detector={}));(function(d){d.isCrossDomain=function(d){var c=document.createElement("a");c.href=d;d=document.createElement("a");d.href=location.href;return""!=c.hostname&&(c.port!=d.port||c.protocol!=d.protocol||c.hostname!=d.hostname)};d.request=function(d,c,e,f){var k;d.type=d.type||
"GET";if(window.XMLHttpRequest)k=new XMLHttpRequest,k.open(d.type,d.url,!0),k.onreadystatechange=function(){try{4==k.readyState&&200==k.status?c&&c(k.responseText):0!=k.status&&200!=k.status&&f&&f({status:k.status})}catch(d){throw d;}};else throw"Error - browser does not support XDomain/XMLHttp Requests";k&&k.send(null)}})(d.network||(d.network={}));var D=d.network;d.audioTagHandler;var C=function(){function d(n,c){this._url=n;this.data=c;this._onCanPlayThrough=this._onCanPlayThrough.bind(this);this._waitForReadyState=
this._waitForReadyState.bind(this)}d.STATE_PRELOAD=0;d.STATE_LOADING=1;d.STATE_LOADED=2;d.prototype._onCanPlayThrough=function(){this.audioElement.removeEventListener("canplaythrough",this._onCanPlayThrough,!1);this._waitForReadyState(function(){this.ready=!0;this.state=this.state=d.STATE_LOADED;this._readyCallback&&this._readyCallback()}.bind(this))};d.prototype._waitForReadyState=function(d){var c=this;(function f(){c.audioElement.readyState?d&&d():setTimeout(f,100)})()};d.prototype.load=function(n){if(this.state===
d.STATE_PRELOAD){this.state=d.STATE_LOADING;var h=this.audioElement=new Audio;h.src=this._url;h.addEventListener("canplaythrough",this._onCanPlayThrough,!1);h.volume=0;h.play()}this._readyCallback=n};return d}();d.ATAudioFile=C;var G=function(){function c(d,c){this._data=d;if(this._file=c)this._priority=this._file.data.audio_tag,this._loop=!!this._data.loop,this._gain=new I(d.volume,this),this.onEnded=this.onEnded.bind(this)}c.prototype.onEnded=function(){this._playing&&this._loop&&(this._file.audioElement.currentTime=
0,this._file.audioElement.play())};c.prototype.play=function(d,c,e,f,k){if(this._playing||!this._file.ready)return this;this._file.audioElement.currentTime=0;this._file.audioElement.play();this._playing=!0;this.setVolume();this._loop&&this._file.audioElement.addEventListener("ended",this.onEnded,!1);return this};c.prototype.fadeInAndPlay=function(d,c,e,f){this.play();return this};c.prototype.stop=function(d){this._loop&&this._file.audioElement.removeEventListener("ended",this.onEnded,!1);this._file.audioElement.pause();
this._playing=!1;return this};c.prototype.fadeOutAndStop=function(d,c){this.stop();return this};c.prototype.setVolume=function(c){c=void 0===c||this.getOutput().getVolume();c=Math.max(0,Math.min(1,c*d.audioTagHandler.getGlobalVolume()));this._file.audioElement.volume=c;return this};c.prototype.getOutput=function(){return this._gain};Object.defineProperty(c.prototype,"position",{get:function(){return 0},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"playing",{get:function(){return this._playing},
enumerable:!0,configurable:!0});return c}();d.ATAudioSource=G;var H=function(){function c(c){this._data=c;this._content=[];for(var h in this._data.content)(c=d.audioTagHandler.getObject(this._data.content[h]))&&this._content.push(c)}c.prototype.play=function(d,c,e){c="number"===typeof c?c:l.random(this._content.length-1,0);this._content[c]&&this._content[c].play(d);return this};c.prototype.stop=function(){for(var d in this._content)this._content[d]&&this._content[d].stop();return this};Object.defineProperty(c.prototype,
"playing",{get:function(){var d=!1,c;for(c in this._content)this._content[c]._playing&&(d=!0);return d},enumerable:!0,configurable:!0});return c}();d.ATAudioGroup=H;var I=function(){function d(c,h){this._currentVolume=this._volume=void 0!=c?c:1;this._currentVolume=Math.max(0,Math.min(this._currentVolume,1));this._owner=h}d.prototype.getVolume=function(){return this._volume};d.prototype.setVolume=function(d){this._currentVolume=this._volume=d=Math.max(0,Math.min(1,d));this._owner&&this._owner.setVolume&&
this._owner.setVolume(this._currentVolume);return this};d.prototype.fadeVolume=function(d,c,e){this._fadeTimer&&clearInterval(this._fadeTimer);var f=this;this._fadeSteps=Math.round(1E3*c)/10;this._volumeStep=(this._currentVolume-d)/this._fadeSteps;this._fadeTimer=setInterval(function(){f.setVolume(f._currentVolume-f._volumeStep);f._fadeSteps--;0>=f._fadeSteps&&(clearInterval(f._fadeTimer),e&&e())},10);return this};d.prototype.resetVolume=function(d){d=d?this._currentVolume:this._volume;clearInterval(this._fadeTimer);
this.setVolume(d);return this};return d}();d.ATGainNode=I;var J=function(){function c(d,c,e){this._data=d;this._name=c;this._vars=e;"copy"===this._data.at_action&&(this._data.at_action=this._data.action)}c.prototype.start=function(c){try{(new Function("Util","me","args",this._data.at_action))(l,this._vars,c)}catch(h){d.err("Klang: error in process '"+this._name+"': "+h.name+": "+h.message)}};return c}();d.ATProcess=J;var K=function(){function c(c,h,e){this._loadedFiles=0;this._audioFiles={};this._limitSounds=
d.isMobile||"Opera"==d.browser;if("string"==typeof c){var f=this;D.request({url:c},function(k){try{f.init(JSON.parse(k),h,e,c)}catch(g){d.version="n/a",h&&h(!1)}},null,function(c){d.err(c)})}else"object"==typeof c?this.init(c):d.err("Klang exception: unrecognized config type: "+typeof c)}c.prototype.init=function(c,h,e,f){this._globalVolume=1;this._readyCallback=h;this._progressCallback=e;this._events=c.events;var k=c.settings.file_path||"";c.settings.relative_path?-1!=f.lastIndexOf("/")?(f=f.substring(0,
f.lastIndexOf("/")),"/"!==f.charAt(f.length-1)&&(f+="/"),f+=k):f=k:f=k;var k="Opera"==d.browser||"Firefox"==d.browser||"Chrome"==d.browser?".ogg":".mp3",g;for(g in c.files){var m=c.files[g],l=m.audio_tag;!l||this._limitSounds&&1!=l||(this._audioFiles[m.id]=new C(f+m.url+k,m))}this._audio={};for(var p in c.audio)c.audio.hasOwnProperty(p)&&(f=c.audio[p],"AudioSource"==f.type?this._audio[p]=new G(f,this._audioFiles[f.file_id]):"AudioGroup"==f.type&&(this._audio[p]=new H(f)));this._processes={};for(g in c.processes)if(p=
c.processes[g],p.at_action){f={};for(var u in p.vars)k=p.vars[u],f[k]=this._audio[k];this._processes[g]=new J(p,g,f)}this.loadSoundFiles(["auto","autotag"],h,e)};c.prototype.initIOS=function(){if(d.isIOS||d.isMobile)for(var c in this._audioFiles)this._audioFiles[c].load()};c.prototype.loadSoundFiles=function(d,c,e,f){c&&(this._readyCallback=c);e&&(this._progressCallback=e);this._numFiles=this._loadedFiles=0;var k=this,g;for(g in this._audioFiles)this._audioFiles.hasOwnProperty(g)&&(c=this._audioFiles[g],
e=c.data.load_group,void 0!=d&&e!=d&&-1==d.indexOf(e)||c.state===C.STATE_PRELOAD||(this._numFiles++,c.load(function(){k.loadProgress()})));0==this._numFiles&&this._readyCallback&&this._readyCallback(!0)};c.prototype.getLoadGroups=function(){var d,c=this._audioFiles||[],e={},f=[];for(d in c){var k=c[d];e[k.data.load_group]=k.data.load_group}for(d in e)f.push(d);return f};c.prototype.loadProgress=function(){this._loadedFiles++;this._progressCallback&&this._progressCallback(this._loadedFiles/this._numFiles*
100);if(this._readyCallback&&this._loadedFiles==this._numFiles){var d=this;setTimeout(function(){d._readyCallback(!0)},2E3)}};c.prototype.triggerEvent=function(c,h){for(var e=0;e<h.length;e++);if(this._events)try{var f=this._events[c];if("string"==typeof f){var k=this._processes[f];k&&k.start(h)}else if(f)for(var e=0,g=f.length;e<g;e++)(k=this._processes[f[e]])&&k.start(h)}catch(m){d.err("Klang: error when triggering event '"+c+"': "+m.name+": "+m.message)}};c.prototype.getGlobalVolume=function(){return this._globalVolume};
c.prototype.setGlobalVolume=function(d){this._globalVolume=d=Math.max(0,Math.min(d,1));for(var c in this._audio)if((d=this._audio[c])&&d.setVolume&&d.getOutput){var e=d.getOutput();e&&d.setVolume(e.getVolume())}};c.prototype.fadeGlobalVolume=function(d,c){d=Math.max(0,Math.min(d,1));this._globalFadeTimer&&clearInterval(this._globalFadeTimer);var e=this,f=Math.round(1E3*c)/10,k=(this._globalVolume-d)/f;this._globalFadeTimer=setInterval(function(){e._globalVolume-=k;f--;for(var d in e._audio){var c=
e._audio[d];c&&c.setVolume&&c.getOutput&&c.setVolume()}0>=f&&clearInterval(e._globalFadeTimer)},10)};c.prototype.getLimitSounds=function(){return this._limitSounds};c.prototype.stopAll=function(d){for(var c in this._audio)void 0!=d&&this._audio[c]._priority!=d||this._audio[c].stop();this.stopPeriodic();return this};c.prototype.getObject=function(d){return this._audioFiles[d]||this._audio[d]};c.prototype.playPeriodic=function(d,c,e){clearTimeout(this._periodicTimer);var f=this;this._periodicTimer=
setTimeout(function(){d.play();f.playPeriodic(d,c,e)},l.random(1E3*c,1E3*e))};c.prototype.stopPeriodic=function(){clearTimeout(this._periodicTimer)};return c}();d.AudioTagHandler=K;d.versionNumber=1;d.context;d.version;d.progressCallback;d.readyCallback;d.browser;d.os;d.isMobile;d.isIOS;d.fallback;d.loggingEnabled=!1;d.useMonoBuffers=!1;d.Panner;d.safari=!1;d.initOptions;var g=function(){function c(){this._blurFadeOut=this._initComplete=!1;this._masterBusId=null;this._preLoadInitStack=[];this._postLoadInitStack=
[];this._connectStack=[];this._superMasterOutput=d.context?d.context.createGain():null;d.Panner=x.Panner;this._eventHistory=[];this.scheduler=new x.Scheduler;l.getParameterByName("klang_log")&&(d.loggingEnabled=!0)}c.debugSettings={};c.inst=null;c.isInited=function(){return null==c.inst?!1:c.inst._initComplete};Object.defineProperty(c.prototype,"initComplete",{get:function(){return this._initComplete},enumerable:!0,configurable:!0});Object.defineProperty(c,"instance",{get:function(){null==c.inst&&
(c.inst=new c);return c.inst},enumerable:!0,configurable:!0});c.prototype.setCallbacks=function(d){this._callbacks=d};Object.defineProperty(c,"callbacks",{get:function(){return c.instance._callbacks},enumerable:!0,configurable:!0});c.deinit=function(){c.inst=null};c.prototype.stopAll=function(){window.KlangVisual&&KlangVisual.stop();for(var d in this._objectTable)if(this._objectTable[d].stop)try{this._objectTable[d].stop()}catch(c){}};c.prototype.loadJSON=function(n,h,e){this._readyCallback=h;this._progressCallback=
e||function(){};if("object"===typeof n)d.log("Loading config (editor)"),h=this.createConfigNode(n),c.settings=h.settings,c.instance.initContent(h),window.KlangVisual&&KlangVisual.init(n);else if("string"===typeof n){d.log("Loading config (client)");var f=new XMLHttpRequest;f.open("GET",n,!0);var k=this;f.onreadystatechange=function(){if(4==f.readyState&&200==f.status){var d=f.responseText,e=k.parseConfigJSON(d);c.settings=e.settings;c.instance.initContent(e,null,n);window.KlangVisual&&KlangVisual.init(JSON.parse(d))}else{if(404==
f.status)throw"Klang exception: config file not found: '"+n+"'";if(200!=f.status)throw"Klang exception: unable to load config file: '"+n+"'";}};f.send(null)}else throw"Klang exception: unrecognized options: '"+n+"'";};c.prototype.parseConfigJSON=function(c){return JSON.parse(c,function(c,e){return e&&"object"===typeof e&&"string"===typeof e.type?(x[e.type]||d.warn("Core: Type not found: "+e.type),new x[e.type](e,c)):e})};c.prototype.createConfigNode=function(c){if("object"===typeof c)for(var h in c){var e=
c[h];"object"===typeof e&&"string"===typeof e.type?(x[e.type]||d.warn("Core: Type not found: "+e.type),c[h]=this.createConfigNode(e),c[h]=new x[e.type](e,h)):c[h]=this.createConfigNode(e)}return c};c.prototype.createObject=function(c,h,e){e||(e={});x[h.type]||d.warn("Core: Type not found: "+h.type);!e.excludeFromTable&&this._objectTable[c]&&d.warn("Core: Duplicate object: "+c);h=new x[h.type](h,c);e.excludeFromTable||(this._objectTable[c]=h);!e.noInit&&h.init&&h.init();!e.noConnect&&h.destinationName&&
h.connect&&("$OUT"==h.destinationName?h.connect(this._superMasterOutput):((c=this.findInstance(h.destinationName))||d.warn("Core: Destination not found: "+h.destinationName),"Bus"!=c._type&&d.warn("Core: Destination is not a bus: "+h.destinationName),h.connect(c.input)));return h};c.prototype.updateObject=function(d,c){var e="string"==typeof d?this._objectTable[d]:d;"SimpleProcess"==e._type&&"AdvancedProcess"==c.type?(e=new x.AdvancedProcess(c,d),e.init(),this._objectTable[d]=e):"AdvancedProcess"==
e._type&&"SimpleProcess"==c.type?(e=new x.SimpleProcess(c,d),e.init(),this._objectTable[d]=e):e.setData&&e.setData(c)};c.prototype.createEvent=function(c,h){this._eventTable[c]&&d.warn("Core: Duplicate event: "+c);this._eventTable[c]=h};c.prototype.initContent=function(n,h,e){var f=n.settings.file_path||"";n.settings.relative_path?-1!=e.lastIndexOf("/")?(e=e.substring(0,e.lastIndexOf("/")),"/"!==e.charAt(e.length-1)&&(e+="/"),e+=f):e=f:e=f;d.log("Initializing core");if(-1!=n.settings.blur_fade_time){f=
function(){g.isHidden()?g._blurFadeOut&&l.curveParamLin(g._superMasterOutput.gain,0,k):l.curveParamLin(g._superMasterOutput.gain,1,k)};this._blurFadeOut=!0;var k=n.settings.blur_fade_time||.5;0>k&&-1!=k&&d.warn("Core: Invalid blur_fade_time value. Must be -1 or >= 0.");var g=this;this.getHiddenProp()&&document.addEventListener("visibilitychange",f)}x.FileHandler.instance.fileInfo=(void 0!=h?h:n.files)||[];this._eventTable=n.events||{};this._objectTable={};for(var m in n.audio)this._objectTable[m]=
n.audio[m];for(m in n.busses)this._objectTable[m]=n.busses[m];for(m in n.sequencers)this._objectTable[m]=n.sequencers[m];for(m in n.processes)this._objectTable[m]=n.processes[m];for(m in n.synths)this._objectTable[m]=n.synths[m];for(m in n.lfos)this._objectTable[m]=n.lfos[m];for(m in n.automations)this._objectTable[m]=n.automations[m];this.setVars(n.vars);this._masterBusId=n.masterBus;this._exportedSymbols=n.exportedSymbols||{};this._logIgnore=n.debug.log_ignore||n.log_ignore||{};x.Panner.setListenerData(n.settings.listener);
l.createCurves(n.curves);this._loadStartTimestamp=(new Date).getTime();n.debug&&(d.debugData.ignoredEvents=n.debug.ignored_events||d.debugData.ignoredEvents,d.debugData.logToConsole=n.debug.log_to_console||d.debugData.logToConsole);d.log("Pre load initialization started");n=0;for(h=this._preLoadInitStack.length;n<h;n++)m=this._preLoadInitStack[n],m.init&&m.init();d.log("Pre load initialization finished");d.log("Connecting nodes");this._superMasterOutput.connect(d.context.destination);n=0;for(h=this._connectStack.length;n<
h;n++)switch(m=this._connectStack[n],m.destinationName){case "$OUT":m.connect(this._superMasterOutput);break;case "$PARENT":break;default:(f=this.findInstance(m.destinationName))||d.warn("Core: Destination not found: "+m.destinationName),"Bus"!=f._type&&d.warn("Core: Destination is not a bus: "+m.destinationName),m.connect(f.input)}d.log("Nodes connected");this._connectStack=this._preLoadInitStack=null;this._timeHandler=new x.TimeHandler;this._initComplete=!0;d.log("Core initialized");x.FileHandler.instance.baseURL=
e;(!d.initOptions||d.initOptions&&!d.initOptions.noAutoLoad)&&x.FileHandler.instance.loadFiles("auto",c.soundsLoaded,this._progressCallback)};c.prototype.isHidden=function(){var d=this.getHiddenProp();return d?document[d]:!1};c.prototype.getHiddenProp=function(){var d=["webkit","moz","ms","o"];if("hidden"in document)return"hidden";for(var c=0;c<d.length;c++)if(d[c]+"Hidden"in document)return d[c]+"Hidden";return null};c.prototype.setVars=function(d){if(d){for(var c in d)if("string"==typeof d[c]&&
-1<d[c].indexOf("me."))d[c]=this.findInstance(d[c].split("me.")[1]);else if("object"==typeof d[c]){var e=d[c],f;for(f in e)e.hasOwnProperty(f)&&"string"==typeof e[f]&&-1<e[f].indexOf("me.")&&(e[f]=this.findInstance(e[f].split("me.")[1]))}l.vars=d}};c.prototype.loadSoundFiles=function(d,c,e,f){e&&(this._progressCallback=e);var g=this;x.FileHandler.instance.loadFiles(d,function(d,e){for(var f=0;f<e.length;f++){var n=e[f].id,l;for(l in g._objectTable)if(g._objectTable.hasOwnProperty(l)){var p=g._objectTable[l];
"AudioSource"===p._type&&p._fileId===n&&p.init()}}c&&c(!0)},this._progressCallback,f)};c.prototype.freeSoundFiles=function(d){x.FileHandler.instance.freeSoundFiles(d);for(var c in this._objectTable){var e=this._objectTable[c];if("AudioSource"==e._type){var f=x.FileHandler.instance.getFileInfo(e._fileId);f&&f.load_group==d&&e.freeBuffer()}}};c.soundsLoaded=function(){d.log("Post load initialization started");for(var n=c.instance,h=0,e=n._postLoadInitStack.length;h<e;h++)n._postLoadInitStack[h].init();
d.log("Post load initialization finished");n._postLoadInitStack=null;n._readyCallback&&n._readyCallback(!0)};c.prototype.pushToPreLoadInitStack=function(d){return this._preLoadInitStack?(this._preLoadInitStack.push(d),!0):!1};c.prototype.pushToPostLoadInitStack=function(d){return this._postLoadInitStack?(this._postLoadInitStack.push(d),!0):!1};c.prototype.pushToConnectStack=function(d){return this._connectStack?(this._connectStack.push(d),!0):!1};c.prototype.findInstance=function(c){var h=this._objectTable[c];
h||d.warn("Core: Unknown reference: '"+c+"'");return h};c.prototype.triggerEvent=function(c){for(var h=[],e=0;e<arguments.length-1;e++)h[e]=arguments[e+1];l.lastEvent=c;if(!d.debugData.ignoredEvents[c])if(this._eventTable[c]?d.debugData.logToConsole&&!this._logIgnore[c]&&d.logc("Klang Core: Incoming sound event: '"+c+"', "+h,l.LOG_EVENT_COLOR):d.debugData.logToConsole&&!this._logIgnore[c]&&d.logc("Klang Core: Incoming sound event: '"+c+"', "+h,l.LOG_UNIMPLEMENTED_EVENT_COLOR),e=this._eventTable[c],
"string"==typeof e)this._objectTable[e]||d.warn("Core: Unknown process: '"+e+"'"),"SimpleProcess"!=this._objectTable[e]._type&&"AdvancedProcess"!=this._objectTable[e]._type&&d.warn("Core: Object is not a process: '"+e+"'"),this._objectTable[e].start(h[0]);else if(e instanceof Array)for(var f=0,g=e.length;f<g;f++)this._objectTable[e[f]]||d.warn("Core: Unknown process: '"+e[f]+"'"),"SimpleProcess"!=this._objectTable[e[f]]._type&&"AdvancedProcess"!=this._objectTable[e[f]]._type&&d.warn("Core: Object is not a process: '"+
e+"'"),this._objectTable[e[f]].start(h[0])};c.prototype.getSymbolId=function(d){return this._exportedSymbols[d]};c.prototype.initIOS=function(){d.context.createBufferSource().start(0)};Object.defineProperty(c.prototype,"timeHandler",{get:function(){return this._timeHandler},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"output",{get:function(){return this._superMasterOutput},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"blurFadeOut",{get:function(){return this._blurFadeOut},
set:function(d){this._blurFadeOut=d},enumerable:!0,configurable:!0});return c}();d.READY_STATE_NOT_INITIATED=0;d.READY_STATE_INITIATED=1;d.READY_STATE_LOADED=2;d.klangInited=!1;d.readyState=d.READY_STATE_NOT_INITIATED;var A;d.pushToEventQue=function(d){A=A||{};A[d]=arguments};d.triggerEvent=z;d.getDestinationForEvent=function(c){return(c=g.instance.findInstance(d.getEvents()[c]))?c.destination():null};d.init=function(c,n,h,e,f){-1!=navigator.userAgent.indexOf("Firefox")?d.browser="Firefox":-1!=navigator.userAgent.indexOf("Chrome")?
d.browser="Chrome":-1!=navigator.userAgent.indexOf("Safari")?d.browser="Safari":-1!=navigator.userAgent.indexOf("Opera")?d.browser="Opera":-1!=navigator.userAgent.indexOf("MSIE")&&(d.browser="IE");d.initOptions=f=f||{};d.isMobile=l.checkMobile();d.isIOS=l.checkIOS();"object"==typeof c&&c.settings&&c.settings.force_logging&&(d.loggingEnabled=!0);if(d.klangInited)d.warn("Klang already initialized");else{d.klangInited=!0;d.readyState=d.READY_STATE_NOT_INITIATED;if(void 0===window.AudioContext||f.noWebAudio){d.version=
"audiotag";try{d.audioTagHandler=new K(c,function(c){d.readyState=d.READY_STATE_LOADED;n&&n(c);u()},h)}catch(k){return d.err("Klang exception: unable to initialize audio tag fallback"),d.version="failed audiotag",n(!1),!1}return!0}d.context||(d.context=new AudioContext);try{return d.version="webaudio",g.isInited()&&d.warn("Klang already initialized"),g.instance.loadJSON(c,function(c){d.readyState=d.READY_STATE_LOADED;n&&n(c);u()},h),!0}catch(p){return d.err("Klang exception: unable to parse config file: '"+
c+"': "+p.name+": "+p.message),d.version="failed web audio",n(!1),!1}}};d.initIOS=function(){if("webaudio"==d.version)try{g.instance.initIOS()}catch(c){d.err("Klang exception: unable to init iOS: "+c.name+": "+c.message)}else"audiotag"==d.version&&d.isMobile&&d.audioTagHandler.initIOS()};d.getLoadGroups=function(){var c=[];if("webaudio"===d.version)c=x.FileHandler.instance;else if("audiotag"===d.version)c=d.audioTagHandler;else return[];var c=c.getLoadGroups(),g=c.indexOf("auto");-1!==g&&c.splice(g,
1);return c};d.getCoreInstance=function(){return g.instance};d.getFileHandlerInstance=function(){return x.FileHandler.instance};d.getUtil=function(){return l};d.getModel=function(){return x};d.schedule=function(c,n){if("webaudio"!==d.version)return d.err("Schedule only availible in WebAudio version"),this;"number"===typeof c&&"function"===typeof n?g.instance.scheduler.at(c,n):d.err(".schedule requires arg0 - time in seconds and arg1 - a callback function");return this};d.createObject=function(d,g){if(!x[d])throw Error("No such object");
return new x[d](g)};d.setDebugFlag=function(d,n){g.debugSettings[d]=n};d.load=function(c,n,h,e){try{d.logc("Klang: Loading: '"+c+"'",l.LOG_LOAD_COLOR),"webaudio"==d.version?g.instance.loadSoundFiles(c,n,h,e):"audiotag"==d.version?d.audioTagHandler.loadSoundFiles(c,n,h,e):(h&&h(1),n&&n(!1))}catch(f){d.err("Klang exception: unable to load file group: '"+c+"': "+f.name+": "+f.message)}};d.free=function(c){try{d.logc("Klang: Freeing: '"+c+"'",l.LOG_LOAD_COLOR),"webaudio"==d.version&&g.instance.freeSoundFiles(c)}catch(n){d.err("Klang exception: unable to free file group: '"+
c+"': "+n.name+": "+n.message)}};d.getLoadProgress=function(){return x.FileHandler.instance.progress};d.stopAll=function(){"webaudio"==d.version?g.isInited()&&g.instance.stopAll():"audiotag"==d.version&&d.audioTagHandler.stopAll()};d.$=function(c,n){if("webaudio"==d.version&&g.isInited()){if(0===c.indexOf(".")){var h=c.substring(1),e=[],f=d.getCoreInstance()._objectTable,k;for(k in f)if(f.hasOwnProperty(k)){var l=f[k];l._type===h&&e.push(l)}return e}h=g.instance.getSymbolId(c);return g.instance.findInstance(h)}};
d.log=function(){for(var c=[],g=0;g<arguments.length-0;g++)c[g]=arguments[g+0];d.loggingEnabled&&("Chrome"==d.browser?console.log("%c["+B()+"] "+c.join(),"color:"+l.LOG_TIME_COLOR):console.log.apply(console,c))};d.logc=function(c,g){d.loggingEnabled&&("Chrome"==d.browser?(g||(g="gray"),console.log("%c["+B()+"] "+c,"color:"+g)):console.log(c))};d.warn=function(){for(var c=[],g=0;g<arguments.length-0;g++)c[g]=arguments[g+0];d.loggingEnabled&&("Chrome"==d.browser?console.warn("%c["+d.getTimeString()+
"] "+c.join(),"color:"+l.LOG_WARN_COLOR):console.warn.apply(console,c))};d.err=function(){for(var c=[],g=0;g<arguments.length-0;g++)c[g]=arguments[g+0];d.loggingEnabled&&("Chrome"==d.browser?console.warn("%c["+d.getTimeString()+"] "+c.join(),"color:"+l.LOG_ERROR_COLOR):console.warn.apply(console,c))};d.zeropad=y;d.getTimeStamp=function(d){return y(d.getUTCMinutes(),2)+":"+y(d.getUTCSeconds(),2)+"."+y(d.getUTCMilliseconds(),3)};d.getTimeString=B;d.getEvents=function(){return"flash"===d.version?null:
"audiotag"==d.version?d.audioTagHandler._events:g.instance._eventTable};d.debugData={ignoredEvents:{},logToConsole:!0};d.visualWindow;d.setCallbacks=function(d){g.instance.setCallbacks(d)};d.schedulePredefinedEvents=function(c){var g=0,h=setInterval(function(){for(var e=d.context.currentTime,f=c[g];f.time<e;)if(z(f.name,f.args),g++,g==c.length){clearInterval(h);break}else f=c[g]},10)};d.deinit=function(c,l){d.klangInited=!1;"webaudio"==d.version?g.isInited()&&(g.instance.stopAll(),g.deinit()):"audiotag"==
d.version&&d.audioTagHandler.stopAll();d.version="n/a"};var x;(function(c){function n(d,b,a,q,w){"undefined"===typeof w&&(w="linear");var c;if("linear"==w)w=function(a){return 1-a},c=function(a){return a};else if("equalpower"==w)w=function(a){return Math.pow(1-a,.5)},c=function(a){return Math.pow(a,.5)};else return;a=Math.min(a,d.length);q=Math.min(q,b);for(var F=0;F<d.numberOfChannels;F++){for(var e=d.getChannelData(F),f=a-1,h=b-1,g=q-1;0<=g;g--){var k=(g+1)/(q+1);e[f]=e[f]*w(k)+e[h]*c(k);f--;h--}f=
a;for(h=b;f<d.length;)e[f++]=e[h++]}}function h(c,b){(0>b||3<b)&&d.warn("Synth: Invalid noise algorithm: "+b);var a=c||65536,q=d.context.createBuffer(1,a,d.context.sampleRate),w=q.getChannelData(0);b||(b=0);for(var v=0;v<a;v++)switch(b){case 0:w[v]=2*Math.random()-1;break;case 1:w[v]=Math.random();break;case 2:w[v]=Math.random()-1;break;case 3:w[v]=v/a}return q}var e=function(){function d(){}d.prototype.on=function(b,a,q){this._events=this._events||{};(this._events[b]||(this._events[b]=[])).push({callback:a,
ctxArg:q,context:q||this});return this};d.prototype.off=function(b,a,q){var d,c,r,e;if(!this._events||!this._events[b])return this;b||a||q||(this._events={});var f=this._events[b];if(f){e=[];if(a&&q)for(d=0,c=f.length;d<c;d++)r=f[d],a!==r.callback&&q!==r.ctxArg&&e.push(f[d]);else if(a)for(d=0,c=f.length;d<c;d++)r=f[d],a!==r.callback&&e.push(f[d]);else if(q)for(d=0,c=f.length;d<c;d++)r=f[d],q!==r.ctxArg&&e.push(f[d]);this._events[b]=e}this._events[b].length||delete this._events[b];return this};d.prototype.trigger=
function(b){for(var a=[],q=0;q<arguments.length-1;q++)a[q]=arguments[q+1];if(!this._events||!this._events[b])return this;var d,c;c=this._events[b];a=[].splice.call(arguments,1);for(q=c.length-1;0<=q;q--)d=c[q],d.callback.apply(d.context,a);return this};return d}();c.EventEmitter=e;var f=function(){function c(){this._files={};this._groups={};this._lastSentPercent=-1}c.inst=null;Object.defineProperty(c,"instance",{get:function(){null==c.inst&&(c.inst=new c);return c.inst},enumerable:!0,configurable:!0});
c.prototype.sendProgressCallback=function(b){b=this._groups[b];if(b.progressCallback&&!b.loadInterrupted){var a=0;b.progress.readyAudioFiles>=b.progress.totalAudioFiles&&(a=Math.floor((b.progress.loadedBytes+b.progress.bufferedFiles)/(b.progress.totalBytes+b.progress.totalFiles)*(100-(b.progress.totalFiles-b.progress.convertedFiles))));this._lastSentPercent!==a&&b.progressCallback(a);this._lastSentPercent=a}};c.prototype.updateProgress=function(b,a){var q=b.load_group;if(!b.sizeReceived){b.sizeReceived=
!0;var d=1;a.lengthComputable&&(d=a.total,b.loadedBytes=0);b.totalBytes=d;this._groups[q].progress.totalBytes+=d;this._groups[q].progress.readyAudioFiles++}void 0!=b.loadedBytes&&(d=a.loaded-b.loadedBytes,b.loadedBytes=a.loaded,this._groups[q].progress.loadedBytes+=d,this.sendProgressCallback(q))};c.prototype.loadAudioBuffer=function(b,a){var q=this,w=new XMLHttpRequest,c=".ogg";if("Safari"===d.browser||"Netscape"===d.detector.browser.name)c=".mp3";w.open("GET",(b.external?"":this._baseURL)+b.url+
c,!0);w.responseType="arraybuffer";w.sizeReceived=!1;w.load_group=b.load_group;w.onprogress=function(a){q.updateProgress(w,a)};w.onload=function(c){d.context.decodeAudioData(w.response,function(v){var e=q._groups[b.load_group];e.progress.loadedBytes=w.loadedBytes?e.progress.loadedBytes+(w.totalBytes-w.loadedBytes):e.progress.loadedBytes+1;if(d.useMonoBuffers){var r=v.length,f=d.context.createBuffer(1,r,d.context.sampleRate);v=v.getChannelData(0);for(var h=f.getChannelData(0),g=0;g<r;g++)h[g]=v[g];
v=f}q.addFile(b,v);e.progress.convertedFiles++;q.updateProgress(w,c);a&&a();w=null},function(a){d.log("Klang warning: unable to load file '"+(this._baseURL||"")+b.url+"'")});w.response=null};w.onreadystatechange=function(){4==w.readyState&&200==w.status||200==w.status||(q._groups[b.load_group].loadInterrupted=!0,q._groups[b.load_group].loadFailedCallback&&q._groups[b.load_group].loadFailedCallback())};w.send();this._groups[b.load_group].progress.totalAudioFiles++};c.prototype.loadMidiFile=function(b,
a){var q=this;loadRemote(this._baseURL+b.url,function(a,b){q.updateProgress(a,b)},function(d){q.addFile(b,readMidiFile(d));a&&a()})};c.prototype.loadMidiString=function(b){var a=this,q=new XMLHttpRequest;q.open("GET",this._baseURL+b.url);q.onprogress=function(b){a.updateProgress(q,b)};q.onreadystatechange=function(){4==this.readyState&&200==this.status&&a.addFile(b,readMidiString(q.response))};q.send()};c.prototype.loadFiles=function(b,a,q,d){"string"==typeof b&&(b=[b]);for(var c=0,e=b.length;c<e;c++)this._groups[b[c]]=
{},this._groups[b[c]]._loadedFiles=[],this._groups[b[c]].filesLoadedCallback=a,this._groups[b[c]].progressCallback=q,this._groups[b[c]].loadFailedCallback=d,this._groups[b[c]].loadInterrupted=!1,this._groups[b[c]].progress={totalBytes:0,loadedBytes:0,totalFiles:0,totalAudioFiles:0,readyAudioFiles:0,bufferedFiles:0,convertedFiles:0};c=0;for(e=this._fileInfo.length;c<e;c++)if(a=this._fileInfo[c],q=b.indexOf(a.load_group),-1!=q&&!this._files[a.id]&&!a.only_audio_tag){switch(a.file_type){case "audio":this.loadAudioBuffer(a);
break;case "midi":this.loadMidiFile(a);break;case "midistring":this.loadMidiString(a)}this._groups[b[q]].progress.totalFiles++}c=0;for(e=b.length;c<e;c++)0==this._groups[b[c]].progress.totalFiles&&this._groups[b[c]].filesLoadedCallback&&!this._groups[b[c]]._loadInterrupted&&this._groups[b[c]].filesLoadedCallback(!0,this._groups[b[c]]._loadedFiles)};c.prototype.prepareFile=function(b){this._fileInfo.push(b)};c.prototype.prepareFiles=function(b){var a,q;a=0;for(q=b.length;a<q;a++)this.prepareFile(b[a])};
c.prototype.addFile=function(b,a){this._files[b.id]=a;this._groups[b.load_group].progress.bufferedFiles++;this._groups[b.load_group]._loadedFiles=this._groups[b.load_group]._loadedFiles||[];this._groups[b.load_group]._loadedFiles.push(b);this.sendProgressCallback(b.load_group);this._groups[b.load_group].progress.bufferedFiles!=this._groups[b.load_group].progress.totalFiles||this._groups[b.load_group].loadInterrupted||this._groups[b.load_group].filesLoadedCallback&&this._groups[b.load_group].filesLoadedCallback(!0,
this._groups[b.load_group]._loadedFiles||[])};c.prototype.freeSoundFiles=function(b){"string"==typeof b&&(b=[b]);for(var a=0,q=this._fileInfo.length;a<q;a++){var d=this._fileInfo[a];-1!=b.indexOf(d.load_group)&&(this._files[d.id]=null)}};c.prototype.getLoadGroups=function(){var b,a=this._fileInfo||[],q={},d=[];for(b=0;b<a.length;b++){var c=a[b];q[c.load_group]=c.load_group}for(b in q)d.push(b);return d};c.prototype.getFile=function(b){return this._files[b]||null};c.prototype.getFilesForLoadgroup=
function(b){for(var a=[],q=0,d=this._fileInfo.length;q<d;q++)this._fileInfo[q].load_group==b&&a.push(this._fileInfo[q]);return a};c.prototype.getFileInfo=function(b){for(var a=0,q=this._fileInfo.length;a<q;a++)if(this._fileInfo[a].id==b)return this._fileInfo[a]};Object.defineProperty(c.prototype,"progress",{get:function(){return this._groups},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"baseURL",{set:function(b){this._baseURL=b},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,
"fileInfo",{set:function(b){this._fileInfo=b},enumerable:!0,configurable:!0});return c}();c.FileHandler=f;var k=function(){function c(b,a){this._name=a;this._type=b.type;this._output=d.context.createGain();this._volume=void 0!=b.volume?b.volume:1;this._output.gain.value=this._volume;b.destination_name&&(this.destinationName=b.destination_name,g.instance.initComplete||g.instance.pushToConnectStack(this))}c.prototype.connect=function(b){d.warn("Audio: Invocation of abstract method: Audio.connect in",
this);return this};c.prototype.disconnect=function(){d.warn("Audio: Invocation of abstract method: Audio.disconnect in",this);return this};c.prototype.play=function(b,a){d.warn("Audio: Invocation of abstract method: Audio.play in",this);return this};c.prototype.stop=function(b){d.warn("Audio: Invocation of abstract method: Audio.stop in",this);return this};c.prototype.pause=function(){d.warn("Audio: Invocation of abstract method: Audio.pause in",this);return this};c.prototype.unpause=function(){d.warn("Audio: Invocation of abstract method: Audio.unpause in",
this);return this};c.prototype.curvePlaybackRate=function(b,a){d.warn("Audio: Invocation of abstract method: Audio.curvePlaybackRate in",this);return this};c.prototype.fadeInAndPlay=function(b,a){console.warn("Audio: Invocation of abstract method: Audio.fadeInAndPlay in",this);return this};c.prototype.fadeOutAndStop=function(b,a){console.warn("Audio: Invocation of abstract method: Audio.fadeOutAndStop in",this);return this};c.prototype.deschedule=function(){console.warn("Audio: Invocation of abstract method: Audio.deschedule in",
this);return this};Object.defineProperty(c.prototype,"playbackRate",{set:function(b){d.warn("Audio: Invocation of abstract property: Audio.playbackRate in",this);return this},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"playing",{get:function(){d.warn("Audio: Invocation of abstract property: Audio.playing in",this);return!1},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"duration",{get:function(){d.warn("Audio: Invocation of abstract property: Audio.duration in",
this);return 0},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"output",{get:function(){return this._output},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"playbackState",{get:function(){d.warn("Audio: Invocation of abstract property: Audio.playbackState in",this);return 0},enumerable:!0,configurable:!0});c.prototype.setData=function(b){this._volume=void 0==b.volume?1:b.volume;this._output.gain.value=this._volume;this.destinationName!=b.destination_name&&(this.destinationName=
b.destination_name,this.disconnect(),this.connect(g.instance.findInstance(this.destinationName).input))};return c}();c.Audio=k;var L=function(e){function b(a,b){e.call(this,a,b);this._sources=[];this._loopStartTime=this._startTime=0;this._scheduleAhead=.2;this._paused=this._fading=this._stopping=!1;this._pauseStartTime=this._pauseTime=-1;this.data=a;this.editorName=a.editorName;this._fileId=a.file_id;this._playbackRate=a.playback_rate||1;this._endTime=0;this._loop=void 0!=a.loop?a.loop:!1;this._loopStart=
a.loop_start;this._loopEnd=a.loop_end;this._offset=a.offset||0;this._duration=a.duration||0;this._reverse=a.reverse;this._retrig=void 0!=a.retrig?a.retrig:!0;this._lockPlaybackrate=void 0!=a.lock_playback_rate?a.lock_playback_rate:!1;this._volumeStartRange=a.volume_start_range;this._volumeEndRange=a.volume_end_range;this._pitchStartRange=a.pitch_start_range;this._pitchEndRange=a.pitch_end_range;a.panner&&(this._panner=a.panner);if(a.granular){this._granular={bufferDuration:0,speed:a.granular.speed||
.3333,pitch:a.granular.pitch||0,pitchRandomization:a.granular.pitch_randomization||0,timeRandomization:a.granular.time_randomization||0,realTime:0,grainTime:0,grainDuration:a.granular.grain_duration||.09,grainSpacing:a.granular.grain_spacing||.045,grainWindow:null};this._granular.grainWindow=new Float32Array(16384);for(var d=0;16384>d;++d)this._granular.grainWindow[d]=Math.sin(Math.PI*d/16384)}g.instance.pushToPostLoadInitStack(this)||this.init()}p(b,e);b.prototype.init=function(){this._fileId&&("string"==
typeof this._fileId?this._buffer=f.instance.getFile(this._fileId):this._fileId.sampleRate&&(this._buffer=this._fileId));if(this._buffer){this._duration||(this._duration=this._buffer.duration);this._granular&&(this._granular.bufferDuration=this._buffer.duration-.05);if(this._reverse){for(var a=d.context.createBuffer(this._buffer.numberOfChannels,this._buffer.length,d.context.sampleRate),b=0;b<this._buffer.numberOfChannels;b++)for(var c=this._buffer.getChannelData(b),v=a.getChannelData(b),e=c.length,
r=e-1;0<=r;r--)v[e-r]=c[r];this._buffer=a}if(this.data.xfade){a=d.context.createBuffer(this._buffer.numberOfChannels,this._buffer.length,d.context.sampleRate);for(b=0;b<this._buffer.numberOfChannels;b++)for(c=this._buffer.getChannelData(b),v=a.getChannelData(b),e=c.length,r=e-1;0<=r;r--)v[r]=c[r];this._buffer=a;e=d.context.sampleRate;b=!0===this.data.xfade?11025:this.data.xfade*e;c=void 0==this._loopStart?b:Math.round(this._loopStart*e);e=void 0==this._loopEnd?this._buffer.length:Math.round(this._loopEnd*
e);n(this._buffer,c,e,b)}}};b.prototype.setLoopRegion=function(a,b){this._loopStart=a||this._loopStart;this._loopEnd=b||this._loopEnd;for(var d=0,c=this._sources.length;d<c;d++){var e=this._sources[d];e.loopStart=this._loopStart;e.loopEnd=this._loopEnd}return this};b.prototype.connect=function(a,b){if(!this._destination||b)this._destination=a,this._panner?(this._output.connect(this._panner.input),this._panner.output.connect(a)):this._output.connect(a);return this};b.prototype.disconnect=function(){this._output.disconnect();
this._destination=null;this._panner&&this._panner.output.disconnect();return this};b.prototype.scheduleGrain=function(){if(this._buffer){var a=this._granular,b=d.context.createBufferSource();b.buffer=this._buffer;var c=Math.random(),v=Math.random();Math.random();Math.random();Math.random();var c=2*(c-.5),v=2*(v-.5),e=d.context.createGain();b.connect(e);e.connect(this._output);c=Math.pow(2,(this._granular.pitch+c*a.pitchRandomization)/1200);b.playbackRate.value=c;b.start(a.realTime,a.grainTime+v*a.timeRandomization,
a.grainDuration);b=a.grainDuration/c;e.gain.value=0;e.gain.setValueCurveAtTime(a.grainWindow,a.realTime,b);a.realTime+=a.grainSpacing;a.grainTime+=a.speed*a.grainSpacing;a.grainTime>a.bufferDuration&&(a.grainTime=0,this._loop||this.stop());0>a.grainTime&&(a.grainTime+=a.bufferDuration,this._loop||this.stop())}};b.prototype.granularSchedule=function(a){for(;this._granular.realTime<a+.1;)this.scheduleGrain();var b=this;this._granular.scheduleId=setTimeout(function(){b.granularSchedule(d.context.currentTime)},
20)};b.prototype.play=function(a,b,c){"undefined"===typeof a&&(a=0);"undefined"===typeof b&&(b=0);"undefined"===typeof c&&(c=!1);this.removeUnusedSources();if(!this._buffer&&(this.init(),!this._buffer)){d.warn("AudioSource: Buffer not found!",this._name);return}a=a||0;if(this._granular)this.granularSchedule(a);else{if(0!=a&&a+.01<=d.context.currentTime)return d.warn("AudioSource: Returned, playTime < currentTime",this._name),this;0==a&&(a=d.context.currentTime);this.output.gain.cancelScheduledValues(a);
void 0!=this._volumeStartRange?this.output.gain.setValueAtTime(this._volume*(Math.random()*(this._volumeEndRange-this._volumeStartRange)+this._volumeStartRange),a):this.output.gain.setValueAtTime(this._volume,a);this.paused||(this._pauseStartTime=a);c||(this._pauseTime=0);this._startTime=a;this._loopStartTime=a+this.duration;this._paused=!1;if(this._stopping&&!this._retrig){this.output.gain.cancelScheduledValues(a);this.output.gain.setValueAtTime(this.output.gain.value,a);this.output.gain.linearRampToValueAtTime(this._volume,
a+.25);clearTimeout(this._stoppingId);this._stopping=!1;return}this._fading=!1;if(this._retrig||this.loop)if(this.loop&&!this._retrig){if(-1==this._endTime||a<this._endTime)return}else{if(this.loop&&this._retrig&&this.playing&&!this._stopping)return;if(this._stopping)this._stopping=!1;else if(Math.round(1E3*this._endTime)/1E3==Math.round(1E3*(a+this._buffer.duration))/1E3)return d.warn("AudioSource: Returned, Doubletrig",this._name),this}else if(a<this._endTime)return;this._endTime=this.loop?-1:a+
this._buffer.duration;c=this.createBufferSource();c.buffer=this._buffer;this._loop&&(c.loop=!0,c.loopStart=this._loopStart?this._loopStart:0,c.loopEnd=this._loopEnd?this._loopEnd:this._buffer.duration);this._destination||d.warn("AudioSource: no destination node");"object"!=typeof this._destination&&d.warn("AudioSource: destination is not an object",this._name);c.connect(this._output);b>this._duration&&(b%=this._duration);this._startOffset=this._offset+b;b=this._duration;void 0!=this._pitchStartRange&&
(c.playbackRate.value=this._playbackRate*(Math.random()*(this._pitchEndRange-this._pitchStartRange)+this._pitchStartRange));c.startTime=a;c.start(a,this._startOffset,b||c.buffer.duration);g.callbacks&&g.callbacks.scheduleAudioSource&&g.callbacks.scheduleAudioSource({audio:this,startTime:a})}return this};b.prototype.getNumberOfSamples=function(){return this._buffer.length};b.prototype.stop=function(a){"undefined"===typeof a&&(a=0);if(this._granular)clearTimeout(this._granular.scheduleId);else{this._stopping&&
(this._stopping=!1,clearTimeout(this._stoppingId));var b=this._sources.length;if(0<b)if(a=a||l.now(),this._loop&&(this._loopPlaying=!1),this._endTime=a,this._retrig)this._sources[this._sources.length-1].stop(a),this._sources.splice(this._sources.length-1,1);else{for(var d=0;d<b;d++)this._sources[d].stop(a),this._endTime=l.now();this._sources=[]}else this._loopPlaying=!1}return this};b.prototype.deschedule=function(){for(var a=0;a<this._sources.length;a++){var b=this._sources[a];b.startTime>d.context.currentTime&&
(b.stop(0),this._sources[a].disconnect(),b.disconnect(),this._sources.splice(a,1),a--)}return this};b.prototype.pause=function(){if(this._endTime>l.now()){this._paused=!0;var a=l.now()-this._startTime;this._pauseTime+=a;this.stop()}return this};b.prototype.unpause=function(){if(this.paused){var a=this._offset;this._offset+=this._pauseTime;this.play(0,0,!0);this._offset=a;this._paused=!1}return this};b.prototype.createBufferSource=function(){var a=d.context.createBufferSource();a.playbackRate.value=
this._playbackRate;this._sources.push(a);return a};b.prototype.fadeInAndPlay=function(a,b,c){"undefined"===typeof c&&(c=0);var v=d.context.currentTime;b||(b=v);if(!this.loop||this._retrig||!(-1==this._endTime||b<this._endTime)||this._stopping)if(!(this.loop&&this._retrig&&this.playing)||this._stopping){this.output.gain.cancelScheduledValues(b);if(this._stopping&&!this._retrig)clearTimeout(this._stoppingId),this.output.gain.setValueAtTime(this.output.gain.value,b);else{if(this._stopping&&this._retrig){this._fading=
!0;this.play(b==v?0:b,c);c=d.context.createGain();this._sources[this._sources.length-1].disconnect();this._sources[this._sources.length-1].connect(c);c.connect(this.output);c.gain.setValueAtTime(0,b);c.gain.linearRampToValueAtTime(1,b+a);this._stopping=!1;return}this._fading=!0;this.play(b==v?0:b,c);this.output.gain.setValueAtTime(0,b)}this._stopping=!1;this.output.gain.linearRampToValueAtTime(this._volume,b+a);return this}};b.prototype.fadeOutAndStop=function(a,b){if(this.playing){void 0==b&&(b=
d.context.currentTime);this._stopping&&clearTimeout(this._stoppingId);if(this._retrig&&!this._stopping){var c=d.context.createGain();this._sources[this._sources.length-1].disconnect();this._sources[this._sources.length-1].connect(c);var v=this;this._sources[this._sources.length-1].hasOwnProperty("onended")?this._sources[this._sources.length-1].onended=function(){v._stopping=!1}:this._stoppingId=setTimeout(function(){v._stopping=!1},1E4*(a+(b-l.now())-v._scheduleAhead));c.connect(this.output);c.gain.setValueAtTime(1,
b);c.gain.linearRampToValueAtTime(0,b+a);this.stop(b+a)}else this._retrig||(this.output.gain.cancelScheduledValues(b),this.output.gain.setValueAtTime(this.output.gain.value||this._volume,b),this.output.gain.linearRampToValueAtTime(0,b+a),v=this,this._stoppingId=setTimeout(function(){v._stopping&&(v._stopping=!1,v.loop&&(v._loopPlaying=!1),v.stop(b+a))},(a+(b-l.now())-v._scheduleAhead)/.001));this._stopping=!0;return this}};b.prototype.removeUnusedSources=function(){for(var a=0;a<this._sources.length;a++){var b=
this._sources[a];if(!b.buffer||!this.loop&&b.startTime+b.buffer.duration<d.context.currentTime)this._sources[a].disconnect(),this._sources.splice(a,1),a--}};b.prototype.curvePlaybackRate=function(a,b){if(!this._lockPlaybackrate){var d=this.playbackRateNode;d&&(d.cancelScheduledValues(l.now()),d.setValueAtTime(0==d.value?l.EXP_MIN_VALUE:d.value,l.now()),d.exponentialRampToValueAtTime(a,l.now()+b));this._playbackRate=a;return this}};Object.defineProperty(b.prototype,"lastSource",{get:function(){var a=
this._sources.length;return 0==a?null:this._sources[a-1]},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"loop",{get:function(){return this._loop},set:function(a){this._loop=a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"offset",{get:function(){return this._offset},set:function(a){"string"===typeof a&&-1!==a.indexOf("%")&&(a=this._duration*parseFloat(a));this._offset=a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"position",{get:function(){if(!this.playing||
!this._duration)return 0;var a=this._duration;if(this._loopStart||this._loopEnd)a=(this._loopEnd||a)-(this._loopStart||0);var b=l.now()-this._startTime,d=l.now()+this._startOffset-this._loopStartTime;return this._startOffset+b>this._duration?this._loopStart+d%a:this._startOffset+b},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"duration",{get:function(){return this._duration},set:function(a){this._duration=a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"paused",
{get:function(){return this._paused},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"playbackRate",{get:function(){return this._playbackRate},set:function(a){if(!this._lockPlaybackrate){var b=this.playbackRateNode;b&&b.cancelScheduledValues(l.now());this._playbackRate=a;a=0;for(b=this._sources.length;a<b;a++)this._sources[a].playbackRate.value=this._playbackRate}},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"nextPlaybackRate",{set:function(a){this._lockPlaybackrate||
(this._playbackRate=a)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"playbackRateNode",{get:function(){var a=this.lastSource;return a&&a.playbackRate},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"buffer",{get:function(){this._buffer||(this._buffer=f.instance.getFile(this._fileId));return this._buffer},set:function(a){this._buffer=a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"playing",{get:function(){return-1==this._endTime||this._endTime>
l.now()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"playbackState",{get:function(){var a=this.lastSource;return a?a.playbackState:0},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"output",{get:function(){return this._panner?this._panner.output:this._output},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"panner",{get:function(){return this._panner},enumerable:!0,configurable:!0});b.prototype.freeBuffer=function(){this._buffer=null;for(var a=
0,b=this._sources.length;a<b;a++){try{this._sources[a].stop(0)}catch(d){}this._sources[a].disconnect();this._sources[a]=null}this._sources=[]};b.prototype.setData=function(a){e.prototype.setData.call(this,a);var b=!1;this._volumeStartRange=a.volume_start_range;this._volumeEndRange=a.volume_end_range;this._pitchEndRange=a.pitch_end_range;this._pitchStartRange=a.pitch_start_range;void 0!=a.file_id&&this._fileId!=a.file_id&&(this._fileId=a.file_id,b=!0);this._playbackRate=void 0==a.playback_rate?1:a.playback_rate;
this.playbackRateNode&&(this.playbackRateNode.value=this._playbackRate);this._loop=void 0==a.loop?!1:a.loop;this.lastSource&&(this.lastSource.loop=this._loop);this._loop||(this._loopPlaying=!1);this._loopStart=void 0==a.loop_start?0:a.loop_start;this.lastSource&&(this.lastSource.loopStart=this._loopStart);this._loopEnd=void 0==a.loop_end?0:a.loop_end;this.lastSource&&(this.lastSource.loopEnd=this._loopEnd);var d=void 0==a.offset?0:a.offset;this._offset!=d&&(this._offset=d,b=!0);d=void 0==a.duration?
0:a.duration;this._duration!=d&&(this._duration=d,b=!0);this._retrig=void 0==a.retrig?!0:a.retrig;void 0==a.reverse&&(a.reverse=!1);this._reverse!=a.reverse&&(this._reverse=a.reverse,b=!0);void 0==a.xfade&&(a.xfade=!1);this.data.xfade!=a.xfade&&(b=!0);this.data=a;b&&this.init();if(a.granular)if(this._granular)void 0!=a.granular.speed&&(this._granular.speed=a.granular.speed),void 0!=a.granular.pitch&&(this._granular.pitch=a.granular.pitch),void 0!=a.granular.pitch_randomization&&(this._granular.pitchRandomization=
a.granular.pitch_randomization),void 0!=a.granular.time_randomization&&(this._granular.timeRandomization=a.granular.time_randomization),void 0!=a.granular.grain_duration&&(this._granular.grainDuration=a.granular.grain_duration),void 0!=a.granular.grain_spacing&&(this._granular.grainSpacing=a.granular.grain_spacing);else{this._granular={bufferDuration:this._buffer.duration-.05,speed:a.granular.speed||.3333,pitch:a.granular.pitch||0,pitchRandomization:a.granular.pitch_randomization||0,timeRandomization:a.granular.time_randomization||
0,realTime:0,grainTime:0,grainDuration:a.granular.grain_duration||.09,grainSpacing:a.granular.grain_spacing||.045,grainWindow:null};b=new Float32Array(16384);for(d=0;16384>d;++d)b[d]=Math.sin(Math.PI*d/16384);this._granular.grainWindow=b}else this._granular&&(clearTimeout(this._granular.scheduleId),this._granular=null);a.panner?this._panner?this._panner.setData(a.panner):(b=this._destination,this.disconnect(),this._panner=new c.Panner(a.panner),this.connect(b)):!a.panner&&this._panner&&(b=this._destination,
this.disconnect(),this._panner=null,this.connect(b))};return b}(k);c.AudioSource=L;c.crossfade=n;var m=function(c){function b(a,b){c.call(this,a,b);this._currentId=this._adder=0;this._paused=!1;this._groupType=void 0!=a.group_type?a.group_type:1;this._retrig=void 0!=a.retrig?a.retrig:!0;this._queue=void 0!=a.queue?a.queue:0;this._content=a.content||[];g.instance.pushToPreLoadInitStack(this)}p(b,c);b.prototype.init=function(){for(var a=[],b=0,d=this._content.length;b<d;b++)a.push(g.instance.findInstance(this._content[b]));
this._content=a};b.prototype.connect=function(a){for(var b=0,d=this._content.length;b<d;b++){var c=this._content[b];c.disconnect();c.connect(this._output)}this._output.connect(a);return this};b.prototype.disconnect=function(){this._output.disconnect();return this};b.prototype.play=function(a,b,c){if(this._content.length){var v=this.latestPlayed?this.latestPlayed.playing:!1;if(!c&&!this._retrig&&v)return 0!=this._queue&&(1==this._queue&&this._latestStartTime>d.context.currentTime?(this.latestPlayed.stop(),
this.play(this._latestStartTime,b,!0)):this.play(this._latestStartTime+this.latestPlayed.duration,b,!0)),this;this._paused=!1;if(void 0!=b){var e;"number"==typeof b?e=b:"string"==typeof b?e=this.getIdFromString(b):b._name&&(e=this.getIdFromString(b._name));this._content[e].play(a);this._latestPlayed=this._content[e]}else{if(0==this._groupType)for(b=0,c=this._content.length;b<c;b++)this._content[b].play(a);else this._currentId=this.getIdToPlay(),this._content[this._currentId].play(a);this._latestPlayed=
0===this._groupType?this._content[0]:this._content[this._currentId]}this._latestStartTime=a||d.context.currentTime;return this}};b.prototype.getIdToPlay=function(){var a;1==this._groupType?(a=0>this._adder?this._content.length-1+this._adder%this._content.length:this._adder%this._content.length,this._adder++):2==this._groupType?(a=Math.floor(Math.random()*(this._content.length-1)),1<this._content.length&&a==this._adder&&(a=(a+1)%this._content.length),a=this._adder=a):3==this._groupType?(0==this._adder%
this._content.length&&l.shuffle(this._content),a=this._adder%this._content.length,this._adder++):4==this._groupType&&(a=0>this._adder?this._content.length-1+this._adder%this._content.length:this._adder%this._content.length,this._adder--);return a};b.prototype.stop=function(a){this._content[this._currentId].stop(a);return this};b.prototype.pause=function(){this._paused=!0;this._latestPlayed&&this._latestPlayed.pause();return this};b.prototype.unpause=function(){this._paused=!1;this._latestPlayed&&
this._latestPlayed.unpause();return this};b.prototype.fadeInAndPlay=function(a,b){var d=this.latestPlayed?this.latestPlayed.playing:!1;if(this._retrig||!d)return this._currentId=this.getIdToPlay(),this._latestPlayed=this._content[this._currentId],this._content[this._currentId].fadeInAndPlay(a,b),this};b.prototype.fadeOutAndStop=function(a,b){void 0==b&&(b=d.context.currentTime);this._latestPlayed&&this._latestPlayed.fadeOutAndStop(a,b);return this};b.prototype.curvePlaybackRate=function(a,b){for(var d=
0,c=this._content.length;d<c;d++)this._content[d].curvePlaybackRate(a,b);return this};b.prototype.deschedule=function(){for(var a=0,b=this._content.length;a<b;a++)this._content[a].deschedule();return this};b.prototype.getIdFromString=function(a){for(var b=0,d=this._content.length;b<d;b++)if(this._content[b]._name==a)return b};Object.defineProperty(b.prototype,"playbackRate",{set:function(a){for(var b=0,d=this._content.length;b<d;b++)this._content[b].playbackRate=a},enumerable:!0,configurable:!0});
Object.defineProperty(b.prototype,"groupType",{get:function(){return this._groupType},set:function(a){this._groupType=a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"content",{get:function(){return this._content},set:function(a){this._content=a;this.init()},enumerable:!0,configurable:!0});b.prototype.addContent=function(a){this._content.push(a)};b.prototype.removeContent=function(a){for(var b=0;b<this._content.length;b++)this._content[b]._name===a&&this._content.splice(b,1)};
Object.defineProperty(b.prototype,"playing",{get:function(){return this._latestPlayed?this._latestPlayed.playing:!1},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"duration",{get:function(){return this._latestPlayed?this._latestPlayed.duration:this._content[0].duration},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"playbackState",{get:function(){return this._content[this._currentId].playbackState},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"latestPlayed",{get:function(){return this._latestPlayed},enumerable:!0,configurable:!0});b.prototype.setData=function(a){c.prototype.setData.call(this,a);this._groupType=void 0==a.group_type?1:a.group_type;this._retrig=void 0==a.retrig?!0:a.retrig;this._queue=void 0==a.queue?0:a.queue;a.content&&(this._content=a.content,this.init())};return b}(k);c.AudioGroup=m;m=function(){function c(b){this._startValue=b.start_value||0;this._points=b.points||[]}c.prototype.automate=function(b,a){a=a||d.context.currentTime;
b.cancelScheduledValues(a);b.setValueAtTime(this._startValue,a);for(var q=0,c=0,v=this._points.length;c<v;c++){var e=this._points[c];switch(e.curve){case "lin":b.linearRampToValueAtTime(e.value,a+e.time);break;case "exp":b.exponentialRampToValueAtTime(e.value,a+e.time);break;default:if(!l.CUSTOM_CURVES[e.curve]){d.warn("Automation: Invalid curve type: "+e.curve);break}b.setValueCurveAtTime(l.CUSTOM_CURVES[e.curve],a+q,e.time-q)}q=e.time}};return c}();c.Automation=m;m=function(){function c(b,a){this._name=
a;this._type=b.type;this._input=d.context.createGain();this._output=d.context.createGain();this._effects=b.effects||[];for(var q=0,w=this._effects.length;q<w;q++)!1===b.effects[q].active&&this._effects[q].setActive(!1);this._input.gain.value=void 0!==b.input_vol?b.input_vol:1;this._output.gain.value=void 0!==b.output_vol?b.output_vol:1;b.destination_name&&(this.destinationName=b.destination_name,g.instance.pushToConnectStack(this));g.instance.pushToPreLoadInitStack(this)}c.prototype.init=function(){for(var b=
this._input,a=0,d=this._effects.length;a<d;a++)b.disconnect(),b.connect(this._effects[a].input),b=this._effects[a];b.connect(this._output)};c.prototype.connect=function(b){this._output.connect(b);return this};c.prototype.disconnect=function(){this._output.disconnect();return this};c.prototype.insertEffect=function(b,a){var d=g.instance.createObject(void 0,b,{excludeFromTable:!0});void 0==a?this._effects.push(d):this._effects.splice(a,0,d);this.init();return this};c.prototype.moveEffect=function(b,
a){for(var d=0,c=this._effects.length;d<c;d++)this._effects[d].disconnect();d=this._effects[b];this._effects.splice(b,1);this._effects.splice(a,0,d);this.init();return this};Object.defineProperty(c.prototype,"input",{get:function(){return this._input},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"output",{get:function(){return this._output},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"effects",{get:function(){return this._effects},enumerable:!0,configurable:!0});
c.prototype.setData=function(b){this._input.gain.value=void 0==b.input_vol?1:b.input_vol;this._output.gain.value=void 0==b.output_vol?1:b.output_vol;if(b.effects.length<this.effects.length){this.input.disconnect();for(var a=!1,d=0;d<this._effects.length;d++)this._effects[d].disconnect(),a||(void 0==b.effects[d]?(this._effects.splice(d,1),a=!0):this._effects[d]._type!=b.effects[d].type&&(this._effects.splice(d,1),d--,a=!0));this.init()}else if(b.effects.length>this.effects.length)this.insertEffect(b.effects[b.effects.length-
1]);else for(d=0,a=this._effects.length;d<a;d++)this._effects[d].setData(b.effects[d]);this.destinationName!=b.destination_name&&(this.destinationName=b.destination_name,this.disconnect(),"$OUT"==this.destinationName?this.connect(g.instance._superMasterOutput):this.connect(g.instance.findInstance(this.destinationName).input))};return c}();c.Bus=m;m=function(c){function b(a,b){c.call(this,a,b);this._transpose=this._fadeTime=this._stepCount=this._syncStep=this._currentStep=this._totalStep=this._startStep=
0;this._scales={diatonic:[0,-1,0,-1,0,0,-1,0,-1,0,-1,0],dorian:[0,1,0,0,-1,0,1,0,1,0,0,-1],phrygian:[0,0,-1,0,-1,0,1,0,0,-1,0,-1],lydian:[0,1,0,1,0,1,0,0,1,0,1,0],mixolydian:[0,1,0,1,0,0,-1,0,-1,0,0,-1],aeolian:[0,-1,0,0,-1,0,-1,0,0,-1,0,-1],locrian:[0,0,-1,0,-1,0,0,-1,0,-1,0,-1],harmonicMinor:[0,1,0,0,-1,0,1,0,0,-1,1,0],melodicMinor:[0,1,0,0,-1,0,1,0,-1,0,1,0],majorPentatonic:[0,1,0,1,0,-1,1,0,1,0,-1,1],minorPentatonic:[0,-1,1,0,-1,0,1,0,-1,1,0,-1],doubleHarmonic:[0,0,-1,1,0,0,1,0,0,-1,1,0],halfDim:[0,
1,0,0,-1,0,0,-1,0,-1,0,-1],chromatic:[0,0,0,0,0,0,0,0,0,0,0,0],custom:[0,0,0,0,0,0,0,0,0,0,0,0]};this._state=t.Stopped;this._beatSubscription=a.beat_subscription||.25;this._midiFileId=a.file_id;this._midiTrackIx=a.midi_track||0;this._sequencerName=a.sequencer;this._synthName=a.synth;this._loop=void 0!=a.loop?a.loop:!0;this._length=a.length||0;this._nextClip=0;this._startStep=a.start_step||0;this._root=a.root||0;this._transpose=this._orgTranspose=a.transpose||0;this._scale=this._orgScale=a.scale;this._rootNote=
a.root_note||36;this._activeUpbeat=-1;if(a.upbeats){this._upbeats=[];for(var d=this._upbeatLoopOffset=0,e=a.upbeats.length;d<e;d++)this._upbeats.push({length:a.upbeats[d].length,step:a.upbeats[d].step,targetStep:a.upbeats[d].target_step,playInLoop:a.upbeats[d].play_in_loop})}g.instance.pushToPostLoadInitStack(this)}p(b,c);b.prototype.init=function(){this._sequencer=g.instance.findInstance(this._sequencerName);this._sequencer.registerPattern(this);"progression"===this._synthName?(this._synth="progression",
this._progression=!0,this._currentChord=[]):this._synth=g.instance.findInstance(this._synthName);(this._midiFile=f.instance.getFile(this._midiFileId))&&this.setupFile()};b.prototype.setupFile=function(){this._midiTrack=this._midiFile.tracks[this._midiTrackIx];void 0==this._midiTrack&&d.warn("MidiPattern: midi track out of bounds: "+this._midiTrackIx);this.recalculateBPM(this._sequencer.bpm);var a=this._midiFile.header.ticksPerBeat,b=0;this._clips=[];for(var c=0,e=this._midiTrack.length;c<e;c++){var r=
this._midiTrack[c],b=b+r.deltaTime;this._clips.push({event:r,step:b/a-b/a%this._sequencer.resolution,offset:b%(a*this._sequencer.resolution)})}return this};b.prototype.connect=function(a){this._output.connect(a);return this};b.prototype.disconnect=function(){this._output.disconnect();return this};b.prototype.changeState=function(a){a!=this._state&&(g.callbacks&&g.callbacks.changePatternState&&g.callbacks.changePatternState({pattern:this,lastState:this._state,newState:a,step:this._sequencer.currentStep}),
this._state=a)};b.prototype.prePlaySchedule=function(a,b,c){if(!this._midiFile){this._midiFile=f.instance.getFile(this._midiFileId);if(!this._midiFile){d.warn("MidiPattern: midifile not found: "+this._name);return}this.setupFile()}c=c||!1;if(this._state==t.Playing)if(c)this._syncStep=b,this.stop(a,!0);else return this;this._syncStep=b%this._length;this._currentStep=this._startStep;this.findNextClip(this._currentStep);if(0<a){this._stepCount=a;this._currentStep+=this._syncStep;this._totalStep=this._syncStep=
0;this.changeState(t.PrePlaying);if(this._upbeats){this._activeUpbeat=-1;b=0;for(c=this._upbeats.length;b<c;b++){var e=this._upbeats[b];e.length<=a&&(-1==this._activeUpbeat||this._upbeats[this._activeUpbeat].length<e.length)&&(this._activeUpbeat=b)}-1!=this._activeUpbeat&&this._upbeats[this._activeUpbeat].playInLoop&&(this._upbeatLoopOffset=this._upbeats[this._activeUpbeat].length)}this.findNextClip(-1==this._activeUpbeat?this._currentStep:this._upbeats[this._activeUpbeat].step)}else this.changeState(t.Playing);
return this};b.prototype.play=function(a){if(!this._midiFile){this._midiFile=f.instance.getFile(this._midiFileId);if(!this._midiFile){d.warn("MidiPattern: midifile not found: "+this._name);return}this.setupFile()}if(this._state==t.Playing)return this;if(a&&0!=a){var b=this._output.gain.value;this._output.gain.setValueAtTime(0,0);this._output.gain.setValueAtTime(b,a)}this._currentStep=this._sequencer.currentStep%this._length+this._startStep;this.changeState(t.Playing);this.findNextClip(this._currentStep);
this._sequencer.started||this._sequencer.start();return this};b.prototype.restart=function(){this._currentStep=this._startStep;this._nextClip=0;return this};b.prototype.stop=function(a,b){this._synth.deschedule&&.5<this._sequencer._scheduleAheadTime&&this._synth.deschedule();if(void 0==a||this._state==t.Stopped)return this.changeState(t.Stopped),this;void 0==b&&(b=!0);b?(this._stepCount=this._sequencer.getStepsToNext(this._sequencer.beatLength*a),this.changeState(t.PreStopping)):(this.changeState(t.Stopped),
"progression"!==this._synth&&this._synth._loopedSamples&&this._synth.stop(a));return this};b.prototype.pause=function(){return this};b.prototype.unpause=function(){return this};b.prototype.sendMidiEvents=function(a,b,c){for(var e=this._nextClip;this._clips[this._nextClip].step==a;){var r=this._clips[this._nextClip];if(this._progression)"noteOn"===r.event.subtype?this._currentChord.push(r.event.noteNumber):"noteOff"===r.event.subtype&&(f=this._currentChord.indexOf(r.event.noteNumber),-1<f&&this._currentChord.splice(f,
1));else{var f=0;r.event.noteNumber&&(this._scale&&(f=r.event.noteNumber%12-this._root,0>f&&(f+=12),f=this._scales[this._scale][f]),0!=this._transpose&&(f+=this._transpose));c&&"noteOn"===r.event.subtype||this._synth.handleMidiEvent(r.event,b+r.offset*this._secPerTick,f)}this._nextClip++;this._nextClip==this._clips.length&&(this._nextClip=0);if(this._nextClip===e){d.log("MidiPattern",this._name,"got stuck, check if you're playing the correct midi track.");break}}if(this._progression&&this._currentChord.length){this._currentChord.sort(function(a,
b){return a-b});a=this._currentChord[0];e=a%12;f=0;e!=this._root&&(f=a-this._rootNote);b=[0,0,0,0,0,0,0,0,0,0,0,0];c=[];for(r=0;r<this._currentChord.length;r++){var h=this._currentChord[r]%12-e;0>h&&(h+=12);c.push(h)}c.sort(function(a,b){return a-b});for(e=0;e<b.length;e++)r=this.getClosestValues(c,e),void 0!==r&&(b[e]=r-e);this._sequencer.customScale=b;this._sequencer.transpose=f;this._rootNote=a}};b.prototype.getClosestValues=function(a,b){for(var d=-1,c=a.length;1<c-d;){var e=Math.round((d+c)/
2);a[e]<=b?d=e:c=e}a[d]==b&&(c=d);d=Math.abs(b-c)>Math.abs(b-d)?d:Math.abs(b-c)<Math.abs(b-d)?c:d;return a[d]};b.prototype.findNextClip=function(a){for(var b=0,d=this._clips.length;b<d;b++)if(this._clips[b].step>=a)return this._nextClip=b};b.prototype.playStep=function(a,b){var d=!0;this._currentStep>=this._length+this._startStep&&(this.sendMidiEvents(this._length,b,!0),this._currentStep=this._startStep,this.findNextClip(this._currentStep),this._loop||(this.changeState(t.Stopped),d=!1));d&&this.sendMidiEvents(this._currentStep,
b,!1);this._totalStep+=this._beatSubscription;this._currentStep+=this._beatSubscription};b.prototype.update=function(a,b){if(this._state!=t.Stopped&&0==a%this._beatSubscription)switch(this._upbeats&&-1!=this._activeUpbeat&&this._upbeats[this._activeUpbeat].playInLoop&&this._state==t.Playing&&this._currentStep>=this._length+this._startStep-this._upbeatLoopOffset&&(0<this._upbeatLoopOffset&&(this._stepCount=this._upbeatLoopOffset,this.changeState(t.PrePlaying)),this.sendMidiEvents(this._currentStep,
b,!0),this._currentStep=this._startStep,this.findNextClip(this._upbeats[this._activeUpbeat].step)),this._state){case t.PrePlaying:if(-1!=this._activeUpbeat){var d=this._upbeats[this._activeUpbeat],c=d.length-this._stepCount;0<=c&&this.sendMidiEvents(d.step+c,b,!1)}this._stepCount-=this._beatSubscription;0>=this._stepCount&&(-1!=this._activeUpbeat&&d.targetStep&&(this._currentStep=d.targetStep),this.findNextClip(this._currentStep),this.changeState(t.Playing));break;case t.Playing:this.playStep(a,b);
break;case t.PreStopping:this._stepCount-=this._beatSubscription,0>=this._stepCount?this.stop(b,!1):this.playStep(a,b)}return this};b.prototype.recalculateBPM=function(a){this._secPerTick=6E7/a/1E6/this._midiFile.header.ticksPerBeat};b.prototype.getNextBar=function(a){var b=Math.ceil(this._currentStep/a);this._currentStep>this._length-a&&(b=0);return b};b.prototype.fadeInAndPlay=function(a,b){this.play(b);this.output.gain.value=0;l.curveParamLin(this.output.gain,1,a,b);return this};b.prototype.fadeOutAndStop=
function(a,b){void 0==b&&(b=d.context.currentTime);this.output.gain.cancelScheduledValues(b);l.curveParamLin(this.output.gain,0,a,b);l.setParam(this.output.gain,this._volume,b+a);this.stop(b+a);return this};b.prototype.deschedule=function(a){void 0==a&&(a=this._length);this._synth.deschedule&&this._synth.deschedule();if(this._state!=t.Stopped){a%=this._length;this._currentStep-=a;this._currentStep<this._startStep&&(this._currentStep=this._startStep+this._length-(this._startStep-this._currentStep));
a=0;for(var b=this._clips.length;a<b;a++)if(this._clips[a].step>=this._currentStep){this._nextClip=a;break}}return this};b.prototype.resetTranspose=function(){this._transpose=this._orgTranspose};Object.defineProperty(b.prototype,"length",{get:function(){return this._length},set:function(a){this._length=a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"startStep",{set:function(a){this._startStep=a;this._currentStep=this._sequencer.currentStep%this._length+this._startStep;a=0;for(var b=
this._clips.length;a<b;a++)if(this._clips[a].step>=this._currentStep){this._nextClip=a;break}},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"scale",{set:function(a){this._progression||(this._scale="reset"===a?this._orgScale:a)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"customScale",{set:function(a){this._progression||(this._scales.custom=a,this._scale="custom")},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"transpose",{get:function(){return this._transpose},
set:function(a){this._transpose=a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"loop",{get:function(){return this._loop},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"state",{get:function(){return this._state},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"playing",{get:function(){var a=!1;if(1===this._state||1===this._state)a=!0;return a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"duration",{get:function(){return this._length*
this._sequencer.getNoteTime(1)},enumerable:!0,configurable:!0});b.prototype.setData=function(a){c.prototype.setData.call(this,a);var b=!1;this._beatSubscription=void 0==a.beat_subscription?.25:a.beat_subscription;this._midiFile!=a.file_id&&(this._midiFile=a.file_id);this._midiTrackIx!=a.midi_track&&(this._midiTrackIx=a.midi_track);void 0!=a.sequener&&this._sequencerName!=a.sequencer&&(this._sequencerName=a.sequencer,b=!0);void 0!=a.synth&&this._synthName!=a.synth&&(this._synthName=a.synth,b=!0);this._loop=
void 0==a.loop?!1:a.loop;this._length=void 0==a.length?0:a.length;this._root=void 0==a.root?0:a.root;this._transpose=this._orgTranspose=void 0==a.transpose?0:a.transpose;this._scale=this._orgScale=void 0==a.scale?0:a.scale;this._rootNote=void 0==a.root_note?36:a.root_note;this._activeUpbeat=-1;if(a.upbeats){this._upbeats=[];for(var b=this._upbeatLoopOffset=0,d=a.upbeats.length;b<d;b++)this._upbeats.push({length:a.upbeats[b].length,step:a.upbeats[b].step,targetStep:a.upbeats[b].target_step,playInLoop:a.upbeats[b].play_in_loop});
b=!0}b&&(this._sequencer.unregisterPattern(this),this.init())};return b}(k);c.MidiPattern=m;(function(d){d._map=[];d._map[0]="PrePlaying";d.PrePlaying=0;d._map[1]="Playing";d.Playing=1;d._map[2]="PreStopping";d.PreStopping=2;d._map[3]="PostStop";d.PostStop=3;d._map[4]="Stopped";d.Stopped=4})(c.PatternState||(c.PatternState={}));var t=c.PatternState;c.getPatternStateString=function(d){switch(d){case t.PrePlaying:return"PrePlaying";case t.Playing:return"Playing";case t.PreStopping:return"PreStopping";
case t.PostStop:return"PostStop";case t.Stopped:return"Stopped"}};k=function(c){function b(a,b){c.call(this,a,b);this._fadeTime=this._stepCount=this._syncStep=this._currentStep=this._totalStep=this._startStep=0;this._length=2;this._loop=!0;this._forceFade=this._tail=!1;this._activeUpbeat=-1;this._startOffset=0;this._state=t.Stopped;this._beatSubscription=a.beat_subscription||.25;this._length=a.length||0;this._startStep=a.start_step||0;this._loop=void 0!=a.loop?a.loop:!0;this._tail=void 0!=a.tail?
a.tail:!1;this._clips=[];this._upbeats=[];this._sequencerName=a.sequencer;this._initData={dummyClips:a.content,dummyUpbeats:a.upbeats};g.instance.pushToPreLoadInitStack(this)}p(b,c);b.prototype.init=function(){if(this._initData.dummyClips)for(var a=0,b=this._initData.dummyClips.length;a<b;a++){var d=this._initData.dummyClips[a];d.audio?(this._clips.push({audio:g.instance.findInstance(d.audio),process:null,args:null,step:d.step}),this._clips[this._clips.length-1].audio._parentType=this._type):this._clips.push({audio:null,
process:g.instance.findInstance(d.process),args:d.args,step:d.step})}if(this._initData.dummyUpbeats){a=0;for(b=this._initData.dummyUpbeats.length;a<b;a++){for(var d=this._initData.dummyUpbeats[a],c=[],e=0,f=d.content.length;e<f;e++){var r=d.content[e];r.audio?(c.push({audio:g.instance.findInstance(r.audio),process:null,args:null,step:r.step}),this._clips[this._clips.length-1].audio._parentType=this._type):c.push({audio:null,process:g.instance.findInstance(r.process),args:r.args,step:r.step})}d.clips=
c;this._upbeats.push({length:d.length,clips:c})}this._upbeats.sort(function(a,b){return b.length-a.length})}this._sequencer=g.instance.findInstance(this._sequencerName);this._sequencer.registerPattern(this);this._initData=null};b.prototype.connect=function(a){for(var b=0,d=this._clips.length;b<d;b++){var c=this._clips[b].audio;!c||c.destinationName&&"$OUT"!=g.instance.findInstance(c.destinationName).destinationName||(c.disconnect(),c.connect(this._output))}this._output.connect(a);return this};b.prototype.disconnect=
function(){this._output.disconnect();return this};b.prototype.changeState=function(a){a!=this._state&&(g.callbacks&&g.callbacks.changePatternState&&g.callbacks.changePatternState({pattern:this,lastState:this._state,newState:a,step:this._sequencer.currentStep}),this._state=a)};b.prototype.prePlaySchedule=function(a,b,c,e,f,r){c=c||!1;var h=d.context.currentTime;if(this._state==t.PreStopping||this._state==t.PostStop)return this._output.gain.cancelScheduledValues(h),this._output.gain.setValueAtTime(this._output.gain.value,
h),this._output.gain.linearRampToValueAtTime(this._volume,h+.5),this.changeState(t.Playing),clearTimeout(this._stoppingId),this;this._output.gain.value!=this._volume||t.Stopped?(e=this._state===t.Stopped&&e?0:this._output.gain.value,this._output.gain.cancelScheduledValues(h),this._output.gain.setValueAtTime(e,h),this._output.gain.linearRampToValueAtTime(this._volume,h+f)):e&&(h=this._sequencer.getBeatTime(a),this._output.gain.cancelScheduledValues(h),this._output.gain.setValueAtTime(0,h),this._output.gain.linearRampToValueAtTime(this._volume,
h+f));if(this._state==t.Playing||this._state==t.PrePlaying)if(c)this._syncStep=b,this.stop(a,!0,0);else return this;void 0!=r&&(this._startOffset=r);this._syncStep=b%this._length+this._startStep;if(0<a||c){this._stepCount=a;this._currentStep=this._startStep;this._totalStep=0;this._activeUpbeat=-1;b=0;for(c=this._upbeats.length;b<c;b++)f=this._upbeats[b],f.length<=a&&(-1==this._activeUpbeat||this._upbeats[this._activeUpbeat].length<f.length)&&(this._activeUpbeat=b);this.changeState(t.PrePlaying)}else this.changeState(t.Playing);
return this};b.prototype.play=function(a){if(this._state==t.Playing||this._state==t.PrePlaying)return this;this._state!=t.PreStopping&&this._state!=t.PostStop||clearTimeout(this._stoppingId);this._currentStep=this._sequencer.currentStep%this._length+this._startStep;this.changeState(t.Playing);this._sequencer.started||this._sequencer.start();return this};b.prototype.stop=function(a,b,d,c){if(this._state==t.Stopped)return this;if(this._state===t.PrePlaying)this.changeState(t.Stopped);else{if(void 0==
a)return this.changeState(t.Stopped),this._currentStep=0,this;void 0==b&&(b=!0);if(b)this._stepCount=this._sequencer.getStepsToNext(this._sequencer.beatLength*a)||0,this._fadeTime=d,this.changeState(t.PreStopping),0<c&&(this._stepCount+=c);else if(d)for(b=d/this._sequencer.getNoteTime(1),this._stepCount=Math.ceil(b),this.changeState(t.Stopped),b=0;b<this._clips.length;b++)this._clips[b].audio&&this._clips[b].audio.fadeOutAndStop(d,a);else for(this.changeState(t.Stopped),b=this._currentStep=0;b<this._clips.length;b++)this._clips[b].audio&&
this._clips[b].audio.stop(a+this._sequencer.getNoteTime(this._sequencer.resolution));return this}};b.prototype.pause=function(){for(var a=0,b=this._clips.length;a<b;a++)this._clips[a].audio&&this._clips[a].audio.pause();return this};b.prototype.unpause=function(){for(var a=0,b=this._clips.length;a<b;a++)this._clips[a].audio&&this._clips[a].audio.unpause();return this};b.prototype.playStep=function(a,b){this._currentStep>=this._length+this._startStep&&(this._loop?this._currentStep=this._startStep:
this._loop||this.changeState(t.Stopped));for(var d=0,c=this._clips.length;d<c;d++)if(this._clips[d].step==this._currentStep){var e=this._clips[d];e.audio?e.audio.play(b,this._startOffset):e.process.start(e.args)}this._totalStep+=this._beatSubscription;this._currentStep+=this._beatSubscription};b.prototype.update=function(a,b){if(this._state!=t.Stopped&&0==a%this._beatSubscription)switch(this._state){case t.PrePlaying:if(-1!=this._activeUpbeat)for(var d=this._upbeats[this._activeUpbeat],c=0,e=d.clips.length;c<
e;c++){var f=d.clips[c];f.step==d.length-this._stepCount&&(f.audio?f.audio.play(b):f.process.start(f.args))}this._stepCount-=this._beatSubscription;0>=this._stepCount&&(this._currentStep=this._startStep+this._syncStep%this._length,this._syncStep=0,this.changeState(t.Playing));break;case t.Playing:this.playStep(a,b);break;case t.PreStopping:this._stepCount-=this._beatSubscription;0>=this._stepCount?!this._tail||this._forceFade?this.stop(b,!1,this._fadeTime):(this.changeState(t.Stopped),this._currentStep=
0):this.playStep(a,b);break;case t.PostStop:this.playStep(a,b),this._stepCount-=this._beatSubscription,0>=this._stepCount&&(this._forceFade=!1,this.changeState(t.Stopped),this._currentStep=0)}return this};b.prototype.deschedule=function(a){void 0==a&&(a=this._length);if(this._state!=t.Stopped){a%=this._length;for(var b=0,d=this._clips.length;b<d;b++){var c=this._clips[b];c.audio&&c.audio.deschedule()}clearTimeout(this._stoppingId);this._output.gain.cancelScheduledValues(l.now());this._currentStep-=
a;this._currentStep<this._startStep&&(this._currentStep=this._startStep+this._length-(this._startStep-this._currentStep))}return this};b.prototype.fadeInAndPlay=function(a,b){return this};b.prototype.fadeOutAndStop=function(a,b){b=b||l.now();this.stop(b,!1,a);return this};b.prototype.curvePlaybackRate=function(a,b){for(var d=0,c=this._clips.length;d<c;d++)this._clips[d].audio.curvePlaybackRate(a,b);return this};b.prototype.getNextBar=function(a){var b=Math.ceil(this._currentStep/a);this._currentStep>
this._length-a&&(b=0);return b};Object.defineProperty(b.prototype,"forceFade",{set:function(a){this._forceFade=a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"playbackRate",{set:function(a){for(var b=0,d=this._clips.length;b<d;b++)this._clips[b].audio.playbackRate=a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"length",{get:function(){return this._length},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"loop",{get:function(){return this._loop},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"state",{get:function(){return this._state},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"playing",{get:function(){var a=!1;if(1===this._state||1===this._state)a=!0;return a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"duration",{get:function(){return this._length*this._sequencer.getNoteTime(1)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"playbackState",{get:function(){return 0},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"currentStep",{get:function(){return this._currentStep},enumerable:!0,configurable:!0});b.prototype.setData=function(a){c.prototype.setData.call(this,a);var b=!1;this._beatSubscription=void 0!=a.beat_subscription?a.beat_subscription:.25;this._length=void 0!=a.length?a.length:0;this._startStep=void 0!=a.start_step?a.start_step:0;this._loop=void 0==a.loop?!0:a.loop;this._tail=void 0==a.tail?!1:a.tail;void 0!=a.sequencer&&this._sequencerName!=
a.sequencer&&(this._sequencerName=a.sequencer,b=!0);this._initData={dummyClips:null,dummyUpbeats:null};a.content&&(this._initData.dummyClips=a.content,this._clips=[],b=!0);a.upbeats&&(this._initData.dummyUpbeats=a.upbeats,this._upbeats=[],b=!0);b&&(this._sequencer.unregisterPattern(this),this.init())};return b}(k);c.Pattern=k;k=function(){function c(b){this.active=!0;this._type=b.type;this._input=void 0!=d.context.createGain?d.context.createGain():d.context.createGainNode();this._output=void 0!=d.context.createGain?
d.context.createGain():d.context.createGainNode();!1===b.active&&(this.active=!1)}c.prototype.connect=function(b){this._output.connect(b);return this};c.prototype.disconnect=function(){this._output.disconnect();return this};c.prototype.setActive=function(b){d.warn("Effect: Invocation of abstract method: Effect.setActive in",this);return this};Object.defineProperty(c.prototype,"input",{get:function(){return this._input},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"output",{get:function(){return this._output},
enumerable:!0,configurable:!0});return c}();c.Effect=k;m=function(c){function b(a){c.call(this,a);this._wet=d.context.createGain();this._wet.gain.value=a.wet;this._input.connect(this._wet);this._input.connect(this._output);this.destinationName=a.destination_name;g.instance.pushToPreLoadInitStack(this)}p(b,c);b.prototype.init=function(){var a=g.instance.findInstance(this.destinationName);a&&this._wet.connect(a.input)};b.prototype.setActive=function(a){this._input.disconnect();a&&this._input.connect(this._wet);
this._input.connect(this._output);return this};Object.defineProperty(b.prototype,"wet",{get:function(){return this._wet.gain},enumerable:!0,configurable:!0});b.prototype.setData=function(a){void 0!=a.wet&&(this.wet.value=a.wet);a.destination_name!=this.destinationName&&(this.destinationName=a.destination_name,this._wet.disconnect(),this.init())};return b}(k);c.EffectSend=m;m=function(c){function b(a){c.call(this,a);this._filters=[];if("Firefox"==d.browser)this._input.connect(this._output);else if(0==
a.bands.length)d.warn("Equalizer: No bands specified"),this._input.connect(this.output);else{for(var b=0,e=a.bands.length;b<e;b++){var f=a.bands[b],h=d.context.createBiquadFilter();f.filter_type&&(h.type=l.safeFilterType(f.filter_type));f.frequency&&(h.frequency.value=f.frequency);f.gain&&(h.gain.value=f.gain);f.Q&&(h.Q.value=f.Q);0==b?this._input.connect(h):this._filters[b-1].connect(h);this._filters.push(h)}this._filters[this._filters.length-1].connect(this._output)}}p(b,c);b.prototype.addFilter=
function(a,b,c,e){var f=d.context.createBiquadFilter();f.type=a;f.frequency.value=b;f.gain.value=e;f.Q.value=c;0==this._filters.length?(this._input.disconnect(),this._input.connect(f)):(this._filters[this._filters.length-1].disconnect(),this._filters[this._filters.length-1].connect(f));f.connect(this.output);this._filters.push(f)};b.prototype.removeFilter=function(a){this._filters[a].disconnect();0==a&&1<this._filters.length?(this._input.disconnect(),this._input.connect(this._filters[1])):0==a?(this._input.disconnect(),
this._input.connect(this._output)):a==this._filters.length-1?(this._filters[a-1].disconnect(),this._filters[a-1].connect(this._output)):(this._filters[a-1].disconnect(),this._filters[a-1].connect(this._filters[a+1]));this._filters.splice(a,1)};b.prototype.setActive=function(a){this._input.disconnect();a?0==this._filters.length?this._input.connect(this._output):this._input.connect(this._filters[0]):this._input.connect(this._output);return this};Object.defineProperty(b.prototype,"filters",{get:function(){return this._filters},
enumerable:!0,configurable:!0});b.prototype.setData=function(a){for(var b=0,d=this._filters.length;b<d;b++){var c=a.bands[b],e=this._filters[b];e&&c&&(e.frequency.value=c.frequency,e.Q.value=c.Q,e.gain.value=c.gain,c=l.safeFilterType(c.filter_type),e.type!=c&&(e.type=c))}};return b}(k);c.Equalizer=m;m=function(c){function b(a){c.call(this,a);this._filter=d.context.createBiquadFilter();this._filter.type=l.safeFilterType(a.filter_type);this._input.connect(this._filter);this._filter.connect(this._output);
this._filter.frequency.value=void 0!=a.frequency?a.frequency:1E3;this._filter.Q.value=void 0!=a.Q?a.Q:1;this._filter.gain.value=void 0!=a.gain?a.gain:0}p(b,c);b.prototype.setActive=function(a){this._input.disconnect();a?this._input.connect(this._filter):this._input.connect(this._output);return this};Object.defineProperty(b.prototype,"frequency",{get:function(){return this._filter.frequency},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"Q",{get:function(){return this._filter.Q},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"gain",{get:function(){return this._filter.gain},enumerable:!0,configurable:!0});b.prototype.setData=function(a){void 0==a.filter_type&&(a.filter_type="lowpass");this._filter.type!=a.filter_type&&(this._filter.type=l.safeFilterType(a.filter_type));this._filter.frequency.value=void 0==a.frequency?1E3:a.frequency;this._filter.Q.value=void 0==a.Q?1:a.Q;this._filter.gain.value=void 0==a.gain?0:a.gain};return b}(k);c.BiquadFilter=m;m=function(c){function b(a){c.call(this,
a);this._pro=d.context.createScriptProcessor(a.buffer_size||4096,2,2);var b=this;this._pro.onaudioprocess=function(a){var d=a.inputBuffer,c=a.outputBuffer;a=d.getChannelData(0);for(var e=d.getChannelData(1),f=c.getChannelData(0),c=c.getChannelData(1),h=Math.pow(.5,b._bits),d=d.length,r=0,g=0,k=0,l=0;l<d;++l)1<=(r+=b._reduction)&&(r--,g=h*Math.floor(a[l]/h),k=h*Math.floor(e[l]/h)),f[l]=g,c[l]=k};this._bits=a.bits||4;this._reduction=a.reduction||.2;this._input.connect(this._pro);this._pro.connect(this._output)}
p(b,c);b.prototype.setActive=function(a){this._input.disconnect();a&&this._input.connect(this._pro);this._input.connect(this._output);return this};Object.defineProperty(b.prototype,"bits",{get:function(){return this._bits},set:function(a){this._bits=a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"reduction",{get:function(){return this._reduction},set:function(a){this._reduction=a},enumerable:!0,configurable:!0});b.prototype.setData=function(a){this._bits=void 0!=a.bits?a.bits:
4;this._reduction=void 0!=a.reduction?a.reduction:.2};return b}(k);c.Bitcrusher=m;m=function(c){function b(a){c.call(this,a);this._bypass=a.bypass;d.isMobile?this._input.connect(this._output):(this._dynamicsCompressor=d.context.createDynamicsCompressor(),this._makeUpGain=d.context.createGain(),this._input.connect(this._dynamicsCompressor),this._dynamicsCompressor.connect(this._makeUpGain),this._makeUpGain.connect(this._output),this._bypass&&(this._input.connect(this._output),this._makeUpGain.gain.value=
0),this._dynamicsCompressor.threshold.value=a.threshold||this._dynamicsCompressor.threshold.value,this._dynamicsCompressor.knee.value=a.knee||this._dynamicsCompressor.knee.value,this._dynamicsCompressor.ratio.value=a.ratio||this._dynamicsCompressor.ratio.value,this._dynamicsCompressor.attack.value=a.attack||this._dynamicsCompressor.attack.value,this._dynamicsCompressor.release.value=a.release||this._dynamicsCompressor.release.value,this._makeUpGain.gain.value=a.make_up_gain||this._makeUpGain.gain.value)}
p(b,c);b.prototype.setActive=function(a){this._input.disconnect();a?(this._input.connect(this._dynamicsCompressor),this._bypass&&this._input.connect(this._output)):this._input.connect(this._output);return this};Object.defineProperty(b.prototype,"threshold",{get:function(){return this._dynamicsCompressor.threshold},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"knee",{get:function(){return this._dynamicsCompressor.knee},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"ratio",{get:function(){return this._dynamicsCompressor.ratio},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"attack",{get:function(){return this._dynamicsCompressor.attack},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"release",{get:function(){return this._dynamicsCompressor.release},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"reduction",{get:function(){return this._dynamicsCompressor.reduction},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"makeUpGain",{get:function(){return this._makeUpGain.gain},enumerable:!0,configurable:!0});b.prototype.setData=function(a){void 0!=a.threshold&&(this.threshold.value=a.threshold);void 0!=a.knee&&(this.knee.value=a.knee);void 0!=a.ratio&&(this.ratio.value=a.ratio);void 0!=a.attack&&(this.attack.value=a.attack);void 0!=a.release&&(this.release.value=a.release);void 0!=a.make_up_gain&&(this.makeUpGain.value=a.make_up_gain)};return b}(k);c.Compressor=m;m=function(c){function b(a){c.call(this,a);d.isMobile?
this._input.connect(this._output):(this._soundName=a.sound,this._convolver=d.context.createConvolver(),this._wetGain=d.context.createGain(),this._dryGain=d.context.createGain(),this._wetGain.gain.value=1,this._dryGain.gain.value=0,this._wetGain.connect(this._convolver),this._dryGain.connect(this._output),this._input.connect(this._wetGain),this._input.connect(this._dryGain),this._convolver.connect(this._output),g.instance.pushToPostLoadInitStack(this))}p(b,c);b.prototype.dryWet=function(a){a=Math.max(0,
Math.min(1,a));this._wetGain.gain.value=a;this._dryGain.gain.value=1-a};b.prototype.setActive=function(a){this._input.disconnect();a?this._input.connect(this._convolver):this._input.connect(this._output);return this};b.prototype.init=function(){var a=g.instance.findInstance(this._soundName);this._convolver.buffer=a.buffer};b.prototype.setData=function(a){a.sound&&a.sound!=this._soundName&&(this._soundName=a.sound,this.init())};return b}(k);c.Convolver=m;m=function(c){function b(a){c.call(this,a);
this._sync=a.sync}p(b,c);b.prototype.init=function(){if(this._sync){var a=g.instance.findInstance(this._sync);this.updateSync(a.bpm);a.registerBPMSync(this)}};b.prototype.setSync=function(a,b){a?(this._sync=a,this._syncResolution=b||1,this.init()):this._syncResolution=this._sync=null;return this};b.prototype.setSyncRate=function(a){this._sync&&(this._syncResolution=a,this.updateSync(g.instance.findInstance(this._sync).bpm));return this};b.prototype.updateSync=function(a){d.warn("DelayBase: Invocation of abstract method: DelayBase.updateSync in",
this);return this};Object.defineProperty(b.prototype,"sync",{get:function(){return this._sync},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"syncResolution",{get:function(){return this._syncResolution},set:function(a){this._syncResolution=a},enumerable:!0,configurable:!0});return b}(k);c.DelayBase=m;var u=function(c){function b(a){c.call(this,a);this._feedback=d.context.createGain();this._delay=d.context.createDelay();a.filter?(this._filter=d.context.createBiquadFilter(),this._input.connect(this._filter),
this._filter.connect(this._delay),this._filter.type=l.safeFilterType(a.filter.filter_type),this._filter.frequency.value=a.filter.frequency||1E3,this._filter.Q.value=a.filter.Q||4,this._filter.gain.value=a.filter.gain||1):this._input.connect(this._delay);this._delay.connect(this._feedback);this._delay.connect(this._output);this._feedback.connect(this._delay);this.sync?(g.instance.pushToPreLoadInitStack(this),this.syncResolution=a.delay_time||1):this._delay.delayTime.value=a.delay_time||.125;this._feedback.gain.value=
a.feedback||.3;this._output.gain.value=a.output_vol||a.wet||1}p(b,c);b.prototype.setActive=function(a){this._input.disconnect();a?this._input.connect(this._delay):this._input.connect(this._output);return this};b.prototype.updateSync=function(a){this._delay.delayTime.value=60/a*this.syncResolution;return this};Object.defineProperty(b.prototype,"delayTime",{get:function(){return this._delay.delayTime},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"feedback",{get:function(){return this._feedback.gain},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"filter",{get:function(){return this._filter},enumerable:!0,configurable:!0});b.prototype.setData=function(a){a.feedback&&(this._feedback.gain.value=a.feedback);a.sync?this.setSync(a.sync,a.delay_time):a.delay_time&&(this._delay.delayTime.value=a.delay_time);a.filter?(this._filter||(this.input.disconnect(),this._filter=d.context.createBiquadFilter(),this.input.connect(this._filter),this._filter.connect(this._delay)),void 0!=a.filter.filter_type&&
(this._filter.type=l.safeFilterType(a.filter.filter_type)),void 0!=a.filter.frequency&&(this._filter.frequency.value=a.filter.frequency),void 0!=a.filter.Q&&(this._filter.Q.value=a.filter.Q),void 0!=a.filter.gain&&(this._filter.gain.value=a.filter.gain)):this._filter&&(this.input.disconnect(),this._filter.disconnect(),this.input.connect(this._delay),this._filter=null)};return b}(m);c.Delay=u;var x=function(c){function b(a){c.call(this,a);"Firefox"==d.browser?this._input.connect(this._output):(this._splitter=
d.context.createChannelSplitter(2),this._merger=d.context.createChannelMerger(2),this._mono=d.context.createGain(),this._leftDelay=d.context.createDelay(),this._rightDelay=d.context.createDelay(),this._feedback=d.context.createGain(),a.filter?(this._filter=d.context.createBiquadFilter(),this._mono.connect(this._filter),this._filter.connect(this._leftDelay),this._feedback.connect(this._filter),this._filter.type=l.safeFilterType(a.filter.filter_type),this._filter.frequency.value=a.filter.frequency||
1E3,this._filter.Q.value=a.filter.Q||4,this._filter.gain.value=a.filter.gain||1):(this._mono.connect(this._leftDelay),this._feedback.connect(this._leftDelay)),this._input.connect(this._splitter),this._splitter.connect(this._mono,0,0),this._splitter.connect(this._mono,1,0),this._leftDelay.connect(this._rightDelay),this._rightDelay.connect(this._feedback),this._leftDelay.connect(this._merger,0,0),this._rightDelay.connect(this._merger,0,1),this._merger.connect(this._output),this.sync?(g.instance.pushToPreLoadInitStack(this),
this.syncResolution=a.delay_time||1):(this._leftDelay.delayTime.value=a.delay_time||.125,this._rightDelay.delayTime.value=this._leftDelay.delayTime.value),this._feedback.gain.value=a.feedback||.3,this._output.gain.value=a.output_vol||a.wet||1)}p(b,c);b.prototype.setActive=function(a){this._input.disconnect();a?this._input.connect(this._splitter):this._input.connect(this._output);return this};b.prototype.updateSync=function(a){this._leftDelay.delayTime.value=60/a*this.syncResolution;this._rightDelay.delayTime.value=
this._leftDelay.delayTime.value;return this};Object.defineProperty(b.prototype,"delay_time",{set:function(a){this._leftDelay.delayTime.value=a;this._rightDelay.delayTime.value=a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"feedback",{get:function(){return this._feedback.gain},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"filter",{get:function(){return this._filter},enumerable:!0,configurable:!0});b.prototype.setData=function(a){a.feedback&&(this._feedback.gain.value=
a.feedback);a.sync?this.setSync(a.sync,a.delay_time):a.delay_time&&(this._leftDelay.delayTime.value=a.delay_time,this._rightDelay.delayTime.value=a.delay_time);a.filter?(this._filter||(this._mono.disconnect(),this._feedback.disconnect(),this._filter=d.context.createBiquadFilter(),this._mono.connect(this._filter),this._filter.connect(this._leftDelay),this._feedback.connect(this._filter)),void 0!=a.filter.filter_type&&(this._filter.type=l.safeFilterType(a.filter.filter_type)),void 0!=a.filter.frequency&&
(this._filter.frequency.value=a.filter.frequency),void 0!=a.filter.Q&&(this._filter.Q.value=a.filter.Q),void 0!=a.filter.gain&&(this._filter.gain.value=a.filter.gain)):this._filter&&(this._mono.disconnect(),this._feedback.disconnect(),this._filter.disconnect(),this._mono.connect(this._leftDelay),this._feedback.connect(this._leftDelay),this._filter=null)};return b}(m);c.PingPongDelay=x;m=function(c){function b(a){c.call(this,a);this.sync&&(a.left.sync=this.sync,a.right.sync=this.sync);this._splitter=
d.context.createChannelSplitter(2);this._merger=d.context.createChannelMerger(2);this._leftDelay=new u(a.left||{});this._rightDelay=new u(a.right||{});this._input.connect(this._splitter);this._splitter.connect(this._leftDelay.input,0,0);this._splitter.connect(this._rightDelay.input,0,0);this._splitter.connect(this._rightDelay.input,1,0);this._leftDelay.output.connect(this._merger,0,0);this._rightDelay.output.connect(this._merger,0,1);this._merger.connect(this._output)}p(b,c);b.prototype.setActive=
function(a){this._input.disconnect();a?this._input.connect(this._splitter):this._input.connect(this._output);return this};b.prototype.updateSync=function(a){this._leftDelay.updateSync(a);this._rightDelay.updateSync(a);return this};Object.defineProperty(b.prototype,"leftDelay",{get:function(){return this._leftDelay},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"rightDelay",{get:function(){return this._rightDelay},enumerable:!0,configurable:!0});b.prototype.setData=function(a){this._leftDelay.setData(a.left);
this._rightDelay.setData(a.right)};return b}(m);c.StereoDelay=m;m=function(c){function b(a){c.call(this,a);this._compressor=d.context.createDynamicsCompressor();this._preGain=d.context.createGain();this._postGain=d.context.createGain();this._input.connect(this._preGain);this._preGain.connect(this._compressor);this._compressor.connect(this._postGain);this._postGain.connect(this._output);this._compressor.threshold.value=a.threshold||0;this._compressor.knee.value=0;this._compressor.ratio.value=100;this._compressor.attack.value=
0;this._compressor.release.value=0;this._preGain.gain.value=void 0==a.pre_gain?1:a.pre_gain;this._postGain.gain.value=void 0==a.post_gain?1:a.post_gain}p(b,c);b.prototype.setActive=function(a){this._input.disconnect();a?this._input.connect(this._preGain):this._input.connect(this._output);return this};Object.defineProperty(b.prototype,"threshold",{get:function(){return this._compressor.threshold},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"preGain",{get:function(){return this._preGain.gain},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"postGain",{get:function(){return this._postGain.gain},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"reduction",{get:function(){return this._compressor.reduction},enumerable:!0,configurable:!0});b.prototype.setData=function(a){void 0!=a.threshold&&(this._compressor.threshold.value=a.threshold);void 0!=a.pre_gain&&(this._preGain.gain.value=a.pre_gain);void 0!=a.post_gain&&(this._postGain.gain.value=a.post_gain)};
return b}(k);c.Limiter=m;m=function(c){function b(a){c.call(this,a);this._name=a.name;this._panner=d.context.createPanner();this._input.connect(this._panner);this._panner.connect(this._output);void 0!=a.panning_model&&(this._panner.panningModel=a.panning_model);void 0!=a.distance_model&&(this._panner.distanceModel=a.distance_model);void 0!=a.ref_distance&&(this._panner.refDistance=a.ref_distance);void 0!=a.max_distance&&(this._panner.maxDistance=a.max_distance);void 0!=a.rolloff_factor&&(this._panner.rolloffFactor=
a.rolloff_factor);void 0!=a.cone_inner_angle&&(this._panner.coneInnerAngle=a.cone_inner_angle);void 0!=a.cone_outer_angle&&(this._panner.coneOuterAngle=a.cone_outer_angle);void 0!=a.cone_outer_gain&&(this._panner.coneOuterGain=a.cone_outer_gain);void 0!=a.position&&this._panner.setPosition(a.position[0],a.position[1],a.position[2]);void 0!=a.velocity&&this._panner.setVelocity(a.position[0],a.position[1],a.position[2]);void 0!=a.orientation&&this._panner.setOrientation(a.position[0],a.position[1],
a.position[2]);b.panners[this._name]=this}p(b,c);b.panners={};b._scale=1;b.prototype.setActive=function(a){this._input.disconnect();a?this._input.connect(this._panner):this._input.connect(this._output);return this};b.prototype.setPosition=function(a,d,c){this._panner.setPosition(a*b.scale,d*b.scale,c*b.scale)};b.prototype.setOrientation=function(a,b,d){this._panner.setOrientation(a,b,d)};b.prototype.setVelocity=function(a,b,d){this._panner.setVelocity(a,b,d)};b.prototype.setData=function(a){this._panner.setPosition(a.position[0],
a.position[1],a.position[2]);this._panner.setVelocity(a.position[0],a.position[1],a.position[2]);this._panner.setOrientation(a.position[0],a.position[1],a.position[2]);void 0!=a.panning_model&&(this._panner.panningModel=a.panning_model);void 0!=a.distance_model&&(this._panner.distanceModel=a.distance_model);void 0!=a.ref_distance&&(this._panner.refDistance=a.ref_distance);void 0!=a.max_distance&&(this._panner.maxDistance=a.max_distance);void 0!=a.rolloff_factor&&(this._panner.rolloffFactor=a.rolloff_factor);
void 0!=a.cone_inner_angle&&(this._panner.coneInnerAngle=a.cone_inner_angle);void 0!=a.cone_outer_angle&&(this._panner.coneOuterAngle=a.cone_outer_angle);void 0!=a.cone_outer_gain&&(this._panner.coneOuterGain=a.cone_outer_gain)};Object.defineProperty(b,"listener",{get:function(){return d.context.listener},enumerable:!0,configurable:!0});b.setListenerPosition=function(a,c,e){d.context.listener.setPosition(a*b.scale,c*b.scale,e*b.scale)};b.setListenerOrientation=function(a,b,c,e,f,h){d.context.listener.setOrientation(a,
b,c,e,f,h)};b.setListenerVelocity=function(a,b,c){d.context.listener.setVelocity(a,b,c)};b.setDopplerFactor=function(a){d.context.listener.dopplerFactor=a};b.setSpeedOfSound=function(a){d.context.listener.speed=a};b.setListenerData=function(a){a&&(b.scale=a.scale,b.setListenerPosition(a.position[0],a.position[1],a.position[2]),b.setListenerOrientation(a.orientation[0],a.orientation[1],a.orientation[2],a.orientation_up[0],a.orientation_up[1],a.orientation_up[2]),b.setListenerVelocity(a.velocity[0],
a.velocity[1],a.velocity[2]),b.setDopplerFactor(a.doppler_factor),b.setSpeedOfSound(a.speed_of_sound))};b.get=function(a){return b.panners[a]};Object.defineProperty(b,"scale",{get:function(){return b._scale},set:function(a){b._scale=a},enumerable:!0,configurable:!0});return b}(k);c.Panner=m;m=function(c){function b(a){c.call(this,a);this._source=a.source;this._gain=d.context.createGain();this._processor=d.context.createScriptProcessor(a.buffer_size||0);var b=this;this._processor.onaudioprocess=function(){var a=
b._source.reduction.value;b._gain.gain.value=0==a?1:Math.pow(10,a/20)};this._input.connect(this._gain);this._input.connect(this._processor);this._processor.connect(d.context.destination);this._gain.connect(this._output);g.instance.pushToPreLoadInitStack(this)}p(b,c);b.prototype.init=function(){this._source&&this._source.bus&&void 0!=this._source.index||d.warn("Sidechain: No source specified");this._source=g.instance.findInstance(this._source.bus)._effects[this._source.index]};b.prototype.setActive=
function(a){this._input.disconnect();a?(this._input.connect(this._gain),this._input.connect(this._processor)):this._input.connect(this._output);return this};return b}(k);c.Sidechain=m;m=function(c){function b(a){c.call(this,a);this._splitter=d.context.createChannelSplitter(2);this._merger=d.context.createChannelMerger(2);this._left=d.context.createGain();this._right=d.context.createGain();this._input.connect(this._splitter);this._splitter.connect(this._left,0,0);this._splitter.connect(this._right,
1,0);this._left.connect(this._merger,0,0);this._right.connect(this._merger,0,1);this._merger.connect(this._output);this.pan=a.pan}p(b,c);b.prototype.setActive=function(a){this._input.disconnect();a?this._input.connect(this._splitter):this._input.connect(this._output);return this};b.prototype.getGainValue=function(a){return(a+1)/2};b.prototype.setPanTo=function(a,b){var d=this.getGainValue(a);this._left.gain.setValueAtTime(1-d,b||0);this._right.gain.setValueAtTime(d,b||0);return this};b.prototype.linPanTo=
function(a,b,c){c=c||d.context.currentTime;a=this.getGainValue(a);this._left.gain.setValueAtTime(this._left.gain.value,c);this._left.gain.linearRampToValueAtTime(1-a,d.context.currentTime+b);this._right.gain.setValueAtTime(this._right.gain.value,c);this._right.gain.linearRampToValueAtTime(a,d.context.currentTime+b);return this};b.prototype.expPanTo=function(a,b,c){c=c||d.context.currentTime;a=this.getGainValue(a);this._left.gain.setValueAtTime(0==this._left.gain.value?l.EXP_MIN_VALUE:this._left.gain.value,
c);this._left.gain.exponentialRampToValueAtTime(1-a,d.context.currentTime+b);this._right.gain.setValueAtTime(0==this._right.gain.value?l.EXP_MIN_VALUE:this._right.gain.value,c);this._right.gain.exponentialRampToValueAtTime(a,d.context.currentTime+b);return this};Object.defineProperty(b.prototype,"pan",{get:function(){return this._right.gain.value},set:function(a){a=this.getGainValue(a);this._left.gain.value=1-a;this._right.gain.value=a},enumerable:!0,configurable:!0});b.prototype.setData=function(a){void 0!=
a.pan&&(this.pan=a.pan)};return b}(k);c.StereoPanner=m;m=function(c){function b(a,b){c.call(this,a);a.sync&&(this._sync=a.sync,this._rate=a.rate||.25);this._oscillator=d.context.createOscillator();this._amplitude=d.context.createGain();this._input.connect(this._output);this._oscillator.connect(this._amplitude);this._amplitude.connect(this._output.gain);this._oscillator.frequency.value=a.frequency||10;this._oscillator.type=a.wave||0;this._amplitude.gain.value=a.amplitude||1;this._oscillator.start(b);
g.instance.pushToPreLoadInitStack(this)}p(b,c);b.prototype.init=function(){if(this._sync){var a=g.instance.findInstance(this._sync);this.updateSync(a.bpm);a.registerBPMSync(this)}};b.prototype.setActive=function(a){a?this._amplitude.connect(this._output.gain):this._amplitude.disconnect();return this};b.prototype.updateSync=function(a){this._oscillator.frequency.value=a/60/this._rate;return this};Object.defineProperty(b.prototype,"frequency",{get:function(){return this._oscillator.frequency},enumerable:!0,
configurable:!0});Object.defineProperty(b.prototype,"amplitude",{get:function(){return this._amplitude.gain},enumerable:!0,configurable:!0});b.prototype.setData=function(a){void 0!=a.amplitude&&(this.amplitude.value=a.amplitude);void 0!=a.wave&&(this._oscillator.type=a.wave);a.sync?(this._sync=a.sync,this._rate=a.rate||.25,this.init()):void 0!=a.frequency&&(this.frequency.value=a.frequency)};return b}(k);c.Tremolo=m;k=function(c){function b(a){c.call(this,a);this._samples=8192;this._distortionType=
a.distortion_type||0;this._amount=a.amount||.7;this._samples=8192;this._waveshaper=d.context.createWaveShaper();this._inputDrive=d.context.createGain();this._outputDrive=d.context.createGain();this._input.connect(this._inputDrive);this._inputDrive.connect(this._waveshaper);this._waveshaper.connect(this._outputDrive);this._outputDrive.connect(this._output);this._ws_table=new Float32Array(this._samples);this.createWSCurve(this._distortionType,this._amount);this._inputDrive.gain.value=a.drive||.5;this._outputDrive.gain.value=
a.outputGain||.5}p(b,c);b.prototype.createWSCurve=function(a,b){switch(a){case 0:b=Math.min(b,.9999);var d=2*b/(1-b),c,e;for(c=0;c<this._samples;c++)e=2*c/this._samples-1,this._ws_table[c]=(1+d)*e/(1+d*Math.abs(e));break;case 1:for(c=0;c<this._samples;c++)e=2*c/this._samples-1,d=0<=(.5*Math.pow(e+1.4,2)-1)*d?5.8:1.2,this._ws_table[c]=this.tanh(d);break;case 2:var f=1-b;for(c=0;c<this._samples;c++)e=2*c/this._samples-1,d=0>e?-Math.pow(Math.abs(e),f+.04):Math.pow(e,f),this._ws_table[c]=this.tanh(2*
d);break;case 3:var h,f=.99<1-b?.99:1-b;for(c=0;c<this._samples;c++)e=2*c/this._samples-1,h=Math.abs(e),h<f?d=h:h>f?d=f+(h-f)/(1+Math.pow((h-f)/(1-f),2)):1<h&&(d=h),this._ws_table[c]=this.sign(e)*d*(1/((f+1)/2));break;case 4:for(c=0;c<this._samples;c++)e=2*c/this._samples-1,this._ws_table[c]=-.08905>e?-.75*(1-Math.pow(1-(Math.abs(e)-.032857),12)+1/3*(Math.abs(e)-.032847))+.01:-.08905<=e&&.320018>e?-6.153*e*e+3.9375*e:.630035;break;case 5:for(f=2+Math.round(14*b),d=Math.round(Math.pow(2,f-1)),c=0;c<
this._samples;c++)e=2*c/this._samples-1,this._ws_table[c]=Math.round(e*d)/d}this._waveshaper.curve=this._ws_table};b.prototype.tanh=function(a){return(Math.exp(a)-Math.exp(-a))/(Math.exp(a)+Math.exp(-a))};b.prototype.sign=function(a){return 0===a?1:Math.abs(a)/a};b.prototype.setActive=function(a){this._input.disconnect();a?this._input.connect(this._inputDrive):this._input.connect(this._output);return this};Object.defineProperty(b.prototype,"amount",{get:function(){return this._amount},set:function(a){this._amount=
a;this.createWSCurve(this._distortionType,this._amount)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"distortionType",{get:function(){return this._distortionType},set:function(a){this._distortionType=a;this.createWSCurve(this._distortionType,this._amount)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"drive",{get:function(){return this._inputDrive.gain},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"outputGain",{get:function(){return this._outputDrive.gain},
enumerable:!0,configurable:!0});b.prototype.setData=function(a){void 0!=a.amount&&(this.amount=a.amount);void 0!=a.distortion_type&&(this.distortionType=a.distortion_type);void 0!=a.drive&&(this._inputDrive.gain.value=a.drive);void 0!=a.outputGain&&(this._outputDrive.gain.value=a.outputGain)};return b}(k);c.Distortion=k;k=function(){function c(b,a){a=a||0;this._targets=b.targets;this._sync=b.sync;this._rate=b.rate||1;this._phaseVal=b.phase||0;this._oscillator=d.context.createOscillator();this._oscillator.type=
b.wave||0;this._oscillator.frequency.value=this._rate;this._amplitude=d.context.createGain();this._amplitude.gain.value=b.amplitude||1;this._phase=d.context.createDelay();this._phase.delayTime.value=1/this._oscillator.frequency.value*this._phaseVal;this._oscillator.connect(this._phase);this._phase.connect(this._amplitude);this._oscillator.start(a);g.instance.pushToPreLoadInitStack(this)}c.prototype.init=function(){if(this._sync){var b=g.instance.findInstance(this._sync);this.updateSync(b.bpm);b.registerBPMSync(this)}for(var b=
0,a=this._targets.length;b<a;b++){var c=this._targets[b],e=g.instance.findInstance(c.bus).effects[c.effect];e||d.warn("LFO: Effect index out of bounds: "+c.effect);e[c.param]||d.warn("LFO: Parameter not recognized: "+c.param);this._amplitude.connect(e[c.param])}};c.prototype.updateSync=function(b){this._oscillator.frequency.value=b/60/this._rate;this._phase.delayTime.value=1/this._oscillator.frequency.value*this._phaseVal;return this};c.prototype.setData=function(b){this._oscillator.type=b.wave;this._oscillator.frequency.value=
b.rate;this._phase.delayTime.value=1/this._oscillator.frequency.value*b.phase;this._amplitude.gain.value=b.amplitude||1;b.targets&&(this._targets=b.targets,this.init());this._sync!=b.sync&&(this._sync=b.sync,this.init())};return c}();c.LFO=k;k=function(){function c(b,a){this._arpCounter=0;this._arpNoteLength=.5;this._arpPattern=[];this._arpPatternStep=0;this._name=a;this._type=b.type;this._output=d.context.createGain();this._output.gain.value=b.volume||1;b.destination_name&&(this.destinationName=
b.destination_name,g.instance.initComplete||g.instance.pushToConnectStack(this));b.arp?(this._arpMode=b.arp.arp_mode||"off",this._octaves=b.arp.octaves||1,this._sync=b.arp.sync,this._arpPattern=b.arp.arp_pattern||[]):this._arpMode="off";this._activeVoices=[];this._arpVoices=[];this._beatSubscription=b.beat_subscription||.25;this.data=b}c.prototype.connect=function(b){this._output.connect(b);return this};c.prototype.disconnect=function(){this._output.disconnect();return this};c.prototype.handleMidiEvent=
function(b,a,c,e){d.warn("Synth: Invocation of abstract method: Synth.handleMidiEvent in",this);return this};c.prototype.stop=function(){d.warn("Synth: Invocation of abstract method: Synth.stop in",this)};c.prototype.handleArpModes=function(b){this._arpVoices=[];if(1<this._octaves){b=[];for(var a=0;a<this._octaves-1;a++)for(var d=0;d<this._activeVoices.length;d++){var c=this._activeVoices[d].midiEvent;b.push({midiEvent:{type:"channel",subtype:c.subtype,noteNumber:c.noteNumber+12*(a+1),velocity:c.velocity,
deltaTime:c.deltaTime},transpose:this._activeVoices[d].transpose})}this._arpVoices=this._activeVoices.concat(b)}else this._arpVoices=this._activeVoices;"up"===this._arpMode?this._arpVoices=this._arpVoices.sort(this.sortVoices):"down"===this._arpMode?(this._arpVoices=this._arpVoices.sort(this.sortVoices),this._arpVoices.reverse()):"up-down"===this._arpMode?(b=this._arpVoices.slice(0),b.sort(this.sortVoices),a=this._arpVoices.slice(0),a.sort(this.sortVoices),a.reverse(),this._arpVoices=b.concat(a),
1<this._arpVoices.length&&(this._arpVoices.splice(this._arpVoices.length/2,1),this._arpVoices.pop())):"random"===this._arpMode&&(this._arpVoices=l.shuffle(this._arpVoices))};c.prototype.sortVoices=function(b,a){return b.midiEvent.noteNumber<a.midiEvent.noteNumber?-1:b.midiEvent.noteNumber>a.midiEvent.noteNumber?1:0};c.prototype.arpActive=function(b){b?this._sync&&(b=g.instance.findInstance(this._sync),b.registerSynth(this),b._started||b.start()):(this._arpMode="off",this._sync&&(b=g.instance.findInstance(this._sync),
b.unregisterSynth(this)))};c.prototype.update=function(b,a){0==b%this._beatSubscription&&(this._arpPatternStep=4*b%this._arpPattern.length,0===this._arpVoices.length||this._arpPattern.length&&!this._arpPattern[4*b%this._arpPattern.length]||(this._arpCounter++,this._arpCounter%=this._arpVoices.length,this._arpCounter<this._arpVoices.length&&(this._arpVoices[this._arpCounter].midiEvent.velocity=this._fixedVelocities?this._fixedVelocities[this._arpCounter]:this._arpVoices[this._arpCounter].midiEvent.velocity,
this.handleMidiEvent(this._arpVoices[this._arpCounter].midiEvent,a,this._arpVoices[this._arpCounter].transpose,!0),this.handleMidiEvent({type:"channel",subtype:"noteOff",noteNumber:this._arpVoices[this._arpCounter].midiEvent.noteNumber,velocity:this._arpVoices[this._arpCounter].midiEvent.velocity,deltaTime:this._arpVoices[this._arpCounter].midiEvent.deltaTime},a+this._arpNoteLength,this._arpVoices[this._arpCounter].transpose,!0))))};c.prototype.deschedule=function(){d.warn("Synth: Invocation of abstract method: Synth.deschedule in",
this);return this};Object.defineProperty(c.prototype,"arpCounter",{get:function(){return this._arpCounter},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"arpLength",{get:function(){return this._arpVoices.length},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"output",{get:function(){return this._output},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"arpPattern",{get:function(){return this._arpPattern},set:function(b){this._arpPattern=b},enumerable:!0,
configurable:!0});Object.defineProperty(c.prototype,"arpPatternStep",{get:function(){return this._arpPatternStep},enumerable:!0,configurable:!0});c.prototype.setData=function(b){void 0!=b.volume&&(this.output.gain.value=b.volume);this.destinationName!=b.destination_name&&(this.destinationName=b.destination_name,this.disconnect(),this.connect(g.instance.findInstance(this.destinationName).input));if(b.arp){this._sync=b.arp.sync;this._octaves=b.arp.octaves;this._arpPattern=b.arp.arp_pattern;if("off"==
this._arpMode){var a=g.instance.findInstance(this._sync);a.registerSynth(this);a._started||a.start()}this._arpMode=b.arp.arp_mode}else this._arpMode="off",this._sync&&(a=g.instance.findInstance(this._sync),a.unregisterSynth(this));this.data=b};return c}();c.Synth=k;c.generateNoiseBuffer=h;var y=function(){function c(b,a,e,f,h){this.filterStartFreq=-1;this._filterEnabled=!0;this.voiceType=a;this.active=!1;this.activatedNote=-1;this._enabled=!0;this._detune=b.detune||0;this._wave=b.wave||0;this._frames=
b.frames;this._algorithm=b.algorithm;h&&(this._noiseBuffer=h);this.gain=d.context.createGain();e||(e={frequency:22050,Q:1,filter_type:"lowpass"},this.filterEnabled=!1);this._filterData=e}c.prototype.noteOn=function(b,a,c,e,f,h,g){this.enabled&&(4!==this._wave?(this.source=d.context.createOscillator(),this.source.type=this._wave,this.source.detune.value=this._detune):4==this._wave&&(this.source=d.context.createBufferSource(),this.source.buffer=this._noiseBuffer,this.source.loop=!0),this._envelope=
d.context.createGain(),this._filterData?(this.filter=d.context.createBiquadFilter(),this.filter.type=l.safeFilterType(this._filterData.filter_type),this.filter.frequency.value=void 0==this._filterData.frequency?l.NYQUIST_FREQUENCY:this._filterData.frequency,this.filter.detune&&(this.filter.detune.value=this._filterData.detune||0),this.filter.Q.value=this._filterData.Q||this.filter.Q,this.filter.gain.value=this._filterData.gain||this.filter.gain,this.filterTargetFreq=this.filter.frequency.value,this.source.connect(this.filter),
this.filter.connect(this._envelope)):this.source.connect(this._envelope),this._envelope.connect(this.gain),1==this.voiceType&&this.filterAmplitudeGainNode.connect(this.filter.frequency),c<l.now()&&(c=l.now()),this.active=!0,this.activatedNote=b,4!==this._wave&&(b=l.midiNoteToFrequency(b+g),h?(g=-1,0<h.contour?g=b*(1-h.contour):0>h.contour&&(g=(l.NYQUIST_FREQUENCY-b)*-h.contour+b),this.source.frequency.cancelScheduledValues(c),-1!=g?(this.source.frequency.setValueAtTime(g,c),d.safari?this.source.frequency.setTargetValueAtTime(b,
c,h.decay):this.source.frequency.setTargetAtTime(b,c,h.decay)):this.source.frequency.setValueAtTime(b,c)):this.source.frequency.setValueAtTime(b,c)),f&&(this.filterStartFreq=-1,0>f.contour?this.filterStartFreq=this.filterTargetFreq*(1+f.contour)+1:0<f.contour&&(this.filterStartFreq=(l.NYQUIST_FREQUENCY-this.filterTargetFreq)*f.contour+this.filterTargetFreq),-1!=this.filterStartFreq&&(this.filter.frequency.cancelScheduledValues(c),this.filter.frequency.setValueAtTime(this.filterStartFreq,c),this.filter.frequency.exponentialRampToValueAtTime(this.filterTargetFreq,
c+f.attack),d.safari?this.filter.frequency.setTargetValueAtTime(this.filterTargetFreq*f.sustain,c+f.attack,f.decay):this.filter.frequency.setTargetAtTime(this.filterTargetFreq*f.sustain,c+f.attack,f.decay))),a="linear"===e.volumeCurve?a/128:"exponential"===e.volumeCurve?Math.abs(1-Math.exp(a/128)):1,e?(this._envelope.gain.setValueAtTime(0,c),this._envelope.gain.linearRampToValueAtTime(a,c+e.attack),d.safari?this._envelope.gain.setTargetValueAtTime(a*e.sustain,c+e.attack,e.decay):this._envelope.gain.setTargetAtTime(a*
e.sustain,c+e.attack,e.decay)):this._envelope.gain.setValueAtTime(a,c),this.source.startTime=c,d.safari?this.source.noteOn(c):this.source.start(c))};c.prototype.noteOff=function(b,a,c,e){this.enabled&&(a<l.now()&&(a=l.now()),this.active=!1,e&&-1!=this.filterStartFreq&&(b=this.filter.frequency.value,this.filter.frequency.cancelScheduledValues(a),this.filter.frequency.setValueAtTime(b,a),d.safari?this.filter.frequency.setTargetValueAtTime(this.filterStartFreq,a,e.release):this.filter.frequency.setTargetAtTime(this.filterStartFreq,
a,e.release)),c?(this._envelope.gain.cancelScheduledValues(a),a!=l.now()?this._envelope.gain.setValueAtTime(c.sustain,a):this._envelope.gain.setValueAtTime(this._envelope.gain.value,a),d.safari?this._envelope.gain.setTargetValueAtTime(0,a,c.release):this._envelope.gain.setTargetAtTime(0,a,c.release)):this._envelope.gain.setValueAtTime(0,a),this.source.offTime=a,d.safari?this.source.noteOff(a+5*c.release):this.source.stop(a+5*c.release))};c.prototype.stop=function(){this.filter.frequency.cancelScheduledValues(0);
this._envelope.gain.cancelScheduledValues(0);this._envelope.gain.setValueAtTime(0,0);d.safari?this.source.noteOff(0):this.source.stop(0);this.source.disconnect();this.filter&&this.filter.disconnect();this._envelope&&this._envelope.disconnect()};c.prototype.stopSoft=function(b,a,c){this.active=!1;this._envelope.gain.cancelScheduledValues(b);d.safari?this._envelope.gain.setTargetValueAtTime(0,b,a.release):this._envelope.gain.setTargetAtTime(0,b,a.release);b+=5*a.release;d.safari?this.source.noteOff(b):
this.source.stop(b);var e=this;setTimeout(function(){e.source.disconnect();e.filter&&e.filter.disconnect();e._envelope&&e._envelope.disconnect()},1E3*(b-l.now()))};Object.defineProperty(c.prototype,"enabled",{get:function(){return this._enabled},set:function(b){this._enabled=b},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"filterEnabled",{get:function(){return this._filterEnabled},set:function(b){this._filterEnabled=b;this.source&&(b?(this.source.disconnect(),this.source.connect(this.filter),
this.filter.connect(this._envelope)):(this.source.disconnect(),this.filter.disconnect(),this.source.connect(this._envelope)))},enumerable:!0,configurable:!0});return c}(),z=function(){function c(b,a,e,f){this._enabled=!0;this.nextVoice=0;this.octave=b.octave||0;this.output=d.context.createGain();this.output.gain.value=void 0==b.volume?1:b.volume;this._data=b;this._poly=a;this._filterData=e;this.voices=[];this._noiseBuffer=h(this._data._frames,this._data._algorithm)}c.prototype.noteOn=function(b,a,
c,d,e,f,h){if(this.enabled){this.voices.length==this._poly&&(this.voices[0].noteOff(b,c,d,e),this.voices.splice(0,1));b+=12*this.octave;var g;g=4==this._data.wave?new y(this._data,0,this._filterData,c,this._noiseBuffer):new y(this._data,0,this._filterData,c,null);g.gain.connect(this.output);g.noteOn(b,a,c,d,e,f,h);this.lfoPitchGainNode&&4!=this._data.wave&&this.lfoPitchGainNode.connect(g.source.frequency);this.filterAmplitude&&g.filter&&this.filterAmplitude.connect(g.filter.frequency);this.voices.push(g)}};
c.prototype.noteOff=function(b,a,c,d){if(this.enabled){b+=12*this.octave;for(var e=0;e<this.voices.length;e++)if(this.voices[e].active&&this.voices[e].activatedNote==b){this.voices[e].noteOff(b,a,c,d);this.voices.splice(e,1);break}}};c.prototype.stopSoft=function(b,a,c){for(var d=0;d<this.voices.length;d++)this.voices[d].stopSoft(b,a,c);this.voices=[]};c.prototype.stop=function(){for(var b=0,a=this.voices.length;b<a;b++)this.voices[b].stop();this.voices=[]};c.prototype.deschedule=function(){for(var b=
0,a=this.voices.length;b<a;b++)if(this.voices[b]){var c=this.voices[b].source;if(1==c.playbackState||c.startTime>d.context.currentTime)this.voices[b].stop(),this.voices.splice(b,1),b--}};c.prototype.setDetune=function(b,a){if(this._data){this._data.detune=b;for(var c=0,d=this.voices.length;c<d;c++)this.voices[c].source.detune.setValueAtTime(b,a)}};Object.defineProperty(c.prototype,"enabled",{get:function(){return this._enabled},set:function(b){this._enabled=b},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,
"detune",{get:function(){return this._detune},enumerable:!0,configurable:!0});return c}(),B=function(){function c(b,a){this.osc=d.context.createOscillator();this.phaseDelay=d.context.createDelay();this.osc.type=b.wave||0;this.osc.frequency.value=b.rate||1;this.phase=b.phase||0;this.phaseDelay.delayTime.value=1/this.osc.frequency.value*this.phase;this.sync=b.sync;this.syncResolution=b.rate;this.osc.connect(this.phaseDelay);this.oscVolumeAmplitude=d.context.createGain();this.oscVolumeAmplitude.gain.value=
b.osc_volume_amount;this.phaseDelay.connect(this.oscVolumeAmplitude);this.pitchAmplitude=d.context.createGain();this.pitchAmplitude.gain.value=b.pitch_amount;this.phaseDelay.connect(this.pitchAmplitude);this.filterAmplitude=d.context.createGain();this.filterAmplitude.gain.value=b.filter_amount;this.phaseDelay.connect(this.filterAmplitude);d.safari?this.osc.noteOn(a):this.osc.start(a)}c.prototype.updateSync=function(b){this.osc.frequency.value=b/60/this.syncResolution;this.phaseDelay.delayTime.value=
1/this.osc.frequency.value*this.phase;return this};return c}(),m=function(c){function b(a,b){c.call(this,a,b);this.bendRange=400;var e=d.context.currentTime+l.OSC_START_DELAY;this._gainEG=a.gain_eg;this._filterEG=a.filter_eg;this._pitchEG=a.pitch_eg;var f=0;a.oscillators[0]||(a.oscillators.push({wave:0,detune:0,volume:1,octave:0}),f++);a.oscillators[1]||(a.oscillators.push({wave:0,detune:0,volume:1,octave:0}),f++);this._oscs=[];this._poly=a.poly;for(var h=0,k=a.oscillators.length;h<k;h++){var m=new z(a.oscillators[h],
a.poly,a.filter,e);m.output.connect(this.output);this._oscs.push(m)}1==f?this._oscs[1].enabled=!1:2==f&&(this._oscs[0].enabled=!1,this._oscs[1].enabled=!1);a.LFO||(a.LFO={wave:0,rate:1,phase:0,osc_volume_amount:0,noise_volume_amount:0,pitch_amount:0,filter_amount:0});if(a.LFO){this._LFO=new B(a.LFO,e);h=0;for(k=this._oscs.length;h<k;h++)e=this._oscs[h],this._LFO.oscVolumeAmplitude&&this._LFO.oscVolumeAmplitude.connect(e.output.gain),this._LFO.pitchAmplitude&&(e.lfoPitchGainNode=this._LFO.pitchAmplitude),
this._LFO.filterAmplitude&&(e.filterAmplitude=this._LFO.filterAmplitude);this._LFO.sync&&g.instance.pushToPreLoadInitStack(this)}this._sync&&g.instance.pushToPreLoadInitStack(this)}p(b,c);b.prototype.init=function(){if(this._LFO&&this._LFO.sync){var a=g.instance.findInstance(this._LFO.sync);this._LFO.updateSync(a.bpm);a.registerBPMSync(this._LFO)}this._sync&&(a=g.instance.findInstance(this._sync),a.registerSynth(this),a.started||a.start())};b.prototype.handleMidiEvent=function(a,b,c,e){b=b||d.context.currentTime;
e=e||!1;c=c||0;if("channel"==a.type)if("noteOn"==a.subtype){if("off"!=this._arpMode&&!e){this._activeVoices.push({midiEvent:a,transpose:c});this.handleArpModes(a);return}e=0;for(var f=this._oscs.length;e<f;e++)this._oscs[e].noteOn(a.noteNumber,a.velocity,b,this._gainEG,this._filterEG,this._pitchEG,c)}else if("noteOff"==a.subtype){if("off"!=this._arpMode&&!e){for(c=0;c<this._activeVoices.length;c++)a.noteNumber===this._activeVoices[c].midiEvent.noteNumber&&this._activeVoices.splice(c,1);this.handleArpModes(a);
return}e=0;for(f=this._oscs.length;e<f;e++)this._oscs[e].noteOff(a.noteNumber,b,this._gainEG,this._filterEG)}else if("pitchBend"==a.subtype)for(void 0!=a.value?f=a.value:void 0!=a.velocity&&(f=a.velocity),a=(f-8192)/16384*this.bendRange,c=0;c<this._oscs.length;c++)this._oscs[c].setDetune(a,b);return this};b.prototype.glideTo=function(a,b,c,d){var e=l.now();b=b||e;void 0==c&&(c=.5);d=d||0;for(var f=0,h=this._oscs.length;f<h;f++)for(var g=this._oscs[f],k=Math.min(a.length,g.voices.length),r=0;r<k;r++){var m=
g.voices[r],n=l.midiNoteToFrequency(a[r]+d+12*g.octave);m.source.frequency&&(m.source.frequency.cancelScheduledValues(e),m.source.frequency.setValueAtTime(m.source.frequency.value,b),m.source.frequency.linearRampToValueAtTime(n,b+c))}return this};b.prototype.stop=function(a){a=a||l.now();for(var b=0,c=this._oscs.length;b<c;b++)this._oscs[b].stopSoft(a,this._gainEG,this._filterEG);this._activeVoices.length&&(this._activeVoices=[]);this._arpVoices=[]};b.prototype.deschedule=function(){for(var a=0,b=
this._oscs.length;a<b;a++)this._oscs[a].deschedule();return this};Object.defineProperty(b.prototype,"filterFrequency",{set:function(a){for(var b=0,c=this._oscs.length;b<c;b++){var d=this._oscs[b];d._filterData.frequency=a;for(var e=0,f=d.voices.length;e<f;e++){var h=d.voices[e];h.filterTargetFreq=a;this._filterEG&&0!=this._filterEG.contour||(h.filter.frequency.value=a)}}},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"filterQ",{set:function(a){for(var b=0,c=this._oscs.length;b<
c;b++){var d=this._oscs[b];d._filterData.Q=a;for(var e=0,f=d.voices.length;e<f;e++){var h=d.voices[e];h.filterTargetFreq=a;this._filterEG&&0!=this._filterEG.contour||(h.filter.Q.value=a)}}},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"filterType",{set:function(a){for(var b=0,c=this._oscs.length;b<c;b++){var d=this._oscs[b];d._filterData.filter_type=a;for(var e=0,f=d.voices.length;e<f;e++)d.voices[e].filter.type=a}},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"osc1Wave",{set:function(a){var b=this._oscs[0];b._data.wave=a;for(var c=0,d=b.voices.length;c<d;c++){var e=b.voices[c];e.source.type&&"4"!==a&&(e.source.type=a)}},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"osc1Vol",{set:function(a){this._oscs[0].output.gain.value=a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"osc1Detune",{set:function(a){var b=this._oscs[0];b._detune=a;for(var c=0,d=b.voices.length;c<d;c++){var e=b.voices[c];e.source.detune&&(e.source.detune.value=
a)}},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"osc1Octave",{set:function(a){this._oscs[0].octave=a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"osc2Wave",{set:function(a){if(!(2>this._oscs.length)){var b=this._oscs[1];b._data.wave=a;for(var c=0,d=b.voices.length;c<d;c++){var e=b.voices[c];e.source.type&&"4"!==a&&(e.source.type=a)}}},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"osc2Vol",{set:function(a){2>this._oscs.length||(this._oscs[1].output.gain.value=
a)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"osc2Detune",{set:function(a){if(!(2>this._oscs.length)){var b=this._oscs[1];b._detune=a;for(var c=0,d=b.voices.length;c<d;c++){var e=b.voices[c];e.source.detune&&(e.source.detune.value=a)}}},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"osc2Octave",{set:function(a){2>this._oscs.length||(this._oscs[1].octave=a)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"pitchDecay",{set:function(a){this._pitchEG&&
(this._pitchEG.decay=a)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"pitchContour",{set:function(a){this._pitchEG&&(this._pitchEG.contour=a)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"lfoWave",{set:function(a){this._LFO&&(this._LFO.osc.type=a)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"lfoRate",{set:function(a){this._LFO&&(this._LFO.osc.frequency.value=a)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"lfoPhase",
{set:function(a){this._LFO&&(this._LFO.phase=a)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"lfoOscVol",{set:function(a){this._LFO&&(this._LFO.oscVolumeAmplitude.gain.value=a)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"lfoPitch",{set:function(a){this._LFO&&(this._LFO.pitchAmplitude.gain.value=a)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"lfoFilter",{set:function(a){this._LFO&&(this._LFO.filterAmplitude.gain.value=a)},enumerable:!0,
configurable:!0});Object.defineProperty(b.prototype,"arpMode",{set:function(a){this._arpMode=a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"arpOctaves",{set:function(a){this._octaves=a},enumerable:!0,configurable:!0});b.prototype.setData=function(a){c.prototype.setData.call(this,a);this._poly=a.poly;this._gainEG=a.gain_eg?a.gain_eg:void 0;this._filterEG=a.filter_eg?a.filter_eg:void 0;this._pitchEG=a.pitch_eg?a.pitch_eg:void 0;this._oscs[0].enabled=a.oscillators[0]?!0:!1;this._oscs[1].enabled=
a.oscillators[1]?!0:!1;for(var b=0,d=this._oscs.length;b<d;b++){var e=this._oscs[b];e._data=a.oscillators[b];e._filterData=a.filter;e._poly=this._poly;for(var f=0,h=e.voices.length;f<h;f++){var g=e.voices[f];a.filter?(g.filterEnabled||(g.filterEnabled=!0),this._filterEG&&0!=this._filterEG.contour||(g.filter.frequency.value=a.filter.frequency),g.filter.Q.value=a.filter.Q,g.filterTargetFreq=a.filter.frequency,g.filter.type=a.filter.filter_type):g.filterEnabled&&(g.filterEnabled=!1);a.oscillators&&a.oscillators[b]&&
0==g.voiceType&&(g.source.type&&4!==a.oscillators[0].wave&&(g.source.type=a.oscillators[b].wave),g.source.detune&&(g.source.detune.value=a.oscillators[b].detune))}a.oscillators[b]&&(e.output.gain.value=a.oscillators[b].volume,e.octave=a.oscillators[b].octave)}a.LFO?(this._LFO.osc.type=a.LFO.wave,this._LFO.osc.frequency.value=a.LFO.rate,this._LFO.phase=a.LFO.phase,this._LFO.phaseDelay.delayTime.value=1/this._LFO.osc.frequency.value*a.LFO.phase,this._LFO.oscVolumeAmplitude.gain.value=a.LFO.osc_volume_amount,
this._LFO.pitchAmplitude.gain.value=a.LFO.pitch_amount,this._LFO.filterAmplitude.gain.value=a.LFO.filter_amount):(this._LFO.oscVolumeAmplitude.gain.value=0,this._LFO.pitchAmplitude.gain.value=0,this._LFO.filterAmplitude.gain.value=0)};return b}(k);c.Symple=m;k=function(c){function b(a,b){c.call(this,a,b);this._content=[];this._playingVoices=[];this._allVoices=[];this._hasSustainOffSamples=this._hasSustainOnSamples=this._hasNoteOffSamples=!1;this._pitchBendRange=.25;this._pedalOnTime=-1;this._sustained=
[];this._maxNotes=20;this._stopFactor=5;this._content=a.content;this._volumeCurve=a.volume_curve||"none";this._gainEG=a.eg_gain||{attack:0,decay:0,sustain:1,release:.005};this._currentPitch=1;g.instance.pushToPreLoadInitStack(this)}p(b,c);b.prototype.init=function(){this._envelope=d.context.createGain();for(var a=0,b=this._content.length;a<b;a++){"noteOff"===this._content[a].value&&(this._hasNoteOffSamples=!0);"sustainOn"===this._content[a].value&&(this._hasSustainOnSamples=!0);"sustainOff"===this._content[a].value&&
(this._hasSustainOffSamples=!0);for(var c=0;c<this._content[a].samples.length;c++)this._content[a].samples[c].source=g.instance.findInstance(this._content[a].samples[c].source),this._content[a].samples[c].source||d.warn("SamplePlayer: audio source not found"),this._content[a].samples[c].source._parentType="SamplePlayer",this._content[a].samples[c].source.loop&&(this._loopedSamples=!0)}this._sync&&g.instance.findInstance(this._sync).registerSynth(this)};b.prototype.handleMidiEvent=function(a,b,c,d){b=
b||l.now();d=d||!1;c=c||0;if("channel"==a.type)if("noteOn"==a.subtype){if("off"!=this._arpMode&&!d){this._activeVoices.push({midiEvent:a,transpose:c});this.handleArpModes(a);return}this.noteOn(b,a.noteNumber,c,a.velocity,a.subtype);this._callback&&this._callback(a,b)}else if("noteOff"==a.subtype){if("off"!=this._arpMode&&!d){for(c=0;c<this._activeVoices.length;c++)a.noteNumber===this._activeVoices[c].midiEvent.noteNumber&&this._activeVoices.splice(c,1);this.handleArpModes(a);return}this.noteOff(b,
a.noteNumber,a.velocity,a.subtype);this._callback&&this._callback(a,b)}else if("pitchBend"==a.subtype)for(this._currentPitch=1+(a.value-64)/127,c=0;c<this._playingVoices.length;c++)this._playingVoices[c].source.playbackRateNode.setValueAtTime(this._currentPitch,b);else if("controller"==a.subtype)switch(c=void 0==a.value?a.velocity:a.value,a.controllerType||a.noteNumber){case 64:64>c?(this.pedalRelease(b),b>this._pedalOnTime&&(this._pedalOnTime=-1),this._hasSustainOffSamples&&this.noteOn(b,0,0,127,
"sustainOff")):64<c&&(this._pedalOnTime=b,this._hasSustainOnSamples&&this.noteOn(b,0,0,127,"sustainOn"))}return this};b.prototype.noteOn=function(a,b,c,d,e,f){for(var h=0;h<this._allVoices.length;h++){var k=this._allVoices[h];if(0==k.source._sources.length||3==k.source.lastSource.playbackState)this._allVoices.splice(h,1),h--}var k=this.getNote(b+c,d,e),h=l.midiNoteToFrequency(b+c),r=l.midiNoteToFrequency(k.root),h=h/r;-1===k.root&&(h=1);k=new L(k.source.data,b.toString());"noteOn"===e&&(b={source:k,
time:a,velocity:d,note:b,transpose:c},this._playingVoices.push(b),this._allVoices.push(b));this.destinationName?k.connect(g.instance.findInstance(this.destinationName).input):k.connect(g.instance.findInstance(k.destinationName).input);a=a<l.now()?l.now():a;b=0;f?b=f*d/128:"linear"===this._volumeCurve?b=d/128:"exponential"===this._volumeCurve?b=Math.abs(1-Math.exp(d/128)):"none"===this._volumeCurve&&(b=1);b*=k.output.gain.value;k.output.gain.cancelScheduledValues(a);k.nextPlaybackRate=h*this._currentPitch;
k.play(a);k.output.gain.setValueAtTime(0,a);k.output.gain.linearRampToValueAtTime(b,a+this._gainEG.attack);k.output.gain.setTargetAtTime?k.output.gain.setTargetAtTime(b*this._gainEG.sustain,a+this._gainEG.attack,this._gainEG.decay):k.output.gain.setTargetValueAtTime&&k.output.gain.setTargetValueAtTime(b*this._gainEG.sustain,a+this._gainEG.attack,this._gainEG.decay)};b.prototype.adsr=function(a,b,c,d){var e=this._gainEG;if(0===arguments.length)return{attack:e.attack,decay:e.decay,sustain:e.sustain,
release:e.release};e.attack=void 0===arguments[0]?e.attack:arguments[0];e.decay=void 0===arguments[1]?e.decay:arguments[1];e.sustain=void 0===arguments[2]?e.sustain:arguments[2];e.release=void 0===arguments[3]?e.release:arguments[3];return this};b.prototype.noteOff=function(a,b,c,e){this.getNote(b,c,"noteOn");for(c=0;c<this._playingVoices.length;c++)if(!b||b.toString()===this._playingVoices[c].source._name){if(a>this._pedalOnTime&&0<this._pedalOnTime)this._sustained.length>this._maxNotes&&(this._sustained[0].source.stop(a+
this._gainEG.release*this._stopFactor),this._sustained.splice(0,1)),this._sustained.push(this._playingVoices[c]);else{a<l.now()&&(a=l.now());var f=this._playingVoices[c].source.output.gain.value;this._playingVoices[c].source.output.gain.cancelScheduledValues(a);a!=l.now()||"Firefox"==d.browser?this._playingVoices[c].source.output.gain.setValueAtTime(this._gainEG.sustain,a):this._playingVoices[c].source.output.gain.setValueAtTime(f,a);this._playingVoices[c].source.stop(a+this._gainEG.release*this._stopFactor);
this._playingVoices[c].source.output.gain.setTargetAtTime(0,a,this._gainEG.release);this._hasNoteOffSamples&&(f=l.now()-this._playingVoices[c].time,f=Math.min(Math.exp(-f)/3,1),this.noteOn(a,b,this._playingVoices[c].transpose,this._playingVoices[c].velocity,e,f))}this._playingVoices.splice(c,1)}};b.prototype.stop=function(a){a=a||l.now();this.pedalRelease(a);for(var b=0;b<this._playingVoices.length;b++){a<l.now()&&(a=l.now());var c=this._playingVoices[b].source.output.gain.value;this._playingVoices[b].source.output.gain.cancelScheduledValues(a);
this._playingVoices[b].source.output.gain.setValueAtTime(c,a);this._playingVoices[b].source.stop(a+this._gainEG.release*this._stopFactor);this._playingVoices[b].source.output.gain.setTargetAtTime(0,a,this._gainEG.release)}this._playingVoices=[];this._arpVoices=[];return this};b.prototype.deschedule=function(){for(var a=0;a<this._allVoices.length;a++)this._allVoices[a].source.deschedule();return this};b.prototype.pedalRelease=function(a){for(var b=0;b<this._sustained.length;b++)if(a<l.now()&&(a=l.now()),
"Firefox"==d.browser)this._sustained[b].source.output.gain.linearRampToValueAtTime(0,a+.3),this._sustained[b].source.stop(a+this._gainEG.release*this._stopFactor);else if(this._sustained[b].source.output.gain.setTargetAtTime(0,a,this._gainEG.release),this._hasNoteOffSamples){var c=l.now()-this._sustained[b].time,c=Math.min(Math.exp(-c)/3,1);this.noteOn(a,this._sustained[b].note,this._sustained[b].transpose,this._sustained[b].velocity,"noteOff",c)}this._sustained=[]};b.prototype.getNote=function(a,
b,c){for(var d=0;b>this._content[d].highVelocity||c!==this._content[d].value;)d++;b=d;for(c=0;a<this._content[b].samples[c].startRange||a>this._content[b].samples[c].endRange;)c++;return this._content[b].samples[c]};Object.defineProperty(b.prototype,"content",{get:function(){return this._content},set:function(a){this._content=a;this.init()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"callbackFunction",{set:function(a){this._callback=a},enumerable:!0,configurable:!0});b.prototype.setData=
function(a){c.prototype.setData.call(this,a);a.eg_gain&&(this._gainEG=a.eg_gain);a.content&&(this._content=a.content,this.init());a.volumeCurve&&(this._volumeCurve=a.volumeCurve)};return b}(k);c.SamplePlayer=k;(function(){return function(){throw"Smattr not up to date, fix if(safari)";}})();(function(c){c._map=[];c._map[0]="Restart";c.Restart=0;c._map[1]="Playing";c.Playing=1;c._map[2]="All";c.All=2;c._map[3]="Continue";c.Continue=3})(c.SyncType||(c.SyncType={}));var A=c.SyncType,e=function(c){function b(a,
b){c.call(this);this._scheduler=null;this._started=!1;this._bpm=120;this._barLength=4;this._beatLength=1;this._resolution=.25;this._currentStep=0;this._paused=!1;this._maxSwing=.08;this._swingFactor=0;this._lastBeat=-1;this._name=b;this._type=a.type;this._bpm=a.bpm||120;this._barLength=a.bar_length||4;this._beatLength=a.beat_length||1;this._registeredPatterns=[];this._registeredSynths=[];this._syncHandler=new D;this._syncedObjects=[];this._swingFactor=a.swing_factor||0;g.instance.pushToPreLoadInitStack(this)}
p(b,c);b.prototype.init=function(){this._lookahead=g.settings.sequencer_lookahead||50;this._scheduleAheadTime=g.settings.sequencer_schedule_ahead||.2;d.isIOS&&(this._scheduleAheadTime=g.settings.sequencer_schedule_ahead_ios||5);this._resolution=g.settings.sequencer_resolution||.25};b.prototype.startScheduler=function(){if(!this._paused&&0!==d.context.currentTime){for(this._lastScheduleLoopTime=d.context.currentTime;this._scheduleTime<d.context.currentTime+this._scheduleAheadTime;){for(var a=0,b=this._registeredPatterns.length;a<
b;a++)this._registeredPatterns[a].update(this._currentStep,this._scheduleTime);a=0;for(b=this._registeredSynths.length;a<b;a++)this._registeredSynths[a].update(this._currentStep,this._scheduleTime);this._currentStep+=this._resolution;this._syncHandler.update(this._resolution);this._scheduleTime=0<this._swingFactor?4*this._currentStep%2?this._scheduleTime+60/this._bpm*(.25+this._maxSwing*this._swingFactor):this._scheduleTime+60/this._bpm*(.25-this._maxSwing*this._swingFactor):this._scheduleTime+60/
this._bpm*this._resolution}b=Math.floor(this.currentStep);a=d.context.currentTime;b!==this._lastBeat&&(this.trigger("beforeNextBeat",b,this.getBeatTime(0)-a,a),this._lastBeat=b);this.trigger("progress",this._currentStep,this.getBeatTime(0)-a,this._scheduleTime)}var c=this;this._scheduler=setTimeout(function(){c.startScheduler()},c._lookahead)};b.prototype.start=function(){this._started=!0;this._scheduleTime=d.context.currentTime;.2>=this._scheduleAheadTime&&(this._scheduleTime+=.3);clearTimeout(this._scheduler);
this.startScheduler();g.callbacks&&g.callbacks.startSequencer&&g.callbacks.startSequencer({name:this._name});this.trigger("start");return this};b.prototype.pause=function(){this._paused=!0;this._pauseOffset=this._scheduleTime-l.now();for(var a=0,b=this._registeredPatterns.length;a<b;a++)this._registeredPatterns[a].pause();this.trigger("pause");return this};b.prototype.unpause=function(){this._paused=!1;this._scheduleTime=l.now()+this._pauseOffset;for(var a=0,b=this._registeredPatterns.length;a<b;a++)this._registeredPatterns[a].unpause();
return this};b.prototype.reschedule=function(){clearTimeout(this._scheduler);var a=this._scheduleTime-d.context.currentTime,b=this.getNoteTime(this._resolution),c=(a-a%b)/b/(this._beatLength/this._resolution),e=this._scheduleAheadTime/b/(this._beatLength/this._resolution);this._scheduleTime=d.context.currentTime+(a>this._scheduleAheadTime?a-this._scheduleAheadTime:a-(this._scheduleAheadTime-b));c<e&&(this._scheduleTime-=b);this._currentStep-=e;if(isNaN(this._currentStep)||0>this._currentStep)this._currentStep=
0;a=0;for(b=this._registeredPatterns.length;a<b;a++)this._registeredPatterns[a].deschedule(e);this.startScheduler();return this};b.prototype.stop=function(){this._started=!1;clearTimeout(this._scheduler);this._scheduler=null;this._started=!1;g.callbacks&&g.callbacks.stopSequencer&&g.callbacks.stopSequencer({name:this._name});return this};b.prototype.stopAll=function(a){for(var b=[],c=0;c<arguments.length-1;c++)b[c]=arguments[c+1];for(var c=void 0!=a.beat?a.beat:4,d=void 0===a.fadeTime?0:a.fadeTime,
e=a.forceFade||!1,f=a.wait||0,h=0,g=this._registeredPatterns.length;h<g;h++)-1==b.indexOf(this._registeredPatterns[h])&&(this._registeredPatterns[h].forceFade=e,this._registeredPatterns[h].stop(c,!0,d,f));return this};b.prototype.restart=function(){this._currentStep=0;return this};b.prototype.registerPattern=function(a){this._registeredPatterns.push(a);return this};b.prototype.unregisterPattern=function(a){a=this._registeredPatterns.indexOf(a);this._registeredPatterns.splice(a,1);return this};b.prototype.registerSynth=
function(a){-1==this._registeredSynths.indexOf(a)&&this._registeredSynths.push(a);return this};b.prototype.unregisterSynth=function(a){a=this._registeredPatterns.indexOf(a);this._registeredSynths.splice(a,1);return this};b.prototype.sync=function(a,b,c){return this.syncInSteps(a,this.getStepsToNext(this.beatLength*b),c)};b.prototype.syncInSteps=function(a,b,c){this._started||this.start();var d=this.getNoteTime(b)+this._scheduleTime;c?c.length&&c.push(d):c=[d];this._syncHandler.addSyncCountdown(new C(b,
a,c));return this};b.prototype.syncPattern=function(a){for(var b=[],c=0;c<arguments.length-1;c++)b[c]=arguments[c+1];var e=a.beat||0,f=a.fadeIn||!1,h=a.duration||1,g=void 0==a.absolute?!1:a.absolute,k=void 0!=a.syncType?a.syncType:3,l=a.offset,m=a.wait||0,r,n;this._started||(this._currentStep=0,this.start(),r=e=0,n=!0);var p,c=!1;if(k===A.Restart)p=0,c=!0;else if(k===A.Playing){var t=0;p=-1;for(var k=0,u=b.length;k<u;k++)1===b[k].state&&b[k].length>t&&(t=b[k].length,p=k);k=0;-1<p&&(k=b[p].getNextBar(e));
p=k*e;0<k&&0<m&&(p+=m)}else if(k===A.All){t=0;p=-1;k=0;for(u=this._registeredPatterns.length;k<u;k++)(1===this._registeredPatterns[k].state||2===this._registeredPatterns[k].state)&&this._registeredPatterns[k].length>t&&(t=this._registeredPatterns[k].length,p=k);k=0;-1<p&&(k=this._currentStep+this.getStepsToNext(e));p=k}else k===A.Continue&&(p=0,c=n?!0:!1);0!=g?r="number"==typeof g?this.getStepsToNext(this.beatLength*g)+this.beatLength*e:this.beatLength*e:0<e?r=this.getStepsToNext(this.beatLength*
e):0==e&&(r=0);0<m&&(r+=m);k=0;for(u=b.length;k<u;k++)void 0!=l&&(l=this.getNoteTime(l)),b[k].prePlaySchedule(r,p,c,f,h,l);n?(r=this._scheduleTime-d.context.currentTime,n=this.getNoteTime(this._resolution),this._scheduleTime=d.context.currentTime+(r>this._scheduleAheadTime?r-this._scheduleAheadTime:r-(this._scheduleAheadTime-n)),this._currentStep=c?b[0]._currentStep-this._resolution:b[0]._currentStep):.5<this._scheduleAheadTime&&this.reschedule();return this};b.prototype.registerBPMSync=function(a){-1==
this._syncedObjects.indexOf(a)&&this._syncedObjects.push(a);return this};b.prototype.unregisterBPMSync=function(a){a=this._syncedObjects.indexOf(a);-1!=a&&this._syncedObjects.splice(a,1);return this};b.prototype.getStepsToNext=function(a){return 0==a?0:a-this._currentStep%a};b.prototype.getNoteTime=function(a){void 0==a&&(a=1);return 60/this._bpm*a};b.prototype.getBeatTime=function(a){return this.getNoteTime(this.getStepsToNext(a))+this._scheduleTime};Object.defineProperty(b.prototype,"started",{get:function(){return this._started},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"paused",{get:function(){return this._paused},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"bpm",{get:function(){return this._bpm},set:function(a){this._bpm=a;a=0;for(var b=this._registeredPatterns.length;a<b;a++)"MidiPattern"==this._registeredPatterns[a]._type&&this._registeredPatterns[a].recalculateBPM(this._bpm);a=0;for(b=this._syncedObjects.length;a<b;a++)this._syncedObjects[a].updateSync(this._bpm)},enumerable:!0,
configurable:!0});Object.defineProperty(b.prototype,"scale",{set:function(a){for(var b=0,c=this._registeredPatterns.length;b<c;b++)"MidiPattern"==this._registeredPatterns[b]._type&&(this._registeredPatterns[b].scale=a)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"customScale",{set:function(a){for(var b=0,c=this._registeredPatterns.length;b<c;b++)"MidiPattern"==this._registeredPatterns[b]._type&&(this._registeredPatterns[b].customScale=a)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"transpose",{set:function(a){for(var b=0,c=this._registeredPatterns.length;b<c;b++)"MidiPattern"==this._registeredPatterns[b]._type&&(0===a?this._registeredPatterns[b].resetTranspose():this._registeredPatterns[b].transpose+=a)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"resolution",{get:function(){return this._resolution},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"barLength",{get:function(){return this._barLength},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"beatLength",{get:function(){return this._beatLength},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"currentStep",{get:function(){return this._currentStep},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"swingFactor",{set:function(a){this._swingFactor=a},enumerable:!0,configurable:!0});b.prototype.setData=function(a){this._bpm=a.bpm||120;this._barLength=a.measure_length||4;this._beatLength=a.beat_length||1;this._swingFactor=a.swing_factor||0};return b}(e);c.Sequencer=
e;var C=function(){function d(b,a,c){this._currentStep=0;this._targetStep=b;this._process=a;this._args=c}d.prototype.advance=function(b){this._currentStep+=b};d.prototype.performAction=function(){"string"==typeof this._process?(new Function("Core","Model","Util","args",this._process))(g,c,l,this._args):this._process.start(this._args)};Object.defineProperty(d.prototype,"finished",{get:function(){return this._currentStep>=this._targetStep},enumerable:!0,configurable:!0});return d}();c.SyncCountdown=
C;var D=function(){function c(){this._timers=[]}c.prototype.addSyncCountdown=function(b){this._timers.push(b)};c.prototype.update=function(b){for(var a=0;a<this._timers.length;a++){var c=this._timers[a];c.advance(b);c.finished&&(c.performAction(),this._timers.splice(a,1),a--)}};return c}();c.SyncHandler=D;var E=function(){function c(){this._updateTime=g.settings.timehandler_lookahead;this._callbacks=[]}c.inst=null;Object.defineProperty(c,"instance",{get:function(){null==c.inst&&(c.inst=new c);return c.inst},
enumerable:!0,configurable:!0});c.prototype.startScheduler=function(){if(0<this._callbacks.length){for(var b=d.context.currentTime,a=b-this._lastTime,c=0;c<this._callbacks.length;c++){var e=this._callbacks[c];e.timePassed+=a;e.timePassed>=e.targetTime&&(e.obj[e.func](),this._callbacks.splice(c,1),c--)}this._lastTime=b;var f=this;this._scheduler=setTimeout(function(){f.startScheduler()},f._updateTime)}else this.stop()};c.prototype.start=function(){this._started=!0;this._lastTime=d.context.currentTime;
clearTimeout(this._scheduler);this.startScheduler()};c.prototype.stop=function(){this._started=!1;clearTimeout(this._scheduler);this._scheduler=null};c.prototype.registerMethodCallback=function(b,a,c){this._callbacks.push({obj:b,func:a,timePassed:0,targetTime:c});this._started||this.start();return this};c.prototype.removeMethodCallback=function(b,a){for(var c=0,d=this._callbacks.length;c<d;c++){var e=this._callbacks[c];if(e.obj==b&&e.func==a){this._callbacks.splice(c,1);return}}return this};return c}();
c.TimeHandler=E;e=function(){function c(){this._updateTime=100;this._lookAHead=2*this._updateTime;this._callbacks=[]}c.prototype.scheduleClose=function(b){setTimeout(function(){b.func.apply(b.ctx)},1E3*(b.targetTime-d.context.currentTime))};c.prototype.runScheduler=function(){if(0<this._callbacks.length){for(var b=d.context.currentTime,a=0;a<this._callbacks.length;a++){var c=this._callbacks[a];b+this._lookAHead>=c.targetTime&&(this.scheduleClose(c),this._callbacks.splice(a,1),a--)}this._lastTime=
b;var e=this;this._scheduler=setTimeout(function(){e.runScheduler()},e._updateTime)}else this.stop()};c.prototype.start=function(){this._started=!0;this._lastTime=d.context.currentTime;clearTimeout(this._scheduler);this.runScheduler()};c.prototype.stop=function(){this._started=!1;clearTimeout(this._scheduler);this._scheduler=null};c.prototype["in"]=function(b,a,c){return this.at(d.context.currentTime+b,a,c)};c.prototype.at=function(b,a,c){if(b<d.context.currentTime)return this;this._callbacks.push({ctx:c||
this,func:a,targetTime:b});this._started||this.start();return this};c.prototype.cancel=function(b){for(var a=0;a<this._callbacks.length;a++)if(this._callbacks[a].func&&this._callbacks[a].func===b){this._callbacks.splice(a,1);break}return this};return c}();c.Scheduler=e;e=function(){function e(b){this._vars=b.vars;g.instance.pushToPreLoadInitStack(this)}e.prototype.init=function(){for(var b=0,a=this._vars.length;b<a;b++){var c=this._vars[b];this._destination=this._actionData[c]=g.instance.findInstance(c)}this._vars=
null};e.prototype.start=function(b){d.warn("Process: Invocation of abstract method")};e.prototype.destination=function(){return this._destination};e.prototype.execute=function(b,a,d){if(!this._func||d)this._func=new Function("Core","Model","Util","me","args",b);return this._func(g,c,l,this._actionData,a)};return e}();c.Process=e;k=function(c){function b(a,b){c.call(this,a);this._name=b;this._type=a.type;this._action=a.action;this._actionData={}}p(b,c);b.prototype.start=function(a){try{this.execute(this._action,
a)}catch(b){d.err("Klang: error in process '"+this._name+"': "+b.name+": "+b.message)}};b.prototype.setData=function(a){this._action=a.action;this._vars=a.vars;this.init();this._func=new Function("Core","Model","Util","me","args",this._action)};return b}(e);c.SimpleProcess=k;e=function(c){function b(a,b){c.call(this,a);this._waitOffset=this._nextStartTime=0;this.SCHEDULE_AHEAD_TIME=.2;this._lastTime=0;this._name=b;this._type=a.type;this._preAction=a.pre_action||null;this._actions=a.actions;this._currentAction=
0;this._started=!1;this._loop=void 0!=a.loop?a.loop:!1;this._loopTime=a.loopTime||-1;this._actionData={process:this};if(this._loop){for(var e=!1,f=0,h=this._actions.length;f<h;f++)if("wait"==this._actions[f].operation){e=!0;break}e||d.warn("Process: Infinite loop found in process '"+this._name+"'")}}p(b,c);b.prototype.start=function(a){if(!d.isIOS)try{this._args=a;this._execTime=this._currentAction=0;this._nextStartTime=this._startTime=d.context.currentTime;if(this._preAction)if("exec"==this._preAction.operation)this.execute(this._preAction.script,
this._args);else if("wait"==this._preAction.operation){this._execTime=this.execute(this._preAction.script,this._args);this._waitOffset+=this._execTime;this._execTime>=this.SCHEDULE_AHEAD_TIME?E.instance.registerMethodCallback(this,"cont",this._execTime-this.SCHEDULE_AHEAD_TIME/2):this.cont();return}this._started=!0;this.cont()}catch(b){d.err("Klang: error in process '"+this._name+"': "+b.name+": "+b.message)}};b.prototype.cont=function(){this._actionData.execTime=this._nextStartTime+this._waitOffset;
for(var a=this._actions.length;this._currentAction<a;this._currentAction++){if(!this._started)return;var b=this._actions[this._currentAction];if("exec"==b.operation)this.execute(b.script,this._args,!0),this._execTime=0;else if("wait"==b.operation){this._execTime=this.execute(b.script,this._args,!0);this._waitOffset+=this._execTime;this._execTime>=this.SCHEDULE_AHEAD_TIME?E.instance.registerMethodCallback(this,"cont",this._execTime-this.SCHEDULE_AHEAD_TIME/2):this._waitOffset>this.SCHEDULE_AHEAD_TIME?
this.scheduleLoop(this._waitOffset):(this._currentAction++,this.cont());this._currentAction++;return}}this._loop&&(0<this._loopTime?this.scheduleLoop(this._loopTime):(this._currentAction=this._waitOffset=0,this.cont()))};b.prototype.scheduleLoop=function(a){if(this._started){this._nextStartTime+=a;var b=this;setTimeout(function(){b._waitOffset=0;b._currentAction=0;b.cont()},1E3*(this._nextStartTime-d.context.currentTime-this.SCHEDULE_AHEAD_TIME/2))}};b.prototype.stop=function(){this._started=!1;E.instance.removeMethodCallback(this,
"cont")};Object.defineProperty(b.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0});b.prototype.setData=function(a){this._actions=a.actions;this._vars=a.vars;this.init()};return b}(e);c.AdvancedProcess=e})(x||(x={}));var l;(function(c){c.setParam=function(c,e,f){c.setValueAtTime(e,f||d.context.currentTime)};c.adjustParam=function(c,e,f){c.setValueAtTime(c.value+e,f||d.context.currentTime)};c.curveParamLin=function(c,e,f,g,l){g=g||d.context.currentTime;var m=
c.value;void 0!=l&&"Firefox"==d.browser&&(m=l);c.setValueAtTime(m,g);c.linearRampToValueAtTime(e,d.context.currentTime+f)};c.curveParamExp=function(h,e,f,g,l){g=g||d.context.currentTime;var m=h.value;void 0!=l&&"Firefox"==d.browser&&(m=l);h.setValueAtTime(0==m?c.EXP_MIN_VALUE:m,g);h.exponentialRampToValueAtTime(e,d.context.currentTime+f)};c.curveParam=function(h,e,f,g){g=g||d.context.currentTime;h.setValueCurveAtTime(c.CUSTOM_CURVES[e],g,f)};c.CUSTOM_CURVES={};c.createCurves=function(h){for(var e in h){var f=
h[e];if(f instanceof Array)for(var g=new Float32Array(f.length),l=0,m=f.length;l<m;l++)g[l]=f[l];else{f.curve_type||d.warn("Modulation: Curve type not specified");f.resolution||(f.resolution=1024);f.amplitude||(f.amplitude=1);f.amplitude_offset||(f.amplitude_offset=0);f.phase_offset||(f.phase_offset=0);f.length||(f.length=1);g=new Float32Array(f.resolution);if("sine"==f.curve_type)for(var n=f.phase_offset*Math.PI*2,p=f.length*Math.PI*2,l=0,m=g.length;l<m;l++)g[l]=f.amplitude_offset+Math.sin(n+l/m*
p)*f.amplitude;else if("saw"==f.curve_type)for(l=0,m=g.length;l<m;l++)g[l]=f.amplitude_offset+(m-l)/m*f.amplitude;else if("inverse-saw"==f.curve_type)for(l=0,m=g.length;l<m;l++)g[l]=f.amplitude_offset+l/m*f.amplitude;else d.warn("Modulation: Unrecognized curve type");c.CUSTOM_CURVES[e]=g}}};if(-1!=navigator.userAgent.indexOf("MSIE")){var l;null!=/MSIE ([0-9]{1,}[.0-9]{0,})/.exec(navigator.userAgent)&&(l=parseInt(RegExp.$1));9>l&&(Object.defineProperty=Object.oldDefineProperty,delete Object.oldDefineProperty)}c.ROOT12=
1.059463094359295;c.NYQUIST_FREQUENCY=22050;c.PITCH_SHIFT_FFT=2048;c.EXP_MIN_VALUE=1E-4;c.OSC_START_DELAY=.005;c.LOG_TIME_COLOR="#999999";c.LOG_EVENT_COLOR="#54CBDD";c.LOG_UNIMPLEMENTED_EVENT_COLOR="#E075A9";c.LOG_LOAD_COLOR="#333333";c.LOG_WARN_COLOR="DarkOrange";c.LOG_ERROR_COLOR="Red";c.lastEvent=void 0;c.vars={};c.random=function(c,d){void 0!=d?d:1;return Math.floor(d+(1+c-d)*Math.random())};c.randomFloat=function(c,d){void 0!=d?d:1;return d+(c-d)*Math.random()};c.ease=function(c,d,f){"undefined"===
typeof f&&(f=3);return c-(c-d)/f};c.now=function(){return d.context.currentTime};c.midiNoteToFrequency=function(c){return 440*Math.pow(2,(c-69)/12)};c.frequencyToMidiNote=function(c){return 69+12*Math.log(c/440)/Math.log(2)};c.safeFilterType=function(c){return void 0==c?"lowpass":c};c.checkMobile=function(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)};c.checkIOS=function(){return/(iPad|iPhone|iPod)/g.test(navigator.userAgent)};c.setBlurFadeOut=
function(c){g.instance.blurFadeOut=c};c.getParameterByName=function(c){c=c.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");c=(new RegExp("[\\?&]"+c+"=([^&#]*)")).exec(location.search);return null==c?"":decodeURIComponent(c[1].replace(/\+/g," "))};c.stopPlayingExcept=function(){for(var c=[],d=0;d<arguments.length-0;d++)c[d]=arguments[d+0];for(var d=[{beat:0,fadeOut:2}],f=c.length-1;0<=f;f--)"Pattern"==g.instance.findInstance(c[f]).type&&d.push(c[f]);var f=g.instance._objectTable,k;for(k in g.instance._objectTable){var l=
f[k];"AudioSource"==l._type&&-1==c.indexOf(k)?l.loop&&l.playing&&l.fadeOutAndStop(1):"Sequencer"==l._type?l.stopAll.apply(l,d):"AdvancedProcess"==l._type&&l.started&&-1==c.indexOf(k)&&l.stop()}};c.shuffle=function(c){for(var d=c.length,f,g;d--;)g=Math.random()*d|0,f=c[d],c[d]=c[g],c[g]=f;return c};c.logFreq=function(c){if(0==c)return 0;var d=20;0==d&&(d=.01);var f=Math.log(d),g=(Math.log(2E4)-f)/(2E4-d);return Math.exp(f+g*(c-d))};c.generateIdString=function(c){for(var d="";d.length<c;)d+="0";return(d+
(Math.random()*Math.pow(36,c)<<0).toString(36)).slice(-c)}})(l||(l={}))})(D||(D={}));return D});